import json
import pandas as pd
from dopolneniya_tables.exstractor_L import get_variant_data

def main():
    # --- ПРИМЕР ИСПОЛЬЗОВАНИЯ ---

    # 1. Укажите путь к файлу и номер варианта
    file_path = '../dopolneniya_tables/dop_L.csv'
    current_variant = 2

    # 2. Получаем данные
    data = get_variant_data(file_path, current_variant)

    # 3. Присваиваем переменным (распаковка)
    stoimost_rmo_nachalo = data['stoimost_rmo_nachalo']
    gruppa_vvod = data['gruppa_vvod'].capitalize()
    gruppa_vyvod = data['gruppa_vyvod'].capitalize()
    procent_vvoda = data['procent_vvoda']
    procent_vyvoda = data['procent_vyvoda']
    mes_vvoda = data['mes_vvoda']
    mes_vyvoda = data['mes_vyvoda']

    print(f"- Стоимость РМО на начало года: {stoimost_rmo_nachalo} тыс. руб.")
    print(f"- Группа вводимых фондов: {gruppa_vvod}")
    print(f"- Группа выводимых фондов: {gruppa_vyvod}")
    print(f"- Процент ввода: {procent_vvoda}%")
    print(f"- Процент вывода: {procent_vyvoda}%")
    print(f"- Месяц ввода: {mes_vvoda}")
    print(f"- Месяц вывода: {mes_vyvoda}")

    # Структура из Дополнения М (%)
    udelnye_vesy = {
        "Здания": 35.6,
        "Сооружения": 6.2,
        "Передаточные устройства": 3.5,
        "Силовые машины": 2.3,
        "Рабочие машины и оборудование": 41.5, # Базовая группа
        "Измерительные приборы и устройства": 3.2,
        "Вычислительная техника": 3.0,
        "Другие машины и оборудование": 0.6,
        "Транспортные средства": 2.1,
        "Другие основные фонды": 2.0,
    }

    # --- 2. Создание таблицы "Исходные данные" ---
    data = {
        'Показатель': [
            'Стоимость рабочих машин и оборудования на начало года, тыс.руб',
            'Группа основных фондов, которые вводятся',
            'Группа основных фондов, которые выбывают',
            'Стоимость основных фондов, которые вводятся, в % к первоначальной стоимости соответствующей группы',
            'Стоимость основных фондов, которые выбывают, в % к первоначальной стоимости соответствующей группы',
            'Месяц введения основных фондов',
            'Месяц выведения основных фондов'
        ],
        'Значение': [
            stoimost_rmo_nachalo,
            gruppa_vvod,
            gruppa_vyvod,
            procent_vvoda,
            procent_vyvoda,
            mes_vvoda,
            mes_vyvoda
        ]
    }
    df_initial_data = pd.DataFrame(data)
    df_initial_data.to_csv('Исходные_данные_основные_фонды.csv', index=False, encoding='utf-8-sig', sep=';')
    print("\nТаблица 'Исходные_данные_основные_фонды.csv' создана.")

    # --- 3. Промежуточные расчёты ---
    print("\n--- ПРОМЕЖУТОЧНЫЕ РАСЧЁТЫ ---")
    print(f"Фi = Фрм * (αi / αрм), где:")
    print(f"- Фрм (стоимость РМО) = {stoimost_rmo_nachalo} тыс. руб.")
    print(f"- αрм (удельный вес РМО) = {udelnye_vesy['Рабочие машины и оборудование']}%")

    stoimost_na_nachalo = {}
    for gruppa, ves in udelnye_vesy.items():
        # Формула (1.8): Фi = Фрм * (αi / αрм)
        stoimost_na_nachalo[gruppa] = stoimost_rmo_nachalo * (ves / udelnye_vesy["Рабочие машины и оборудование"])
        # Используем первые буквы названий групп для обозначения в выводе (как в примере)
        # Обработка названий для обозначения
        parts = gruppa.split()
        if parts[0].lower() in ['здания', 'сооружения', 'транспортные', 'другие']:
            prefix = parts[0][0].lower()
        elif parts[0].lower() == 'передаточные':
            prefix = 'пу'
        elif parts[0].lower() == 'силовые':
            prefix = 'см'
        elif parts[0].lower() == 'рабочие':
            prefix = 'раб'
        elif parts[0].lower() == 'измерительные':
            prefix = 'из'
        elif parts[0].lower() == 'вычислительная':
            prefix = 'вт'
        elif parts[0].lower() == 'другие' and parts[1].lower() == 'машины':
             prefix = 'др'
        else:
            # На случай, если название не попадает под простое правило
            prefix = ''.join([word[0].lower() for word in parts if word not in ['и', 'на', 'в', 'по']])[:2]
        print(f"Ф{prefix} = {stoimost_rmo_nachalo} * {ves}/{udelnye_vesy['Рабочие машины и оборудование']} = {stoimost_na_nachalo[gruppa]:.3f} тыс. руб.")

    # --- Определение стоимости вводимой/выводимой группы ---
    # Проверяем, есть ли указанные группы в словаре udelnye_vesy
    if gruppa_vvod not in udelnye_vesy:
        print(f"Ошибка: Группа для ввода '{gruppa_vvod}' не найдена в структуре фондов (Дополнение М).")
        return
    if gruppa_vyvod not in udelnye_vesy:
        print(f"Ошибка: Группа для вывода '{gruppa_vyvod}' не найдена в структуре фондов (Дополнение М).")
        return

    # Стоимость "вводимой" группы фондов на начало года
    stoimost_vvodimoy_gruppy_nachalo = stoimost_na_nachalo[gruppa_vvod]
    # Стоимость "выводимой" группы фондов на начало года
    stoimost_vyvodimoy_gruppy_nachalo = stoimost_na_nachalo[gruppa_vyvod]

    # Стоимость вводимых фондов (по указанной группе)
    stoimost_vvodimyh = stoimost_vvodimoy_gruppy_nachalo * (procent_vvoda / 100)
    print(f"\nСтоимость {gruppa_vvod.lower()}, введённой в строй:")
    print(f"Фвв = Ф{gruppa_vvod.split()[0][0].lower() if gruppa_vvod.split()[0][0].lower() != 'д' else gruppa_vvod.split()[1][0].lower()} * {procent_vvoda}%")
    print(f"Фвв = {stoimost_vvodimoy_gruppy_nachalo:.3f} * {procent_vvoda}% = {stoimost_vvodimyh:.3f} тыс. руб.")

    # Стоимость выводимых фондов (по указанной группе)
    stoimost_vyvodimyh = stoimost_vyvodimoy_gruppy_nachalo * (procent_vyvoda / 100)
    print(f"\nСтоимость {gruppa_vyvod.lower()}, выведенных из строя:")
    print(f"Фвыв = Ф{gruppa_vyvod.split()[0][0].lower() if gruppa_vyvod.split()[0][0].lower() != 'д' else gruppa_vyvod.split()[1][0].lower()} * {procent_vyvoda}%")
    print(f"Фвыв = {stoimost_vyvodimoy_gruppy_nachalo:.3f} * {procent_vyvoda}% = {stoimost_vyvodimyh:.3f} тыс. руб.")

    # --- 4. Формирование итоговой таблицы ---
    print("\n--- ФОРМИРОВАНИЕ ИТОГОВОЙ ТАБЛИЦЫ ---")
    # Подготовка данных для DataFrame
    rows_data = {}

    # Заполняем основные группы (1, 2, 3, 5, 6)
    rows_data["1.Здания"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Здания"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    rows_data["2.Сооружения"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Сооружения"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    rows_data["3. Передаточные устройства"] = {  # <-- Добавить
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Передаточные устройства"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    # Строка "4. Машины и оборудование" добавляется с нулями
    rows_data["4. Машины и оборудование"] = {  # <-- Добавить
        "Стоимость на начало года, тыс.руб": 0.0,  # Временное значение, будет пересчитано позже
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    # 3. Группа вводимых фондов - ввод
    # Нужно сопоставить группу ввода с её номером в итоговой таблице
    # 'Передаточные устройства' -> '3. Передаточные устройства'
    # 'Здания' -> '1.Здания', 'Сооружения' -> '2.Сооружения', 'Силовые машины' -> '4.1. ...', 'Рабочие машины и оборудование' -> '4.2. ...', 'Транспортные средства' -> '5.Транспортные средства', 'Другие основные фонды' -> '6. Другие основные фонды'
    # Машины и оборудование (4) -> подпункты 4.1 - 4.5
    # Найдем правильный ключ в rows_data для группы ввода
    key_vvod = None
    if gruppa_vvod == "Здания":
        key_vvod = "1.Здания"
    elif gruppa_vvod == "Сооружения":
        key_vvod = "2.Сооружения"
    elif gruppa_vvod == "Передаточные устройства":
        key_vvod = "3. Передаточные устройства"
    elif gruppa_vvod == "Транспортные средства":
        key_vvod = "5.Транспортные средства"
    elif gruppa_vvod == "Другие основные фонды":
        key_vvod = "6. Другие основные фонды"
    elif gruppa_vvod in ["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"]:
        # Для подпунктов машин и оборудования
        if gruppa_vvod == "Силовые машины":
            key_vvod = "4.1. Силовые машины"
        elif gruppa_vvod == "Рабочие машины и оборудование":
            key_vvod = "4.2. Рабочие машины и оборудование"
        elif gruppa_vvod == "Измерительные приборы и устройства":
            key_vvod = "4.3. Измерительные приборы и устройства"
        elif gruppa_vvod == "Вычислительная техника":
            key_vvod = "4.4. Вычислительная техника"
        elif gruppa_vvod == "Другие машины и оборудование":
            key_vvod = "4.5. Другие машины и оборудование"
    else:
        print(f"Ошибка: Не найден ключ для группы ввода '{gruppa_vvod}' в итоговой таблице.")
        return # Прерываем выполнение, если ключ не найден

    if key_vvod:
        rows_data[key_vvod] = {
            "Стоимость на начало года, тыс.руб": stoimost_na_nachalo[gruppa_vvod],
            "Введено в строй, тыс.руб": stoimost_vvodimyh,
            "Выведено из строя, тыс.руб": 0.0
        }
    else:
        print(f"Предупреждение: Ключ для группы ввода '{gruppa_vvod}' не найден.")


    # Подгруппы машин и оборудования (4.1 - 4.5)
    # Заполняем все подгруппы, учитывая возможный ввод/вывод
    # Сначала определим, была ли группа ввода или вывода среди подгрупп 4.x
    is_vvod_in_machines = key_vvod and key_vvod.startswith("4.")
    key_vyvod = None
    if gruppa_vyvod == "Силовые машины":
        key_vyvod = "4.1. Силовые машины"
    elif gruppa_vyvod == "Рабочие машины и оборудование":
        key_vyvod = "4.2. Рабочие машины и оборудование"
    elif gruppa_vyvod == "Измерительные приборы и устройства":
        key_vyvod = "4.3. Измерительные приборы и устройства"
    elif gruppa_vyvod == "Вычислительная техника":
        key_vyvod = "4.4. Вычислительная техника"
    elif gruppa_vyvod == "Другие машины и оборудование":
        key_vyvod = "4.5. Другие машины и оборудование"
    else:
        # Вывод не в подгруппах машин
        pass

    # Заполняем подгруппы машин, учитывая ввод/вывод
    for i, name in enumerate(["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1):
        key = f"4.{i}. {name}"
        # Проверяем, является ли текущая подгруппа вводимой
        if key == key_vvod:
            # Уже заполнено выше
            continue
        # Проверяем, является ли текущая подгруппа выводимой
        if key == key_vyvod:
            # Заполняем с выводом
            rows_data[key] = {
                "Стоимость на начало года, тыс.руб": stoimost_na_nachalo[name],
                "Введено в строй, тыс.руб": 0.0,
                "Выведено из строя, тыс.руб": stoimost_vvodimyh
            }
        else:
            # Обычная подгруппа без изменений
            rows_data[key] = {
                "Стоимость на начало года, тыс.руб": stoimost_na_nachalo[name],
                "Введено в строй, тыс.руб": 0.0,
                "Выведено из строя, тыс.руб": 0.0
            }

    # Если группа вывода не в подгруппах машин, обрабатываем её отдельно
    if not key_vyvod:
        # Проверяем, может быть это одна из основных групп 1, 2, 3, 5, 6
        if gruppa_vyvod == "Здания":
            key_vyvod = "1.Здания"
        elif gruppa_vyvod == "Сооружения":
            key_vyvod = "2.Сооружения"
        elif gruppa_vyvod == "Передаточные устройства":
            key_vyvod = "3. Передаточные устройства"
        elif gruppa_vyvod == "Транспортные средства":
            key_vyvod = "5.Транспортные средства"
        elif gruppa_vyvod == "Другие основные фонды":
            key_vyvod = "6. Другие основные фонды"
        else:
            print(f"Ошибка: Не найден ключ для группы вывода '{gruppa_vyvod}' в итоговой таблице.")
            return # Прерываем выполнение, если ключ не найден

        if key_vyvod:
            # Обновляем существующую запись для группы вывода
            rows_data[key_vyvod]["Выведено из строя, тыс.руб"] = stoimost_vyvodimyh
        else:
            print(f"Предупреждение: Ключ для группы вывода '{gruppa_vyvod}' не найден.")

    # Рассчитываем строку "4. Машины и оборудование" как сумму подгрупп (4.1 - 4.5)
    # machines_nachalo = sum(
    #     rows_data[f"4.{i}. {name}"]["Стоимость на начало года, тыс.руб"] for i, name in enumerate(["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1)
    # )
    # machines_vvod = sum(
    #     rows_data[f"4.{i}. {name}"]["Введено в строй, тыс.руб"] for i, name in enumerate(["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1)
    # )
    # machines_vyvod = sum(
    #     rows_data[f"4.{i}. {name}"]["Выведено из строя, тыс.руб"] for i, name in enumerate(["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1)
    # )
    machines_nachalo = sum(
        rows_data[f"4.{i}. {name}"]["Стоимость на начало года, тыс.руб"] for i, name in enumerate(
            ["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства",
             "Вычислительная техника", "Другие машины и оборудование"], 1)
    )
    machines_vvod = sum(
        rows_data[f"4.{i}. {name}"]["Введено в строй, тыс.руб"] for i, name in enumerate(
            ["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства",
             "Вычислительная техника", "Другие машины и оборудование"], 1)
    )
    machines_vyvod = sum(
        rows_data[f"4.{i}. {name}"]["Выведено из строя, тыс.руб"] for i, name in enumerate(
            ["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства",
             "Вычислительная техника", "Другие машины и оборудование"], 1)
    )
    # Обновляем значения в существующем ключе
    rows_data["4. Машины и оборудование"]["Стоимость на начало года, тыс.руб"] = machines_nachalo
    rows_data["4. Машины и оборудование"]["Введено в строй, тыс.руб"] = machines_vvod
    rows_data["4. Машины и оборудование"]["Выведено из строя, тыс.руб"] = machines_vyvod

    # 5. Транспортные средства
    if "5.Транспортные средства" not in rows_data:  # Проверяем, не была ли она вводимой/выводимой
        rows_data["5.Транспортные средства"] = {
            "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Транспортные средства"],
            "Введено в строй, тыс.руб": 0.0,
            "Выведено из строя, тыс.руб": 0.0
        }
    # 6. Другие основные фонды
    if "6. Другие основные фонды" not in rows_data:  # Проверяем, не была ли она вводимой/выводимой
        rows_data["6. Другие основные фонды"] = {
            "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Другие основные фонды"],
            "Введено в строй, тыс.руб": 0.0,
            "Выведено из строя, тыс.руб": 0.0
        }

    # Создаем DataFrame
    df_final = pd.DataFrame.from_dict(rows_data, orient='index')
    df_final = df_final.reset_index()
    df_final.rename(columns={'index': 'Группа основных фондов'}, inplace=True)

    # Рассчитываем столбец "Стоимость на конец года"
    df_final["Стоимость на конец года, тыс.руб"] = df_final["Стоимость на начало года, тыс.руб"] + df_final["Введено в строй, тыс.руб"] - df_final["Выведено из строя, тыс.руб"]

    # Переставляем столбцы в нужном порядке
    df_final = df_final[['Группа основных фондов', 'Стоимость на начало года, тыс.руб', 'Введено в строй, тыс.руб', 'Выведено из строя, тыс.руб', 'Стоимость на конец года, тыс.руб']]

    machines_end = df_final.loc[
    df_final['Группа основных фондов'] == '4. Машины и оборудование',
    'Стоимость на конец года, тыс.руб'
].values[0]


    # Рассчитываем итоговые суммы
    total_nachalo = df_final['Стоимость на начало года, тыс.руб'].sum() - machines_nachalo
    total_vvod = df_final['Введено в строй, тыс.руб'].sum()
    total_vyvod = df_final['Выведено из строя, тыс.руб'].sum()
    total_konec = df_final['Стоимость на конец года, тыс.руб'].sum() - machines_end

    # Добавляем строку ИТОГО
    df_itog = pd.DataFrame([{
        "Группа основных фондов": "ИТОГО",
        "Стоимость на начало года, тыс.руб": total_nachalo,
        "Введено в строй, тыс.руб": total_vvod,
        "Выведено из строя, тыс.руб": total_vyvod,
        "Стоимость на конец года, тыс.руб": total_konec
    }])

    df_final = pd.concat([df_final, df_itog], ignore_index=True)


    # Сохраняем в CSV
    df_final.to_csv(
        'Основные_производственные_фонды_предприятия.csv',
                    index=False,
                    encoding='utf-8-sig',
                    sep=';',
                    float_format='%.3f'
            )
    print("Таблица 'Основные_производственные_фонды_предприятия.csv' создана.")
    print(df_final.round(3))

    # --- 5. Расчёт среднегодовой стоимости ---
    print("\n--- РАСЧЁТ СРЕДНЕГОДОВОЙ СТОИМОСТИ ---")
    F_n = total_nachalo
    F_vv = stoimost_vvodimyh
    F_vyv = stoimost_vyvodimyh
    t_vvoda = 12 - mes_vvoda
    t_vyvoda = 12 - mes_vyvoda

    print(f"Формула (1.9): Фср.г = Фн + (Фвв * tвв) / 12 - (Фвыв * tвыв) / 12")
    print(f"Где:")
    print(f"- Фн (стоимость на начало года) = {F_n:.3f} тыс. руб.")
    print(f"- Фвв (стоимость вводимых фондов) = {F_vv:.3f} тыс. руб.")
    print(f"- Фвыв (стоимость выводимых фондов) = {F_vyv:.3f} тыс. руб.")
    print(f"- tвв (месяцы функционирования вводимых фондов) = 12 - {mes_vvoda} = {t_vvoda}")
    print(f"- tвыв (месяцы после вывода) = 12 - {mes_vyvoda} = {t_vyvoda}")

    F_sr_g = F_n + (F_vv * t_vvoda) / 12 - (F_vyv * t_vyvoda) / 12
    print(f"Расчёт: {F_n:.3f} + ({F_vv:.3f} * {t_vvoda}) / 12 - ({F_vyv:.3f} * {t_vyvoda}) / 12 = {F_sr_g:.3f} тыс. руб.")
    print(f"\nСреднегодовая стоимость основных фондов: {F_sr_g:.3f} тыс. руб.")

    print("\n--- КОНЕЦ РАСЧЁТОВ ---")

    fssof = {'Среднегодовая стоимость основных фондов': F_sr_g}
    with open('фссоф.json', 'w', encoding='utf-8') as f:
        json.dump(fssof, f, indent=4, ensure_ascii=False)


if __name__ == "__main__":
    main()
