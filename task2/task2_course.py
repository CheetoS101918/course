import json

import pandas as pd

def main():
    """
    Основная функция для выполнения расчётов по основным фондам.
    """
    print("--- НАЧАЛО РАСЧЁТОВ ПО ОСНОВНЫМ ФОНДАМ ---")

    # --- 1. Извлечение исходных данных ---

    # Стоимость РМО на начало года
    stoimost_rmo_nachalo = 19800
    # Группа вводимых фондов
    gruppa_vvod = 'Cооружения'
    # Группа выводимых фондов
    gruppa_vyvod = 'Здания'
    # Размер вводимых фондов (%)
    procent_vvoda = 2.6
    # Размер выводимых фондов (%)
    procent_vyvoda = 3
    # Месяц ввода
    mes_vvoda = 3
    # Месяц вывода
    mes_vyvoda = 6

    print(f"- Стоимость РМО на начало года: {stoimost_rmo_nachalo} тыс. руб.")
    print(f"- Группа вводимых фондов: {gruppa_vvod}")
    print(f"- Группа выводимых фондов: {gruppa_vyvod}")
    print(f"- Процент ввода: {procent_vvoda}%")
    print(f"- Процент вывода: {procent_vyvoda}%")
    print(f"- Месяц ввода: {mes_vvoda}")
    print(f"- Месяц вывода: {mes_vyvoda}")

    # Структура из Дополнения М (%)
    udelnye_vesy = {
        "Здания": 35.6,
        "Сооружения": 6.2,
        "Передаточные устройства": 3.5,
        "Машины и оборудование": 50.6,
        "Силовые машины и оборудование": 2.3,
        "Рабочие машины и оборудование": 41.5, # Базовая группа
        "Измерительные приборы и устройства": 3.2,
        "Вычислительная техника": 3.0,
        "Другие машины и оборудование": 0.6,
        "Транспортные средства": 2.1,
        "Другие основные фонды": 2,
    }

    # --- 2. Создание таблицы "Исходные данные" ---
    data = {
        '№':
        [str(i) for i in range(1, 8)],
        'Показатель': [
            'Стоимость рабочих машин и оборудования на начало года, тыс.руб',
            'Группа основных фондов, которые вводятся',
            'Группа основных фондов, которые выбывают',
            'Стоимость основных фондов, которые вводятся, в % к первоначальной стоимости соответствующей группы',
            'Стоимость основных фондов, которые выбывают, в % к первоначальной стоимости соответствующей группы',
            'Месяц введения основных фондов',
            'Месяц выведения основных фондов'
        ],
        'Значение': [
            stoimost_rmo_nachalo,
            gruppa_vvod,
            gruppa_vyvod,
            procent_vvoda,
            procent_vyvoda,
            mes_vvoda,
            mes_vyvoda
        ]
    }
    df_initial_data = pd.DataFrame(data)
    df_initial_data.to_csv('Исходные_данные_основные_фонды.csv', index=False, encoding='utf-8-sig', sep=';')
    print("\nТаблица 'Исходные_данные_основные_фонды.csv' создана.")

    # --- 3. Промежуточные расчёты ---
    print("\n--- ПРОМЕЖУТОЧНЫЕ РАСЧЁТЫ ---")
    print(f"Фi = Фрм * (αi / αрм), где:")

    stoimost_na_nachalo = {}
    for gruppa, ves in udelnye_vesy.items():
        # Формула (1.8): Фi = Фрм * (αi / αрм)
        stoimost_na_nachalo[gruppa] = stoimost_rmo_nachalo * (ves / udelnye_vesy["Рабочие машины и оборудование"])
        print(f"Ф{gruppa.split()[0][0].lower() if gruppa.split()[0][0].lower() != 'д' else gruppa.split()[1][0].lower()} = {stoimost_rmo_nachalo} * {ves}/{udelnye_vesy['Рабочие машины и оборудование']} = {stoimost_na_nachalo[gruppa]:.3f} тыс. руб.")

    # Стоимость "Передаточные устройства" на начало года
    stoimost_pered_ustroystva_nachalo = stoimost_na_nachalo["Передаточные устройства"]
    # Стоимость "Силовые машины и оборудование" на начало года
    stoimost_sil_mashin_nachalo = stoimost_na_nachalo["Силовые машины и оборудование"]

    # Стоимость вводимых фондов (Передаточные устройства)
    stoimost_vvodimyh = stoimost_pered_ustroystva_nachalo * (procent_vvoda / 100)
    print(f"\nСтоимость {gruppa_vvod}, введённого в строй:")
    print(f"Фвв = Фпер * {procent_vvoda}%")
    print(f"Фвв = {stoimost_pered_ustroystva_nachalo:.3f} * {procent_vvoda}% = {stoimost_vvodimyh:.3f} тыс. руб.")

    # Стоимость выводимых фондов (Силовые машины)
    stoimost_vyvodimyh = stoimost_sil_mashin_nachalo * (procent_vyvoda / 100)
    print(f"\nСтоимость {gruppa_vyvod}, выведенных из строя:")
    print(f"Фвыв = Фсм * {procent_vyvoda}%")
    print(f"Фвыв = {stoimost_sil_mashin_nachalo:.3f} * {procent_vyvoda}% = {stoimost_vyvodimyh:.3f} тыс. руб.")

    # --- 4. Формирование итоговой таблицы ---
    print("\n--- ФОРМИРОВАНИЕ ИТОГОВОЙ ТАБЛИЦЫ ---")
    # Подготовка данных для DataFrame
    rows_data = {}

    # Заполняем основные группы (1, 2, 3, 5, 6)
    rows_data["1.Здания"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Здания"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    rows_data["2.Сооружения"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Сооружения"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    # 3. Передаточные устройства - ввод
    rows_data["3. Передаточные устройства"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Передаточные устройства"],
        "Введено в строй, тыс.руб": stoimost_vvodimyh,
        "Выведено из строя, тыс.руб": 0.0
    }

    rows_data["4. Машины и оборудование"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Силовые машины и оборудование"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": stoimost_vyvodimyh
    }

    # Подгруппы машин и оборудования (4.1 - 4.5)
    rows_data["4.1. Силовые машины и оборудование"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Силовые машины и оборудование"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": stoimost_vyvodimyh
    }
    rows_data["4.2. Рабочие машины и оборудование"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Рабочие машины и оборудование"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    rows_data["4.3. Измерительные приборы и устройства"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Измерительные приборы и устройства"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    rows_data["4.4. Вычислительная техника"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Вычислительная техника"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    rows_data["4.5. Другие машины и оборудование"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Другие машины и оборудование"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }

    # 5. Транспортные средства
    rows_data["5.Транспортные средства"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Транспортные средства"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    # 6. Другие основные фонды
    rows_data["6. Другие основные фонды"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Другие основные фонды"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }

    # Рассчитываем строку "4. Машины и оборудование" как сумму подгрупп (4.1 - 4.5)
    machines_nachalo = sum(
        rows_data[f"4.{i}. {name}"]["Стоимость на начало года, тыс.руб"] for i, name in enumerate(["Силовые машины и оборудование", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1)
    )
    machines_vvod = sum(
        rows_data[f"4.{i}. {name}"]["Введено в строй, тыс.руб"] for i, name in enumerate(["Силовые машины и оборудование", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1)
    )
    machines_vyvod = sum(
        rows_data[f"4.{i}. {name}"]["Выведено из строя, тыс.руб"] for i, name in enumerate(["Силовые машины и оборудование", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1)
    )
    # rows_data["4. Машины и оборудование"] = {
    #     "Стоимость на начало года, тыс.руб": machines_nachalo,
    #     "Введено в строй, тыс.руб": machines_vvod,
    #     "Выведено из строя, тыс.руб": machines_vyvod
    # }

    # Создаем DataFrame
    df_final = pd.DataFrame.from_dict(rows_data, orient='index')
    df_final = df_final.reset_index()
    df_final.rename(columns={'index': 'Группа основных фондов'}, inplace=True)

    # Рассчитываем столбец "Стоимость на конец года"
    df_final["Стоимость на конец года, тыс.руб"] = df_final["Стоимость на начало года, тыс.руб"] + df_final["Введено в строй, тыс.руб"] - df_final["Выведено из строя, тыс.руб"]

    # Переставляем столбцы в нужном порядке
    df_final = df_final[['Группа основных фондов', 'Стоимость на начало года, тыс.руб', 'Введено в строй, тыс.руб', 'Выведено из строя, тыс.руб', 'Стоимость на конец года, тыс.руб']]

    # Рассчитываем итоговые суммы
    total_nachalo = df_final['Стоимость на начало года, тыс.руб'].sum()
    total_vvod = df_final['Введено в строй, тыс.руб'].sum()
    total_vyvod = df_final['Выведено из строя, тыс.руб'].sum()
    total_konec = df_final['Стоимость на конец года, тыс.руб'].sum()

    # Добавляем строку ИТОГО
    df_itog = pd.DataFrame([{
        "Группа основных фондов": "ИТОГО",
        "Стоимость на начало года, тыс.руб": total_nachalo,
        "Введено в строй, тыс.руб": total_vvod,
        "Выведено из строя, тыс.руб": total_vyvod,
        "Стоимость на конец года, тыс.руб": total_konec
    }])

    df_final = pd.concat([df_final, df_itog], ignore_index=True)

    # Сохраняем в CSV
    df_final.to_csv('Основные_производственные_фонды_предприятия.csv', index=False, encoding='utf-8-sig', sep=';')
    print("Таблица 'Основные_производственные_фонды_предприятия.csv' создана.")
    print("\nИтоговая таблица:")
    print(df_final.round(3)) # Округляем для отображения

    # --- 5. Расчёт среднегодовой стоимости ---
    print("\n--- РАСЧЁТ СРЕДНЕГОДОВОЙ СТОИМОСТИ ---")
    F_n = total_nachalo
    F_vv = stoimost_vvodimyh
    F_vyv = stoimost_vyvodimyh
    t_vvoda = 12 - mes_vvoda + 1 # 7
    t_vyvoda = 12 - mes_vyvoda + 1 # 3

    print(f"Формула (1.9): Фср.г = Фн + (Фвв * tвв) / 12 - (Фвыв * tвыв) / 12")
    print(f"Где:")
    print(f"- Фн (стоимость на начало года) = {F_n:.3f} тыс. руб.")
    print(f"- Фвв (стоимость вводимых фондов) = {F_vv:.3f} тыс. руб.")
    print(f"- Фвыв (стоимость выводимых фондов) = {F_vyv:.3f} тыс. руб.")
    print(f"- tвв (месяцы функционирования вводимых фондов) = 12 - {mes_vvoda} + 1 = {t_vvoda}")
    print(f"- tвыв (месяцы после вывода) = 12 - {mes_vyvoda} + 1 = {t_vyvoda}")

    F_sr_g = F_n + (F_vv * t_vvoda) / 12 - (F_vyv * t_vyvoda) / 12
    print(f"Расчёт: {F_n:.3f} + ({F_vv:.3f} * {t_vvoda}) / 12 - ({F_vyv:.3f} * {t_vyvoda}) / 12 = {F_sr_g:.3f} тыс. руб.")
    print(f"\nСреднегодовая стоимость основных фондов: {F_sr_g:.3f} тыс. руб.")

    print("\n--- КОНЕЦ РАСЧЁТОВ ---")

    fssof = {'Среднегодовая стоимость основных фондов': F_sr_g}
    with open('фссоф.json', 'w', encoding='utf-8') as f:
        json.dump(fssof, f, indent=4, ensure_ascii=False)


if __name__ == "__main__":
    main()
