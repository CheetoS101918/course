=== STRUCTURE ===
./
    .gitignore
    csv_to_docx.py
    project_context.txt
    requirements.txt
    dopolneniya_tables/
        dop_B.csv
        dop_J_grades.csv
        dop_J_hours.csv
        dop_L.csv
        dop_N.csv
        dop_N_corrected.csv
        dop_P.csv
        dop_R.csv
        dop_T.csv
        dop_V.csv
        exstractor_B.py
        exstractor_J.py
        exstractor_L.py
        exstractor_V.py
    pract_part/
        task_21.py
        проверка_расчетов.csv
        таблица_2_3_данные_для_расчета.csv
        таблица_2_4_себестоимость.csv
    task1/
        funcs.py
        individual_product_volumes.json
        input_data_table.csv
        input_data_table.json
        input_data_table_table.docx
        sebestoimost_structure.csv
        sebestoimost_structure.json
        sebestoimost_structure_table.docx
        test.py
    task2/
        ren.py
        task2_course.py
        Исходные_данные_основные_фонды.csv
        Исходные_данные_основные_фонды_table.docx
        Основные_производственные_фонды_предприятия.csv
        Основные_производственные_фонды_предприятия_table.docx
        фссоф.json
    task3/
        task3.py
        Таблица_1_Исходные_данные_норматив_оборотных_средств.csv
        Таблица_1_Исходные_данные_норматив_оборотных_средств_table.docx
        Таблица_2_Сводный_расчет_норматива_оборотных_средств.csv
        Таблица_2_Сводный_расчет_норматива_оборотных_средств_table.docx
    task4/
        task4.py
        Таблица_2_7_Показатели_деятельности_предприятия.csv
        Таблица_2_7_Показатели_деятельности_предприятия_table.docx
    task5/
        funcs.py
        table10.csv
        table10_table.docx
        table11.csv
        table11_table.docx
        table12.csv
        table12_table.docx
        table9.csv
        table9_table.docx
        task5.py
        Структура_основных_производственных_фондов_%.csv
        Структура_основных_производственных_фондов_%_table.docx

=== FILE CONTENTS ===


====================
FILE: .\csv_to_docx.py
====================
import pandas as pd
from docx import Document
from docx.shared import Inches, Pt
from docx.enum.style import WD_STYLE_TYPE
import sys
import numpy as np


def create_custom_style(doc):
    """Создает изолированный стиль для таблицы без отступов"""
    styles = doc.styles
    # Создаем новый стиль абзаца
    style_name = 'CsvTableText'

    try:
        custom_style = styles.add_style(style_name, WD_STYLE_TYPE.PARAGRAPH)
        custom_style.base_style = styles['Normal']
    except:
        custom_style = styles[style_name]  # Если вдруг уже есть

    # Настраиваем стиль жестко
    p_fmt = custom_style.paragraph_format
    p_fmt.first_line_indent = Pt(0)
    p_fmt.left_indent = Pt(0)
    p_fmt.space_before = Pt(0)
    p_fmt.space_after = Pt(0)

    # Можно добавить шрифт, чтобы он тоже не слетал
    font = custom_style.font
    font.name = 'Times New Roman'  # Или какой вам нужен
    font.size = Pt(14)

    return style_name


def simple_clean_zeros(df):
    """Превращает целые float-ы (5.0, 10.0 и т.д.) в int, остальное оставляет как есть"""
    def format_number(x):
        if pd.isna(x):
            return x
        try:
            num = float(x)
            # Если число целое — возвращаем int, иначе оставляем float
            return int(num) if num.is_integer() else num
        except (ValueError, TypeError, OverflowError):
            return x
    return df.map(format_number)


def value_to_string(val):
    """Надёжно убирает .0 у целых чисел, даже если они пришли как float"""
    if pd.isna(val):
        return ""
    if isinstance(val, float):
        if val.is_integer():
            return str(int(val))
        return str(val).rstrip('0').rstrip('.')  # убирает лишние нули и точку у 10.50 → 10.5
    return str(val)


def create_docx_from_csv(csv_file, output_file=None):
    """
    Создаёт DOCX-документ с таблицей из CSV-файла.

    Args:
        csv_file (str): Путь к CSV-файлу (с разделителем ';').
        output_file (str, optional): Путь к выходному DOCX. Если None,
                                     генерирует имя на основе CSV.

    Returns:
        str: Путь к сохранённому файлу.
    """
    # Шаг 1: Читаем CSV
    df = pd.read_csv(csv_file, sep=';')

    # Шаг 2: Генерируем имя выходного файла, если не указано
    if output_file is None:
        output_file = csv_file.replace('.csv', '_table.docx')

    # Шаг 3: Создаём DOCX
    doc = Document()

    table_style_name = create_custom_style(doc)

    # Шаг 4: Добавляем таблицу
    table = doc.add_table(rows=len(df) + 1, cols=len(df.columns))
    table.style = 'Table Grid'  # Рамки

    # Шаг 5: Заполняем заголовки
    for j, column in enumerate(df.columns):
        cell = table.cell(0, j)
        cell.text = str(column)
        # !!! 2. Применяем стиль
        cell.paragraphs[0].style = doc.styles[table_style_name]
        cell.paragraphs[0].runs[0].bold = True

    # Шаг 6: Заполняем данные (NaN -> пустая ячейка)
    for i, row in df.iterrows():
        for j, value in enumerate(row):
            cell = table.cell(i + 1, j)
            clean_value = str(value).strip() if pd.notna(value) else ""
            cell.text = clean_value
            # !!! 2. Применяем стиль к каждой ячейке
            cell.text = value_to_string(value)
            cell.paragraphs[0].style = doc.styles[table_style_name]

    # Шаг 7: Настраиваем ширину столбцов
    table.columns[0].width = Inches(2.5)  # Шире для названий
    for j in range(1, len(table.columns)):
        table.columns[j].width = Inches(1.2)

    # Шаг 8: Сохраняем
    doc.save(output_file)
    print(f"Таблица сохранена в {output_file}")
    return output_file


if __name__ == "__main__":
    # Парсим аргументы из командной строки
    if len(sys.argv) != 2:
        print("Использование: python csv_to_docx.py <путь_к_csv_файлу>")
        print("Пример: python csv_to_docx.py sebestoimost_structure.csv")
        sys.exit(1)

    csv_file = sys.argv[1]
    create_docx_from_csv(csv_file)

====================
FILE: .\project_context.txt
====================


====================
FILE: .\requirements.txt
====================
Error reading file: 'utf-8' codec can't decode byte 0xff in position 0: invalid start byte

====================
FILE: .\dopolneniya_tables\exstractor_B.py
====================
import pandas as pd
from pprint import pprint  # Импортируем для красивой печати


def extract_materials_data(variant: int, pretty_print: bool = True):
    """
    Извлекает данные материалов для указанного варианта из CSV файла 'доп Б.csv'.

    Args:
        variant (int): Номер варианта (1-10).
        pretty_print (bool): Если True, печатает данные красиво. Если False, возвращает словари.

    Returns:
        tuple: Кортеж из двух словарей - materials_main и materials_purchased (если pretty_print=False).
    """
    # Читаем CSV файл
    df = pd.read_csv('dop_B.csv')

    # Фильтруем по варианту
    variant_df = df[df['Вариант'] == variant]

    # Проверяем наличие данных
    if len(variant_df) != 2:
        raise ValueError(f"Для варианта {variant} не найдено ровно 2 записи (А и Б).")

    # Извлекаем данные для А и Б
    row_a = variant_df[variant_df['Изделие'] == 'А'].iloc[0]
    row_b = variant_df[variant_df['Изделие'] == 'Б'].iloc[0]

    # Основные материалы
    materials_main = {
        "стальной прокат": {
            "type": "material",
            "A": {
                "rasxod": row_a['Стальной_прокат_кг'] / 1000,
                "otxod": (row_a['Стальной_прокат_%'] / 100) * (row_a['Стальной_прокат_кг'] / 1000)
            },
            "B": {
                "rasxod": row_b['Стальной_прокат_кг'] / 1000,
                "otxod": (row_b['Стальной_прокат_%'] / 100) * (row_b['Стальной_прокат_кг'] / 1000)
            }
        },
        "трубы стальные": {
            "type": "material",
            "A": {
                "rasxod": row_a['Трубы_стальные_кг'] / 1000,
                "otxod": (row_a['Трубы_стальные_%'] / 100) * (row_a['Трубы_стальные_кг'] / 1000)
            },
            "B": {
                "rasxod": row_b['Трубы_стальные_кг'] / 1000,
                "otxod": (row_b['Трубы_стальные_%'] / 100) * (row_b['Трубы_стальные_кг'] / 1000)
            }
        },
        "прокат цветных металлов": {
            "type": "fixed",
            "A": row_a['Прокат_цветных_руб'],
            "B": row_b['Прокат_цветных_руб']
        },
        "другие материалы": {
            "type": "fixed",
            "A": row_a['Другие_материалы_руб'],
            "B": row_b['Другие_материалы_руб']
        }
    }

    # Покупные полуфабрикаты
    materials_purchased = {
        "отливки черных металлов": {
            "type": "material",
            "A": {
                "rasxod": row_a['Отливки_черных_кг'] / 1000,
                "otxod": (row_a['Отливки_черных_%'] / 100) * (row_a['Отливки_черных_кг'] / 1000)
            },
            "B": {
                "rasxod": row_b['Отливки_черных_кг'] / 1000,
                "otxod": (row_b['Отливки_черных_%'] / 100) * (row_b['Отливки_черных_кг'] / 1000)
            }
        },
        "отливки цветных металлов": {
            "type": "material",
            "A": {
                "rasxod": row_a['Отливки_цветных_кг'] / 1000,
                "otxod": (row_a['Отливки_цветных_%'] / 100) * (row_a['Отливки_цветных_кг'] / 1000)
            },
            "B": {
                "rasxod": row_b['Отливки_цветных_кг'] / 1000,
                "otxod": (row_b['Отливки_цветных_%'] / 100) * (row_b['Отливки_цветных_кг'] / 1000)
            }
        }
    }

    if pretty_print:
        print(f"Данные для варианта {variant}:")
        print("\nОсновные материалы:")
        pprint(materials_main, indent=2, sort_dicts=False)
        print("\nПокупные полуфабрикаты:")
        pprint(materials_purchased, indent=2, sort_dicts=False)
        return None  # Не возвращаем, если печатаем
    else:
        return materials_main, materials_purchased


# Пример использования с красивой печатью (по умолчанию):
extract_materials_data(2)

# Если хочешь просто вернуть словари (без печати):
# materials_main, materials_purchased = extract_materials_data(2, pretty_print=False)

====================
FILE: .\dopolneniya_tables\exstractor_J.py
====================
import pandas as pd
from pprint import pprint

# Словарь разрядов -> ставки
GRADE_TO_RATE = {3: 30.25, 4: 35.60, 5: 41.50}


def extract_labor_data(variant: int, pretty_print: bool = True):
    """
    Извлекает данные о трудоёмкости и ставках для указанного варианта из CSV файлов 'доп Ж_hours.csv' и 'доп Ж_grades.csv'.

    Args:
        variant (int): Номер варианта (1-10).
        k_zh (float): Коэффициент Кж (по умолчанию 1.0).
        pretty_print (bool): Если True, печатает данные красиво. Если False, возвращает словарь.

    Returns:
        dict: Словарь как в примере (если pretty_print=False).
    """
    # Читаем CSV для часов
    df_hours = pd.read_csv('dop_J_hours.csv')
    # Читаем CSV для разрядов
    df_grades = pd.read_csv('dop_J_grades.csv')

    # Проверяем наличие столбца для варианта
    variant_col = str(variant)
    if variant_col not in df_hours.columns or variant_col not in df_grades.columns:
        raise ValueError(f"Вариант {variant} не найден в данных.")

    # Суммируем часы по всем видам работ для А и Б
    sum_a_hours = df_hours[df_hours['Изделие'] == 'А'][variant_col].sum()
    sum_b_hours = df_hours[df_hours['Изделие'] == 'Б'][variant_col].sum()

    # Получаем разряды
    grade_a = df_grades[df_grades['Изделие'] == 'А'][variant_col].iloc[0]
    grade_b = df_grades[df_grades['Изделие'] == 'Б'][variant_col].iloc[0]

    # Мапим на ставки
    rate_a = GRADE_TO_RATE.get(int(grade_a), 0)
    rate_b = GRADE_TO_RATE.get(int(grade_b), 0)

    result = {
        "labor_hours": {"A": sum_a_hours, "B": sum_b_hours},
        "hourly_rate": {"A": rate_a, "B": rate_b}
    }

    if pretty_print:
        print(f"Данные о трудоёмкости и ставках для варианта {variant}:")
        pprint(result, indent=2, sort_dicts=False)
        return None
    else:
        return result


# Пример использования с красивой печатью (по умолчанию):
extract_labor_data(1)

# С Кж=1.2, например:
# extract_labor_data(1, k_zh=1.2)

# Просто вернуть словарь:
# labor_data = extract_labor_data(1, pretty_print=False)

====================
FILE: .\dopolneniya_tables\exstractor_L.py
====================
import pandas as pd


def get_variant_data(file_path, variant_number):
    """
    Считывает данные из CSV для указанного варианта.
    """
    # Считываем CSV, указывая разделитель "точка с запятой"
    try:
        df = pd.read_csv(file_path, sep=';')
    except FileNotFoundError:
        return "Файл не найден. Проверьте путь."

    # Формируем имя колонки (например, "Вариант 2")
    col_name = f'Вариант {variant_number}'

    # Проверяем, есть ли такой вариант в таблице
    if col_name not in df.columns:
        return f"Вариант {variant_number} не найден в таблице."

    # Извлекаем данные по строкам (индексация начинается с 0)
    # Строка 0: Стоимость (преобразуем в целое число)
    stoimost_rmo_nachalo = int(df[col_name].iloc[0])

    # Строка 1: Группа ввода (строка)
    gruppa_vvod = str(df[col_name].iloc[1]).strip()

    # Строка 2: Группа вывода (строка)
    gruppa_vyvod = str(df[col_name].iloc[2]).strip()

    # Строка 3: Процент ввода (заменяем запятую на точку для float)
    procent_vvoda = float(str(df[col_name].iloc[3]).replace(',', '.'))

    # Строка 4: Процент вывода (заменяем запятую на точку для float)
    procent_vyvoda = float(str(df[col_name].iloc[4]).replace(',', '.'))

    # Строка 5: Месяц ввода (целое число)
    mes_vvoda = int(df[col_name].iloc[5])

    # Строка 6: Месяц вывода (целое число)
    mes_vyvoda = int(df[col_name].iloc[6])

    # Возвращаем словарь для удобства
    return {
        'stoimost_rmo_nachalo': stoimost_rmo_nachalo,
        'gruppa_vvod': gruppa_vvod,
        'gruppa_vyvod': gruppa_vyvod,
        'procent_vvoda': procent_vvoda,
        'procent_vyvoda': procent_vyvoda,
        'mes_vvoda': mes_vvoda,
        'mes_vyvoda': mes_vyvoda
    }

====================
FILE: .\dopolneniya_tables\exstractor_V.py
====================
import pandas as pd
from pprint import pprint  # Для красивой печати, если нужно


def extract_purchased_sums(variant: int, pretty_print: bool = True):
    """
    Извлекает суммы стоимостей покупных комплектующих изделий для указанного варианта из CSV файла 'доп В.csv'.

    Args:
        variant (int): Номер варианта (1-10).
        pretty_print (bool): Если True, печатает данные красиво. Если False, возвращает словарь.

    Returns:
        dict: Словарь {"A": sum_A, "B": sum_B} (если pretty_print=False).
    """
    # Читаем CSV файл
    df = pd.read_csv('dop_V.csv')

    # Проверяем наличие столбца для варианта
    variant_col = str(variant)
    if variant_col not in df.columns:
        raise ValueError(f"Вариант {variant} не найден в данных.")

    # Суммируем по изделию
    sum_a = df[df['Изделие'] == 'А'][variant_col].sum()
    sum_b = df[df['Изделие'] == 'Б'][variant_col].sum()

    result = {"A": sum_a, "B": sum_b}

    if pretty_print:
        print(f"Суммы стоимостей покупных комплектующих для варианта {variant}:")
        pprint(result, indent=2, sort_dicts=False)
        return None  # Не возвращаем, если печатаем
    else:
        return result


# Пример использования с красивой печатью (по умолчанию):
extract_purchased_sums(1)

# Если хочешь просто вернуть словарь (без печати):
# sums_data = extract_purchased_sums(1, pretty_print=False)
# print(sums_data)  # {'A': 139000, 'B': 39800}

====================
FILE: .\pract_part\task_21.py
====================
"""
Курсовая работа по экономике предприятия - расчет проектной части
Этап 1: Расчет себестоимости продукции
"""

import csv
import math
from typing import Dict, List, Tuple, Any
import os

class CostCalculator:
    """Класс для расчета себестоимости продукции"""

    def __init__(self):
        # Инициализация всех данных из примера студента
        self.load_student_example_data()

    def load_student_example_data(self):
        """Загрузка точных данных из примера студента (вариант 3)"""

        # Коэффициенты из примера
        self.Ka = 1.04  # коэффициент для объема производства
        self.Ktr = 1.15  # транспортно-заготовительные расходы

        # Данные по проектам из таблицы 2.1 примера (Исходные данные для экономического обоснования варианта проекта)
        self.projects_data = {
            "project_1": {
                "name": "Проект 1",
                "annual_volume_base": 330,  # шт - Годовой объем производства (строка 1 таблицы 2.1)
                "annual_volume_corrected": round(330 * self.Ka),
                # Q(A) = 330 * 1.04 = 344 шт - скорректированный объем с коэффициентом Ка
                # Снижение норм расходов (%) - раздел "К расчету себестоимости продукции" таблицы 2.1
                "steel_rolling_reduction": 7,  # % - Снижение норм расходов: стального проката (строка 2.1)
                "steel_pipes_reduction": 12,  # % - Снижение норм расходов: стальных труб (строка 2.2)
                "castings_reduction": 15,  # % - Снижение норм расходов: отливок черных и цветных металлов (строка 2.3)
                "other_materials_reduction": 9,
                # % - Снижение расходов и стоимости других материалов и комплектующих (строка 3)
                "labor_intensity_reduction": 12,  # % - Снижение трудоемкости (строка 4)
                # Капитальные затраты (тыс. руб) - раздел "Капитальные затраты" таблицы 2.1
                "design_survey_cost": 1800,  # тыс.руб - Расходы на проектно-изыскательские работы (Кпир) (строка 5)
                "fixed_assets_investment": 16000,  # тыс.руб - Капитальные вложения в основные фонды (Косн) (строка 6)
                "startup_cost": 2000,
                # тыс.руб - Расходы, связанные с пуском, наладкой и освоением производства (Косв) (строка 7)
                "residual_value_percent": 1.13
                # % - Остаточная стоимость основных фондов, которые должны пойти на слом (Кл) (строка 8)
            },
            "project_2": {
                "name": "Проект 2",
                "annual_volume_base": 350,  # шт - Годовой объем производства (строка 1 таблицы 2.1)
                "annual_volume_corrected": round(350 * self.Ka),  # Q(A) = 350 * 1.04 = 364 шт - скорректированный объем
                # Снижение норм расходов (%) - значения для Проекта 2 из таблицы 2.1
                "steel_rolling_reduction": 6,  # % - стального проката
                "steel_pipes_reduction": 14,  # % - стальных труб
                "castings_reduction": 13,  # % - отливок черных и цветных металлов
                "other_materials_reduction": 7,  # % - других материалов и комплектующих
                "labor_intensity_reduction": 10,  # % - трудоемкости
                # Капитальные затраты (тыс. руб) - значения для Проекта 2 из таблицы 2.1
                "design_survey_cost": 1900,  # тыс.руб - Кпир
                "fixed_assets_investment": 17000,  # тыс.руб - Косн
                "startup_cost": 2500,  # тыс.руб - Косв
                "residual_value_percent": 1.14  # % - Кл
            }
        }

        # Данные для расчета себестоимости (таблица 2.3 - "Данные для расчета себестоимости, прибыли и цены изделия по проектам")
        self.cost_calculation_data = {
            "project_1": {
                # ОСНОВНЫЕ МАТЕРИАЛЫ (раздел 1 таблицы 2.3)
                "steel_rolling_consumption": 0.5766,  # т - расходы стального проката (пункт 1.1)
                "steel_rolling_waste": 0.10379,  # т - отходы стального проката (пункт 1.1)
                "steel_pipes_consumption": 0.0528,  # т - расходы стальных труб (пункт 1.2)
                "steel_pipes_waste": 0.00370,  # т - отходы стальных труб (пункт 1.2)
                "nonferrous_rolling": 2275,  # руб - прокат цветных металлов (пункт 1.3)
                "other_materials": 728,  # руб - другие материалы (пункт 1.4)

                # ПОКУПНЫЕ ПОЛУФАБРИКАТЫ (раздел 2 таблицы 2.3)
                "castings_black_consumption": 2.21,  # т - расходы отливок черных металлов (пункт 2.1)
                "castings_black_waste": 0.3978,  # т - отходы отливок черных металлов (пункт 2.1)
                "castings_color_consumption": 0.272,  # т - расходы отливок цветных металлов (пункт 2.2)
                "castings_color_waste": 0.06256,  # т - отходы отливок цветных металлов (пункт 2.2)

                # КОМПЛЕКТУЮЩИЕ (раздел 3 таблицы 2.3)
                "purchased_components": 124488,  # руб - покупные комплектующие изделия (пункт 3)

                # ЦЕНЫ МАТЕРИАЛОВ (разделы 4-6 таблицы 2.3)
                "price_steel_rolling": 12800,  # руб/т - цена стального проката (пункт 4)
                "price_steel_pipes": 18500,  # руб/т - цена стальных труб (пункт 5)
                "price_castings_black": 10500,  # руб/т - цена отливок черных металлов (пункт 6)
                "price_castings_color": 22600,  # руб/т - цена отливок цветных металлов (пункт 6)

                # ЦЕНЫ ОТХОДОВ (раздел 7 таблицы 2.3)
                "price_waste_steel_rolling": 7500,  # руб/т - цена отходов стального проката (пункт 7)
                "price_waste_steel_pipes": 6300,  # руб/т - цена отходов труб стальных (пункт 7)
                "price_waste_castings_black": 7200,  # руб/т - цена отходов отливок черных металлов (пункт 7)
                "price_waste_castings_color": 16900,  # руб/т - цена отходов отливок цветных металлов (пункт 7)

                # ТОПЛИВО И ЭНЕРГИЯ (раздел 8 таблицы 2.3)
                "fuel_energy_percent": 1.6,  # % - топливо и энергия на технологические потребности (пункт 8)

                # ТРУДОЕМКОСТЬ И ЗАРПЛАТА (разделы 9-10 таблицы 2.3)
                "labor_intensity": 785.84,  # н-час - суммарная трудоемкость изделия (пункт 9)
                "hourly_rate": 41.50,  # руб - часовая тарифная ставка (пункт 10)

                # ПРОЦЕНТЫ ДЛЯ РАСЧЕТОВ (разделы 11-17 таблицы 2.3)
                "additional_salary_percent": 40,  # % - дополнительная зарплата (пункт 11)
                "social_insurance_percent": 22,  # % - отчисление на социальное страхование (пункт 12)
                "equipment_maintenance_percent": 80,  # % - расходы на содержание и эксплуатацию оборудования (пункт 13)
                "overhead_production_percent": 90,  # % - общепроизводственные расходы (пункт 14)
                "general_business_percent": 110,  # % - общехозяйственные расходы (пункт 15)
                "non_production_percent": 3,  # % - внепроизводственные расходы (пункт 16)
                "profitability_percent": 22  # % - норматив рентабельности к себестоимости (пункт 17)
                # Примечание: Годовой объем производства (пункт 18) хранится в projects_data
            },
            "project_2": {
                # ОСНОВНЫЕ МАТЕРИАЛЫ для Проекта 2 (таблица 2.3, колонка Проект 2)
                "steel_rolling_consumption": 0.5828,  # т - скорректированный расход стального проката
                "steel_rolling_waste": 0.104904,  # т - скорректированные отходы стального проката
                "steel_pipes_consumption": 0.0516,  # т - скорректированный расход стальных труб
                "steel_pipes_waste": 0.003612,  # т - скорректированные отходы стальных труб
                "nonferrous_rolling": 2325,  # руб - скорректированный прокат цветных металлов
                "other_materials": 744,  # руб - скорректированные другие материалы

                # ПОКУПНЫЕ ПОЛУФАБРИКАТЫ для Проекта 2
                "castings_black_consumption": 2.262,  # т - скорректированные расходы отливок черных металлов
                "castings_black_waste": 0.40716,  # т - скорректированные отходы отливок черных металлов
                "castings_color_consumption": 0.2784,  # т - скорректированные расходы отливок цветных металлов
                "castings_color_waste": 0.064032,  # т - скорректированные отходы отливок цветных металлов

                # КОМПЛЕКТУЮЩИЕ для Проекта 2
                "purchased_components": 127224,  # руб - скорректированные покупные комплектующие

                # ЦЕНЫ МАТЕРИАЛОВ и ОТХОДОВ (одинаковые для обоих проектов)
                "price_steel_rolling": 12800,  # руб/т - цена стального проката
                "price_steel_pipes": 18500,  # руб/т - цена стальных труб
                "price_castings_black": 10500,  # руб/т - цена отливок черных металлов
                "price_castings_color": 22600,  # руб/т - цена отливок цветных металлов
                "price_waste_steel_rolling": 7500,  # руб/т - цена отходов стального проката
                "price_waste_steel_pipes": 6300,  # руб/т - цена отходов труб стальных
                "price_waste_castings_black": 7200,  # руб/т - цена отходов отливок черных металлов
                "price_waste_castings_color": 16900,  # руб/т - цена отходов отливок цветных металлов

                # ТОПЛИВО И ЭНЕРГИЯ (одинаковое для обоих проектов)
                "fuel_energy_percent": 1.6,  # %

                # ТРУДОЕМКОСТЬ И ЗАРПЛАТА для Проекта 2
                "labor_intensity": 803.70,  # н-час - скорректированная трудоемкость
                "hourly_rate": 41.50,  # руб - часовая тарифная ставка (та же)

                # ПРОЦЕНТЫ ДЛЯ РАСЧЕТОВ (одинаковые для обоих проектов)
                "additional_salary_percent": 40,  # %
                "social_insurance_percent": 22,  # %
                "equipment_maintenance_percent": 80,  # %
                "overhead_production_percent": 90,  # %
                "general_business_percent": 110,  # %
                "non_production_percent": 3,  # %
                "profitability_percent": 22  # %
            }
        }

        # Результаты расчетов
        self.calculation_results = {
            "project_1": {},
            "project_2": {}
        }

    def calculate_material_costs(self, project: str) -> float:
        """Расчет основных материалов за вычетом возвратных отходов (пункт 1)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"1. РАСЧЕТ ОСНОВНЫХ МАТЕРИАЛОВ ЗА ВЫЧЕТОМ ВОЗВРАТНЫХ ОТХОДОВ")
        print(f"{'═'*80}")

        # Стальной прокат
        steel_rolling_raw = data["steel_rolling_consumption"] * data["price_steel_rolling"] * self.Ktr
        steel_rolling_waste = data["steel_rolling_waste"] * data["price_waste_steel_rolling"]
        steel_rolling_cost = steel_rolling_raw - steel_rolling_waste

        print(f"   Стальной прокат: ({data['steel_rolling_consumption']:.4f} × {data['price_steel_rolling']:,} × {self.Ktr}) - ({data['steel_rolling_waste']:.5f} × {data['price_waste_steel_rolling']:,})")
        print(f"   = ({steel_rolling_raw:,.2f}) - ({steel_rolling_waste:,.2f}) = {steel_rolling_cost:,.2f} руб.")

        # Трубы стальные
        steel_pipes_raw = data["steel_pipes_consumption"] * data["price_steel_pipes"] * self.Ktr
        steel_pipes_waste = data["steel_pipes_waste"] * data["price_waste_steel_pipes"]
        steel_pipes_cost = steel_pipes_raw - steel_pipes_waste

        print(f"\n   Трубы стальные: ({data['steel_pipes_consumption']:.4f} × {data['price_steel_pipes']:,} × {self.Ktr}) - ({data['steel_pipes_waste']:.5f} × {data['price_waste_steel_pipes']:,})")
        print(f"   = ({steel_pipes_raw:,.2f}) - ({steel_pipes_waste:,.2f}) = {steel_pipes_cost:,.2f} руб.")

        # Прокат цветных металлов и другие материалы
        print(f"\n   Прокат цветных металлов: {data['nonferrous_rolling']:,} руб.")
        print(f"   Другие материалы: {data['other_materials']:,} руб.")

        # Итого
        total_cost = steel_rolling_cost + steel_pipes_cost + data["nonferrous_rolling"] + data["other_materials"]

        print(f"\n   ИТОГО: {steel_rolling_cost:,.2f} + {steel_pipes_cost:,.2f} + {data['nonferrous_rolling']:,} + {data['other_materials']:,}")
        print(f"        = {total_cost:,.2f} руб.")

        return round(total_cost, 2)

    def calculate_purchased_semi_components(self, project: str) -> float:
        """Расчет покупных полуфабрикатов и комплектующих (пункт 2)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"2. РАСЧЕТ ПОКУПНЫХ ПОЛУФАБРИКАТОВ И КОМПЛЕКТУЮЩИХ")
        print(f"{'═'*80}")

        # Отливки черных металлов
        castings_black_raw = data["castings_black_consumption"] * data["price_castings_black"] * self.Ktr
        castings_black_waste = data["castings_black_waste"] * data["price_waste_castings_black"]
        castings_black_cost = castings_black_raw - castings_black_waste

        print(f"   Отливки черных металлов: ({data['castings_black_consumption']:.3f} × {data['price_castings_black']:,} × {self.Ktr}) - ({data['castings_black_waste']:.4f} × {data['price_waste_castings_black']:,})")
        print(f"   = ({castings_black_raw:,.2f}) - ({castings_black_waste:,.2f}) = {castings_black_cost:,.2f} руб.")

        # Отливки цветных металлов
        castings_color_raw = data["castings_color_consumption"] * data["price_castings_color"] * self.Ktr
        castings_color_waste = data["castings_color_waste"] * data["price_waste_castings_color"]
        castings_color_cost = castings_color_raw - castings_color_waste

        print(f"\n   Отливки цветных металлов: ({data['castings_color_consumption']:.3f} × {data['price_castings_color']:,} × {self.Ktr}) - ({data['castings_color_waste']:.5f} × {data['price_waste_castings_color']:,})")
        print(f"   = ({castings_color_raw:,.2f}) - ({castings_color_waste:,.2f}) = {castings_color_cost:,.2f} руб.")

        # Комплектующие
        print(f"\n   Покупные комплектующие изделия: {data['purchased_components']:,} руб.")

        # Итого
        total_cost = castings_black_cost + castings_color_cost + data["purchased_components"]

        print(f"\n   ИТОГО: {castings_black_cost:,.2f} + {castings_color_cost:,.2f} + {data['purchased_components']:,}")
        print(f"        = {total_cost:,.2f} руб.")

        return round(total_cost, 2)

    def calculate_fuel_energy(self, project: str, material_costs: float,
                            semi_components_costs: float) -> float:
        """Расчет топлива и энергии на технологические потребности (пункт 3)"""
        data = self.cost_calculation_data[project]
        beta = data["fuel_energy_percent"]

        print(f"\n{'═'*80}")
        print(f"3. РАСЧЕТ ТОПЛИВА И ЭНЕРГИИ НА ТЕХНОЛОГИЧЕСКИЕ ПОТРЕБНОСТИ")
        print(f"{'═'*80}")

        # Формула: Впер = ((Вом + Впф + Вком) * β) / (100 - β)
        sum_materials = material_costs + semi_components_costs
        numerator = sum_materials * beta
        denominator = 100 - beta

        fuel_energy_cost = numerator / denominator

        print(f"   Формула: Впер = ((Вом + Впф + Вком) × β) / (100 - β)")
        print(f"   Вом = {material_costs:,.2f} руб. (основные материалы)")
        print(f"   Впф + Вком = {semi_components_costs:,.2f} руб. (полуфабрикаты и комплектующие)")
        print(f"   β = {beta}%")
        print(f"\n   Расчет: (({material_costs:,.2f} + {semi_components_costs:,.2f}) × {beta}) / (100 - {beta})")
        print(f"         = ({sum_materials:,.2f} × {beta}) / {denominator}")
        print(f"         = {numerator:,.2f} / {denominator}")
        print(f"         = {fuel_energy_cost:,.2f} руб.")

        return round(fuel_energy_cost, 2)

    def calculate_basic_salary(self, project: str) -> float:
        """Расчет основной заработной платы (пункт 4)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"4. РАСЧЕТ ОСНОВНОЙ ЗАРАБОТНОЙ ПЛАТЫ ПРОИЗВОДСТВЕННЫХ РАБОЧИХ")
        print(f"{'═'*80}")

        basic_salary = data["labor_intensity"] * data["hourly_rate"]

        print(f"   Формула: Сосн = t × Т")
        print(f"   t = {data['hourly_rate']:.2f} руб./час (часовая тарифная ставка)")
        print(f"   Т = {data['labor_intensity']:.2f} н-час (суммарная трудоемкость)")
        print(f"\n   Расчет: {data['labor_intensity']:.2f} × {data['hourly_rate']:.2f}")
        print(f"         = {basic_salary:,.2f} руб.")

        return round(basic_salary, 2)

    def calculate_additional_salary(self, project: str, basic_salary: float) -> float:
        """Расчет дополнительной заработной платы (пункт 5)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"5. РАСЧЕТ ДОПОЛНИТЕЛЬНОЙ ЗАРАБОТНОЙ ПЛАТЫ")
        print(f"{'═'*80}")

        additional_salary = basic_salary * data["additional_salary_percent"] / 100

        print(f"   Формула: Сдоп = Сосн × %доп")
        print(f"   Сосн = {basic_salary:,.2f} руб. (основная зарплата)")
        print(f"   %доп = {data['additional_salary_percent']}%")
        print(f"\n   Расчет: {basic_salary:,.2f} × {data['additional_salary_percent']}%")
        print(f"         = {basic_salary:,.2f} × {data['additional_salary_percent']/100}")
        print(f"         = {additional_salary:,.2f} руб.")

        return round(additional_salary, 2)

    def calculate_social_insurance(self, project: str, basic_salary: float,
                                 additional_salary: float) -> float:
        """Расчет отчислений на социальное страхование (пункт 6)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"6. РАСЧЕТ ОТЧИСЛЕНИЙ В ФОНДЫ СОЦИАЛЬНЫХ МЕРОПРИЯТИЙ")
        print(f"{'═'*80}")

        total_salary = basic_salary + additional_salary
        social_insurance = total_salary * data["social_insurance_percent"] / 100

        print(f"   Формула: Ссоц = (Сосн + Сдоп) × %соц")
        print(f"   Сосн = {basic_salary:,.2f} руб.")
        print(f"   Сдоп = {additional_salary:,.2f} руб.")
        print(f"   %соц = {data['social_insurance_percent']}%")
        print(f"\n   Расчет: ({basic_salary:,.2f} + {additional_salary:,.2f}) × {data['social_insurance_percent']}%")
        print(f"         = {total_salary:,.2f} × {data['social_insurance_percent']/100}")
        print(f"         = {social_insurance:,.2f} руб.")

        return round(social_insurance, 2)

    def calculate_equipment_maintenance(self, project: str, basic_salary: float) -> float:
        """Расчет расходов на содержание и эксплуатацию оборудования (пункт 7)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"7. РАСЧЕТ РАСХОДОВ НА СОДЕРЖАНИЕ И ЭКСПЛУАТАЦИЮ ОБОРУДОВАНИЯ")
        print(f"{'═'*80}")

        equipment_cost = basic_salary * data["equipment_maintenance_percent"] / 100

        print(f"   Формула: Рсэо = Сосн × %рсэо")
        print(f"   Сосн = {basic_salary:,.2f} руб. (основная зарплата)")
        print(f"   %рсэо = {data['equipment_maintenance_percent']}%")
        print(f"\n   Расчет: {basic_salary:,.2f} × {data['equipment_maintenance_percent']}%")
        print(f"         = {basic_salary:,.2f} × {data['equipment_maintenance_percent']/100}")
        print(f"         = {equipment_cost:,.2f} руб.")

        return round(equipment_cost, 2)

    def calculate_overhead_production(self, project: str, basic_salary: float) -> float:
        """Расчет общепроизводственных расходов (пункт 8)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"8. РАСЧЕТ ОБЩЕПРОИЗВОДСТВЕННЫХ РАСХОДОВ")
        print(f"{'═'*80}")

        overhead = basic_salary * data["overhead_production_percent"] / 100

        print(f"   Формула: Роп = Сосн × %роп")
        print(f"   Сосн = {basic_salary:,.2f} руб. (основная зарплата)")
        print(f"   %роп = {data['overhead_production_percent']}%")
        print(f"\n   Расчет: {basic_salary:,.2f} × {data['overhead_production_percent']}%")
        print(f"         = {basic_salary:,.2f} × {data['overhead_production_percent']/100}")
        print(f"         = {overhead:,.2f} руб.")

        return round(overhead, 2)

    def calculate_general_business(self, project: str, basic_salary: float) -> float:
        """Расчет общехозяйственных расходы (пункт 9)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"9. РАСЧЕТ ОБЩЕХОЗЯЙСТВЕННЫХ РАСХОДОВ")
        print(f"{'═'*80}")

        general_business = basic_salary * data["general_business_percent"] / 100

        print(f"   Формула: Рох = Сосн × %рох")
        print(f"   Сосн = {basic_salary:,.2f} руб. (основная зарплата)")
        print(f"   %рох = {data['general_business_percent']}%")
        print(f"\n   Расчет: {basic_salary:,.2f} × {data['general_business_percent']}%")
        print(f"         = {basic_salary:,.2f} × {data['general_business_percent']/100}")
        print(f"         = {general_business:,.2f} руб.")

        return round(general_business, 2)

    def calculate_non_production(self, project: str, production_cost: float) -> float:
        """Расчет внепроизводственных расходов (пункт 11)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"11. РАСЧЕТ ВНЕПРОИЗВОДСТВЕННЫХ РАСХОДОВ")
        print(f"{'═'*80}")

        non_production = production_cost * data["non_production_percent"] / 100

        print(f"   Формула: Впр = Спроиз × %впр")
        print(f"   Спроиз = {production_cost:,.2f} руб. (производственная себестоимость)")
        print(f"   %впр = {data['non_production_percent']}%")
        print(f"\n   Расчет: {production_cost:,.2f} × {data['non_production_percent']}%")
        print(f"         = {production_cost:,.2f} × {data['non_production_percent']/100}")
        print(f"         = {non_production:,.2f} руб.")

        return round(non_production, 2)

    def calculate_profit(self, project: str, full_cost: float) -> float:
        """Расчет прибыли (пункт 13)"""
        data = self.cost_calculation_data[project]

        print(f"\n{'═'*80}")
        print(f"13. РАСЧЕТ ПРИБЫЛИ")
        print(f"{'═'*80}")

        profit = full_cost * data["profitability_percent"] / 100

        print(f"   Формула: П = Сполн × %рент")
        print(f"   Сполн = {full_cost:,.2f} руб. (полная себестоимость)")
        print(f"   %рент = {data['profitability_percent']}% (норматив рентабельности)")
        print(f"\n   Расчет: {full_cost:,.2f} × {data['profitability_percent']}%")
        print(f"         = {full_cost:,.2f} × {data['profitability_percent']/100}")
        print(f"         = {profit:,.2f} руб.")

        return round(profit, 2)

    def calculate_wholesale_price(self, full_cost: float, profit: float) -> float:
        """Расчет оптовой цены (пункт 14)"""

        print(f"\n{'═'*80}")
        print(f"14. РАСЧЕТ ОПТОВОЙ ЦЕНЫ")
        print(f"{'═'*80}")

        wholesale_price = full_cost + profit

        print(f"   Формула: Цопт = Сполн + П")
        print(f"   Сполн = {full_cost:,.2f} руб. (полная себестоимость)")
        print(f"   П = {profit:,.2f} руб. (прибыль)")
        print(f"\n   Расчет: {full_cost:,.2f} + {profit:,.2f}")
        print(f"         = {wholesale_price:,.2f} руб.")

        return round(wholesale_price, 2)

    def calculate_annual_costs(self, unit_cost: float, annual_volume: float, item_name: str = "") -> float:
        """Расчет годовых затрат (тыс. руб)"""
        annual_cost = (unit_cost * annual_volume) / 1000  # переводим в тыс. руб

        if item_name:
            print(f"\n   Годовые затраты на '{item_name}':")
            print(f"   {unit_cost:,.2f} руб./ед. × {annual_volume:.0f} шт. / 1000")
            print(f"   = {annual_cost:,.2f} тыс. руб.")

        return round(annual_cost, 2)

    def calculate_all_costs(self):
        """Основной метод расчета всех статей себестоимости для обоих проектов"""

        for project_key in ["project_1", "project_2"]:
            project_name = self.projects_data[project_key]["name"]
            annual_volume = self.projects_data[project_key]["annual_volume_corrected"]

            print(f"\n{'═'*80}")
            print(f"РАСЧЕТ СЕБЕСТОИМОСТИ ДЛЯ {project_name}")
            print(f"{'═'*80}")

            print(f"\nИСХОДНЫЕ ДАННЫЕ:")
            print(f"  Годовой объем: {annual_volume} шт.")
            print(f"  Коэффициент Ктр: {self.Ktr}")

            # 1. Основные материалы
            material_costs = self.calculate_material_costs(project_key)
            self.calculation_results[project_key]["material_costs"] = material_costs

            # 2. Покупные полуфабрикаты и комплектующие
            semi_components = self.calculate_purchased_semi_components(project_key)
            self.calculation_results[project_key]["semi_components"] = semi_components

            # 3. Топливо и энергия
            fuel_energy = self.calculate_fuel_energy(project_key, material_costs, semi_components)
            self.calculation_results[project_key]["fuel_energy"] = fuel_energy

            # 4. Основная зарплата
            basic_salary = self.calculate_basic_salary(project_key)
            self.calculation_results[project_key]["basic_salary"] = basic_salary

            # 5. Дополнительная зарплата
            additional_salary = self.calculate_additional_salary(project_key, basic_salary)
            self.calculation_results[project_key]["additional_salary"] = additional_salary

            # 6. Отчисления на социальное страхование
            social_insurance = self.calculate_social_insurance(project_key, basic_salary, additional_salary)
            self.calculation_results[project_key]["social_insurance"] = social_insurance

            # 7. Расходы на содержание и эксплуатацию оборудования
            equipment_maintenance = self.calculate_equipment_maintenance(project_key, basic_salary)
            self.calculation_results[project_key]["equipment_maintenance"] = equipment_maintenance

            # 8. Общепроизводственные расходы
            overhead_production = self.calculate_overhead_production(project_key, basic_salary)
            self.calculation_results[project_key]["overhead_production"] = overhead_production

            # 9. Общехозяйственные расходы
            general_business = self.calculate_general_business(project_key, basic_salary)
            self.calculation_results[project_key]["general_business"] = general_business

            # 10. Производственная себестоимость
            print(f"\n{'═'*80}")
            print(f"10. РАСЧЕТ ПРОИЗВОДСТВЕННОЙ СЕБЕСТОИМОСТИ")
            print(f"{'═'*80}")

            production_costs = [
                material_costs,
                semi_components,
                fuel_energy,
                basic_salary,
                additional_salary,
                social_insurance,
                equipment_maintenance,
                overhead_production,
                general_business
            ]

            production_cost = round(sum(production_costs), 2)

            print(f"\n   Суммируем все производственные расходы:")
            print(f"   1. Основные материалы: {material_costs:,.2f} руб.")
            print(f"   2. Полуфабрикаты и комплектующие: {semi_components:,.2f} руб.")
            print(f"   3. Топливо и энергия: {fuel_energy:,.2f} руб.")
            print(f"   4. Основная зарплата: {basic_salary:,.2f} руб.")
            print(f"   5. Дополнительная зарплата: {additional_salary:,.2f} руб.")
            print(f"   6. Отчисления: {social_insurance:,.2f} руб.")
            print(f"   7. Содержание оборудования: {equipment_maintenance:,.2f} руб.")
            print(f"   8. Общепроизводственные расходы: {overhead_production:,.2f} руб.")
            print(f"   9. Общехозяйственные расходы: {general_business:,.2f} руб.")
            print(f"\n   ИТОГО: {production_cost:,.2f} руб.")

            self.calculation_results[project_key]["production_cost"] = production_cost

            # 11. Внепроизводственные расходы
            non_production = self.calculate_non_production(project_key, production_cost)
            self.calculation_results[project_key]["non_production"] = non_production

            # 12. Полная себестоимость
            print(f"\n{'═'*80}")
            print(f"12. РАСЧЕТ ПОЛНОЙ СЕБЕСТОИМОСТИ")
            print(f"{'═'*80}")

            full_cost = production_cost + non_production

            print(f"\n   Формула: Сполн = Спроиз + Впр")
            print(f"   Спроиз = {production_cost:,.2f} руб.")
            print(f"   Впр = {non_production:,.2f} руб.")
            print(f"\n   Расчет: {production_cost:,.2f} + {non_production:,.2f}")
            print(f"         = {full_cost:,.2f} руб.")

            self.calculation_results[project_key]["full_cost"] = full_cost

            # 13. Прибыль
            profit = self.calculate_profit(project_key, full_cost)
            self.calculation_results[project_key]["profit"] = profit

            # 14. Оптовая цена
            wholesale_price = self.calculate_wholesale_price(full_cost, profit)
            self.calculation_results[project_key]["wholesale_price"] = wholesale_price

            # Годовые затраты
            print(f"\n{'═'*80}")
            print(f"РАСЧЕТ ГОДОВЫХ ЗАТРАТ И ВЫПУСКА")
            print(f"{'═'*80}")

            annual_material = self.calculate_annual_costs(material_costs, annual_volume, "Основные материалы")
            annual_semi = self.calculate_annual_costs(semi_components, annual_volume, "Полуфабрикаты и комплектующие")
            annual_fuel = self.calculate_annual_costs(fuel_energy, annual_volume, "Топливо и энергия")
            annual_basic_salary = self.calculate_annual_costs(basic_salary, annual_volume, "Основная зарплата")
            annual_additional_salary = self.calculate_annual_costs(additional_salary, annual_volume, "Дополнительная зарплата")
            annual_social = self.calculate_annual_costs(social_insurance, annual_volume, "Отчисления")
            annual_equipment = self.calculate_annual_costs(equipment_maintenance, annual_volume, "Содержание оборудования")
            annual_overhead = self.calculate_annual_costs(overhead_production, annual_volume, "Общепроизводственные расходы")
            annual_general = self.calculate_annual_costs(general_business, annual_volume, "Общехозяйственные расходы")
            annual_production = self.calculate_annual_costs(production_cost, annual_volume, "Производственная себестоимость")
            annual_non_production = self.calculate_annual_costs(non_production, annual_volume, "Внепроизводственные расходы")
            annual_full_cost = self.calculate_annual_costs(full_cost, annual_volume, "Полная себестоимость")
            annual_profit = self.calculate_annual_costs(profit, annual_volume, "Прибыль")

            # Объем товарной продукции
            commodity_output = (wholesale_price * annual_volume) / 1000  # тыс. руб
            print(f"\n   Объем товарной продукции (Qт):")
            print(f"   {wholesale_price:,.2f} руб./ед. × {annual_volume} шт. / 1000")
            print(f"   = {commodity_output:,.2f} тыс. руб.")

            # Сохраняем результаты
            self.calculation_results[project_key]["annual_costs"] = {
                "material": annual_material,
                "semi_components": annual_semi,
                "fuel_energy": annual_fuel,
                "basic_salary": annual_basic_salary,
                "additional_salary": annual_additional_salary,
                "social_insurance": annual_social,
                "equipment_maintenance": annual_equipment,
                "overhead_production": annual_overhead,
                "general_business": annual_general,
                "production_cost": annual_production,
                "non_production": annual_non_production,
                "full_cost": annual_full_cost,
                "profit": annual_profit,
                "commodity_output": commodity_output
            }

            print(f"\n{'═'*80}")
            print(f"ИТОГОВЫЕ РЕЗУЛЬТАТЫ ДЛЯ {project_name}")
            print(f"{'═'*80}")
            print(f"  Полная себестоимость единицы: {full_cost:,.2f} руб.")
            print(f"  Прибыль единицы: {profit:,.2f} руб.")
            print(f"  Оптовая цена единицы: {wholesale_price:,.2f} руб.")
            print(f"  Годовая полная себестоимость: {annual_full_cost:,.2f} тыс. руб.")
            print(f"  Годовая прибыль: {annual_profit:,.2f} тыс. руб.")
            print(f"  Объем товарной продукции: {commodity_output:,.2f} тыс. руб.")

    def create_cost_table_2_4(self):
        """Создание таблицы 2.4 - Калькуляция себестоимости, прибыль и оптовая цена"""

        # Заголовки таблицы
        headers = [
            "Наименование статей расходов",
            "Проект 1",
            " ",
            "Проект 2",
            " "
        ]

        subheaders = [
            "",
            "на единицу, руб.",
            "на годовой выпуск, тыс.руб.",
            "на единицу, руб.",
            "на годовой выпуск, тыс.руб."
        ]

        # Данные для таблицы
        rows = []

        # 1. Основные материалы
        rows.append([
            "1.Основные материалы за вычетом возвратных отходов",
            f"{self.calculation_results['project_1']['material_costs']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['material']:.2f}",
            f"{self.calculation_results['project_2']['material_costs']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['material']:.2f}"
        ])

        # 2. Покупные полуфабрикаты и комплектующие
        rows.append([
            "2.Покупные полуфабрикаты и комплектующие изделия",
            f"{self.calculation_results['project_1']['semi_components']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['semi_components']:.2f}",
            f"{self.calculation_results['project_2']['semi_components']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['semi_components']:.2f}"
        ])

        # 3. Топливо и энергия
        rows.append([
            "3.Топливо и энергия на технологические потребности",
            f"{self.calculation_results['project_1']['fuel_energy']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['fuel_energy']:.2f}",
            f"{self.calculation_results['project_2']['fuel_energy']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['fuel_energy']:.2f}"
        ])

        # 4. Основная зарплата
        rows.append([
            "4.Основная заработная плата производственных рабочих",
            f"{self.calculation_results['project_1']['basic_salary']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['basic_salary']:.2f}",
            f"{self.calculation_results['project_2']['basic_salary']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['basic_salary']:.2f}"
        ])

        # 5. Дополнительная зарплата
        rows.append([
            "5.Дополнительная заработная плата производственных рабочих",
            f"{self.calculation_results['project_1']['additional_salary']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['additional_salary']:.2f}",
            f"{self.calculation_results['project_2']['additional_salary']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['additional_salary']:.2f}"
        ])

        # 6. Отчисления на социальное страхование
        rows.append([
            "6.Отчисление в фонды социальных мероприятий",
            f"{self.calculation_results['project_1']['social_insurance']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['social_insurance']:.2f}",
            f"{self.calculation_results['project_2']['social_insurance']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['social_insurance']:.2f}"
        ])

        # 7. Расходы на содержание и эксплуатацию оборудования
        rows.append([
            "7.Расходы по содержанию и эксплуатации оборудования",
            f"{self.calculation_results['project_1']['equipment_maintenance']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['equipment_maintenance']:.2f}",
            f"{self.calculation_results['project_2']['equipment_maintenance']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['equipment_maintenance']:.2f}"
        ])

        # 8. Общепроизводственные расходы
        rows.append([
            "8.Общепроизводственные расходы",
            f"{self.calculation_results['project_1']['overhead_production']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['overhead_production']:.2f}",
            f"{self.calculation_results['project_2']['overhead_production']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['overhead_production']:.2f}"
        ])

        # 9. Общехозяйственные расходы
        rows.append([
            "9.Общехозяйственные расходы",
            f"{self.calculation_results['project_1']['general_business']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['general_business']:.2f}",
            f"{self.calculation_results['project_2']['general_business']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['general_business']:.2f}"
        ])

        # 10. ИТОГО производственная себестоимость
        rows.append([
            "ВСЕГО производственная себестоимость",
            f"{self.calculation_results['project_1']['production_cost']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['production_cost']:.2f}",
            f"{self.calculation_results['project_2']['production_cost']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['production_cost']:.2f}"
        ])

        # 11. Внепроизводственные расходы
        rows.append([
            "10.Внепроизводственные расходы",
            f"{self.calculation_results['project_1']['non_production']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['non_production']:.2f}",
            f"{self.calculation_results['project_2']['non_production']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['non_production']:.2f}"
        ])

        # 12. ИТОГО полная себестоимость
        rows.append([
            "ВСЕГО полная себестоимость",
            f"{self.calculation_results['project_1']['full_cost']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['full_cost']:.2f}",
            f"{self.calculation_results['project_2']['full_cost']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['full_cost']:.2f}"
        ])

        # 13. Прибыль
        rows.append([
            "Прибыль",
            f"{self.calculation_results['project_1']['profit']:.2f}",
            f"{self.calculation_results['project_1']['annual_costs']['profit']:.2f}",
            f"{self.calculation_results['project_2']['profit']:.2f}",
            f"{self.calculation_results['project_2']['annual_costs']['profit']:.2f}"
        ])

        # 14. Оптовая цена
        rows.append([
            "Оптовая цена",
            f"{self.calculation_results['project_1']['wholesale_price']:.2f}",
            "",
            f"{self.calculation_results['project_2']['wholesale_price']:.2f}",
            ""
        ])

        # Создаем CSV файл
        filename = "таблица_2_4_себестоимость.csv"

        with open(filename, 'w', newline='', encoding='utf-8-sig') as csvfile:
            writer = csv.writer(csvfile, delimiter=';')

            # Записываем заголовки
            writer.writerow(headers)
            writer.writerow(subheaders)

            # Записываем данные
            for row in rows:
                writer.writerow(row)

        print(f"\nТаблица 2.4 сохранена в файл: {filename}")
        return filename

    def create_input_data_table_2_3(self):
        """Создание таблицы 2.3 - Данные для расчета себестоимости"""

        # Заголовки таблицы
        headers = ["№", "Показатели", "Ед. измерения", "Проект 1", "Проект 2"]

        # Данные для таблицы (основные показатели)
        rows = [
            ["1", "Основные материалы", "", "", ""],
            ["1.1", "Стальной прокат:", "", "", ""],
            ["", " - расходы", "т",
             f"{self.cost_calculation_data['project_1']['steel_rolling_consumption']:.4f}",
             f"{self.cost_calculation_data['project_2']['steel_rolling_consumption']:.4f}"],
            ["", " - отходы", "т",
             f"{self.cost_calculation_data['project_1']['steel_rolling_waste']:.5f}",
             f"{self.cost_calculation_data['project_2']['steel_rolling_waste']:.6f}"],
            ["1.2", "Трубы стальные:", "", "", ""],
            ["", " - расходы", "т",
             f"{self.cost_calculation_data['project_1']['steel_pipes_consumption']:.4f}",
             f"{self.cost_calculation_data['project_2']['steel_pipes_consumption']:.4f}"],
            ["", " - отходы", "т",
             f"{self.cost_calculation_data['project_1']['steel_pipes_waste']:.5f}",
             f"{self.cost_calculation_data['project_2']['steel_pipes_waste']:.6f}"],
            ["1.3", "Прокат цветных металлов", "руб",
             f"{self.cost_calculation_data['project_1']['nonferrous_rolling']:.0f}",
             f"{self.cost_calculation_data['project_2']['nonferrous_rolling']:.0f}"],
            ["1.4", "Другие материалы", "руб",
             f"{self.cost_calculation_data['project_1']['other_materials']:.0f}",
             f"{self.cost_calculation_data['project_2']['other_materials']:.0f}"],
            ["2", "Покупные полуфабрикаты (отливки):", "", "", ""],
            ["2.1", "черных металлов", "", "", ""],
            ["", " - расходы", "т",
             f"{self.cost_calculation_data['project_1']['castings_black_consumption']:.3f}",
             f"{self.cost_calculation_data['project_2']['castings_black_consumption']:.3f}"],
            ["", " - отходы", "т",
             f"{self.cost_calculation_data['project_1']['castings_black_waste']:.4f}",
             f"{self.cost_calculation_data['project_2']['castings_black_waste']:.5f}"],
            ["2.2", "цветных металлов", "", "", ""],
            ["", " - расходы", "т",
             f"{self.cost_calculation_data['project_1']['castings_color_consumption']:.3f}",
             f"{self.cost_calculation_data['project_2']['castings_color_consumption']:.4f}"],
            ["", " - отходы", "т",
             f"{self.cost_calculation_data['project_1']['castings_color_waste']:.5f}",
             f"{self.cost_calculation_data['project_2']['castings_color_waste']:.6f}"],
            ["3", "покупные комплектующие изделия", "руб",
             f"{self.cost_calculation_data['project_1']['purchased_components']:.0f}",
             f"{self.cost_calculation_data['project_2']['purchased_components']:.0f}"],
            ["4", "Цена стального проката", "руб/т",
             f"{self.cost_calculation_data['project_1']['price_steel_rolling']:.0f}",
             f"{self.cost_calculation_data['project_2']['price_steel_rolling']:.0f}"],
            ["5", "Цена стальных труб", "руб/т",
             f"{self.cost_calculation_data['project_1']['price_steel_pipes']:.0f}",
             f"{self.cost_calculation_data['project_2']['price_steel_pipes']:.0f}"],
            ["6", "Цена отливок:", "", "", ""],
            ["", "-черных металлов", "руб/т",
             f"{self.cost_calculation_data['project_1']['price_castings_black']:.0f}",
             f"{self.cost_calculation_data['project_2']['price_castings_black']:.0f}"],
            ["", "-цветных металлов", "руб/т",
             f"{self.cost_calculation_data['project_1']['price_castings_color']:.0f}",
             f"{self.cost_calculation_data['project_2']['price_castings_color']:.0f}"],
            ["7", "Цена отходов:", "", "", ""],
            ["", "-стального проката", "руб/т",
             f"{self.cost_calculation_data['project_1']['price_waste_steel_rolling']:.0f}",
             f"{self.cost_calculation_data['project_2']['price_waste_steel_rolling']:.0f}"],
            ["", "-труб стальных", "руб/т",
             f"{self.cost_calculation_data['project_1']['price_waste_steel_pipes']:.0f}",
             f"{self.cost_calculation_data['project_2']['price_waste_steel_pipes']:.0f}"],
            ["", "-отливок черных металлов", "руб/т",
             f"{self.cost_calculation_data['project_1']['price_waste_castings_black']:.0f}",
             f"{self.cost_calculation_data['project_2']['price_waste_castings_black']:.0f}"],
            ["", "-отливок цветных металлов", "руб/т",
             f"{self.cost_calculation_data['project_1']['price_waste_castings_color']:.0f}",
             f"{self.cost_calculation_data['project_2']['price_waste_castings_color']:.0f}"],
            ["8", "Топливо и энергия на технологические потребности", "%",
             f"{self.cost_calculation_data['project_1']['fuel_energy_percent']:.1f}",
             f"{self.cost_calculation_data['project_2']['fuel_energy_percent']:.1f}"],
            ["9", "Суммарная трудоемкость изделия", "н-час",
             f"{self.cost_calculation_data['project_1']['labor_intensity']:.2f}",
             f"{self.cost_calculation_data['project_2']['labor_intensity']:.2f}"],
            ["10", "Часовая тарифная ставка", "руб",
             f"{self.cost_calculation_data['project_1']['hourly_rate']:.2f}",
             f"{self.cost_calculation_data['project_2']['hourly_rate']:.2f}"],
            ["11", "Дополнительная зарплата", "%",
             f"{self.cost_calculation_data['project_1']['additional_salary_percent']:.0f}",
             f"{self.cost_calculation_data['project_2']['additional_salary_percent']:.0f}"],
            ["12", "Отчисление на социальное страхование", "%",
             f"{self.cost_calculation_data['project_1']['social_insurance_percent']:.0f}",
             f"{self.cost_calculation_data['project_2']['social_insurance_percent']:.0f}"],
            ["13", "Расходы на содержание и эксплуатацию оборудования", "%",
             f"{self.cost_calculation_data['project_1']['equipment_maintenance_percent']:.0f}",
             f"{self.cost_calculation_data['project_2']['equipment_maintenance_percent']:.0f}"],
            ["14", "Общепроизводственные расходы", "%",
             f"{self.cost_calculation_data['project_1']['overhead_production_percent']:.0f}",
             f"{self.cost_calculation_data['project_2']['overhead_production_percent']:.0f}"],
            ["15", "Общехозяйственные расходы", "%",
             f"{self.cost_calculation_data['project_1']['general_business_percent']:.0f}",
             f"{self.cost_calculation_data['project_2']['general_business_percent']:.0f}"],
            ["16", "Внепроизводственные расходы", "%",
             f"{self.cost_calculation_data['project_1']['non_production_percent']:.0f}",
             f"{self.cost_calculation_data['project_2']['non_production_percent']:.0f}"],
            ["17", "Норматив рентабельности к себестоимости", "%",
             f"{self.cost_calculation_data['project_1']['profitability_percent']:.0f}",
             f"{self.cost_calculation_data['project_2']['profitability_percent']:.0f}"],
            ["18", "Годовой объем производства", "шт",
             f"{self.projects_data['project_1']['annual_volume_corrected']:.0f}",
             f"{self.projects_data['project_2']['annual_volume_corrected']:.0f}"]
        ]

        # Создаем CSV файл
        filename = "таблица_2_3_данные_для_расчета.csv"

        with open(filename, 'w', newline='', encoding='utf-8-sig') as csvfile:
            writer = csv.writer(csvfile, delimiter=';')

            # Записываем заголовки
            writer.writerow(headers)

            # Записываем данные
            for row in rows:
                writer.writerow(row)

        print(f"Таблица 2.3 сохранена в файл: {filename}")
        return filename

    def create_verification_report(self):
        """Создание отчета проверки расчетов"""

        # Данные из примера студента (для проверки)
        student_data_project1 = {
            "material_costs": 11812.14,
            "semi_components": 154321.606,
            "fuel_energy": 2701.36,
            "basic_salary": 32612.36,
            "additional_salary": 13044.944,
            "social_insurance": 10044.61,
            "equipment_maintenance": 26089.89,
            "overhead_production": 29351.12,
            "general_business": 35873.60,
            "production_cost": 315851.87,
            "non_production": 9475.55,
            "full_cost": 325327.42,
            "profit": 71572.03,
            "wholesale_price": 396899.45,
            "annual_material": 4063.37,
            "annual_semi": 53086.63,
            "annual_fuel": 929.26,
            "annual_basic_salary": 11218.65,
            "annual_additional_salary": 4487.46,
            "annual_social": 3455.34,
            "annual_equipment": 8974.92,
            "annual_overhead": 10096.78,
            "annual_general": 12340.51,
            "annual_production": 108653.04,
            "annual_non_production": 3259.59,
            "annual_full_cost": 111912.64,
            "annual_profit": 24620.78
        }

        student_data_project2 = {
            "material_costs": 11936.07,
            "semi_components": 157759.57,
            "fuel_energy": 2759.27,
            "basic_salary": 33353.55,
            "additional_salary": 13341.42,
            "social_insurance": 10272.89,
            "equipment_maintenance": 26682.84,
            "overhead_production": 30018.20,
            "general_business": 36688.91,
            "production_cost": 322812.72,
            "non_production": 9684.38,
            "full_cost": 332497.10,
            "profit": 73149.36,
            "wholesale_price": 405646.46
        }

        print(f"\n{'═'*80}")
        print("ПРОВЕРКА РАСЧЕТОВ")
        print("(сравнение с данными из примера студента)")
        print(f"{'═'*80}")

        # Проверяем Проект 1
        print(f"\n{'═'*80}")
        print("ПРОЕКТ 1 - СРАВНЕНИЕ С ПРИМЕРОМ СТУДЕНТА")
        print(f"{'═'*80}")

        mismatches = []

        for key, student_value in student_data_project1.items():
            if key in self.calculation_results["project_1"]:
                our_value = self.calculation_results["project_1"][key]
                difference = round(abs(our_value - student_value), 2)

                if difference > 0.01:  # Допустимая погрешность
                    mismatches.append((key, our_value, student_value, difference))
                    print(f"  ❌ {key}: наш={our_value:.2f}, пример={student_value:.2f}, разница={difference:.2f}")
                else:
                    print(f"  ✅ {key}: наш={our_value:.2f}, пример={student_value:.2f} (совпадает)")

        # Проверяем Проект 2
        print(f"\n{'═'*80}")
        print("ПРОЕКТ 2 - СРАВНЕНИЕ С ПРИМЕРОМ СТУДЕНТА")
        print(f"{'═'*80}")

        for key, student_value in student_data_project2.items():
            if key in self.calculation_results["project_2"]:
                our_value = self.calculation_results["project_2"][key]
                difference = round(abs(our_value - student_value), 2)

                if difference > 0.01:  # Допустимая погрешность
                    mismatches.append((f"project_2_{key}", our_value, student_value, difference))
                    print(f"  ❌ {key}: наш={our_value:.2f}, пример={student_value:.2f}, разница={difference:.2f}")
                else:
                    print(f"  ✅ {key}: наш={our_value:.2f}, пример={student_value:.2f} (совпадает)")

        # Итог проверки
        print(f"\n{'═'*80}")
        print("ИТОГ ПРОВЕРКИ")
        print(f"{'═'*80}")

        if not mismatches:
            print("✅ ВСЕ РАСЧЕТЫ СОВПАДАЮТ С ПРИМЕРОМ СТУДЕНТА!")
        else:
            print(f"⚠️  Обнаружено {len(mismatches)} расхождений:")
            for mismatch in mismatches:
                print(f"   - {mismatch[0]}: наш={mismatch[1]:.2f}, пример={mismatch[2]:.2f}, разница={mismatch[3]:.2f}")

        # Создаем CSV файл с результатами проверки
        filename = "проверка_расчетов.csv"

        headers = ["Показатель", "Наш расчет", "Пример студента", "Разница", "Статус"]
        rows = []

        # Проект 1
        for key, student_value in student_data_project1.items():
            if key in self.calculation_results["project_1"]:
                our_value = self.calculation_results["project_1"][key]
                difference = round(abs(our_value - student_value), 2)
                status = "Совпадает" if difference <= 0.01 else "Расхождение"
                rows.append([f"Проект 1: {key}", f"{our_value:.2f}", f"{student_value:.2f}", f"{difference:.2f}", status])

        # Проект 2
        for key, student_value in student_data_project2.items():
            if key in self.calculation_results["project_2"]:
                our_value = self.calculation_results["project_2"][key]
                difference = round(abs(our_value - student_value), 2)
                status = "Совпадает" if difference <= 0.01 else "Расхождение"
                rows.append([f"Проект 2: {key}", f"{our_value:.2f}", f"{student_value:.2f}", f"{difference:.2f}", status])

        with open(filename, 'w', newline='', encoding='utf-8-sig') as csvfile:
            writer = csv.writer(csvfile, delimiter=';')
            writer.writerow(headers)
            for row in rows:
                writer.writerow(row)

        print(f"\nОтчет проверки сохранен в файл: {filename}")

        return len(mismatches)

def main():
    """Основная функция"""

    print("="*80)
    print("РАСЧЕТ ПРОЕКТНОЙ ЧАСТИ КУРСОВОЙ РАБОТЫ")
    print("Этап 1: Расчет себестоимости продукции")
    print("Используются данные из примера студента (вариант 3)")
    print("="*80)

    # Создаем экземпляр калькулятора
    calculator = CostCalculator()

    # Выполняем расчеты с промежуточными выводами
    calculator.calculate_all_costs()

    # Создаем таблицы CSV
    calculator.create_input_data_table_2_3()
    calculator.create_cost_table_2_4()

    # Проверяем расчеты
    mismatches = calculator.create_verification_report()

    print(f"\n{'='*80}")
    print("ЭТАП 1 ЗАВЕРШЕН")
    print("="*80)
    print("Созданы файлы:")
    print("  - таблица_2_3_данные_для_расчета.csv")
    print("  - таблица_2_4_себестоимость.csv")
    print("  - проверка_расчетов.csv")
    print(f"\nРезультат проверки: {mismatches} расхождений с примером студента")
    print("="*80)

if __name__ == "__main__":
    main()

====================
FILE: .\task1\funcs.py
====================
import csv
import io
import json
from typing import List, Dict, Any


def calculate_material_costs(norma_rasxoda, norma_otxoda, price_mat, price_otxod, Ktr=1.0):
    """
    Расчет затрат на один вид основного материала или покупного полуфабриката
    для одного изделия по формуле: Сi = (Нmi * Цmi * Kтр - Н0i * Ц0i).

    Args:
        norma_rasxoda (float): Норма расхода материала (в тоннах).
        norma_otxoda (float): Норма отходов (в тоннах).
        price_mat (float): Цена материала (руб/т).
        price_otxod (float): Цена отходов (руб/т).
        Ktr (float): Коэффициент транспортно-заготовительных расходов.

    Returns:
        float: Затраты на материал/полуфабрикат для одного изделия, руб.
    """
    cost = (norma_rasxoda * price_mat * Ktr - norma_otxoda * price_otxod)
    return cost

def calculate_total_material_costs(components_data, prices, Ktr=1.0, item='A'):
    """
    Расчет общей суммы затрат на все основные материалы и покупные полуфабрикаты
    (включая комплектующие) для одного изделия.

    Args:
        components_data (dict): Словарь с нормами расхода/отходов и фикс. стоимостями.
                                Пример:
                                {
                                    'стальной прокат': {'type': 'material', 'A': {'rasxod': 0.62, 'otxod': 0.1116}, 'B': {...}},
                                    'трубы стальные': {'type': 'material', 'A': {'rasxod': 0.06, 'otxod': 0.0042}, 'B': {...}},
                                    'электромоторы': {'type': 'fixed', 'A': 36000, 'B': 5000},
                                    ...
                                }
        prices (dict): Словарь с ценами на материалы и отходы.
                       Пример:
                       {
                           'стальной прокат_материал': 12800,
                           'стальной прокат_отходы': 7500,
                           ...
                       }
        Ktr (float): Коэффициент транспортно-заготовительных расходов.
        item (str): 'A' или 'B', для какого изделия рассчитываются затраты.

    Returns:
        float: Общие затраты на материалы и полуфабрикаты для одного изделия, руб.
    """
    total_cost = 0.0
    for component_name, component_info in components_data.items():
        comp_type = component_info.get("type", "fixed")
        if comp_type == "material":
            norma_rasxoda = component_info[item]['rasxod']
            norma_otxoda = component_info[item]['otxod']
            price_mat = prices.get(f"{component_name}_материал")
            price_otxod = prices.get(f"{component_name}_отходы")

            if price_mat is None or price_otxod is None:
                print(f"Предупреждение: Цены для '{component_name}' не найдены в 'prices'.")
                continue

            cost = calculate_material_costs(norma_rasxoda, norma_otxoda, price_mat, price_otxod, Ktr)
            total_cost += cost
        else: # comp_type == "fixed"
            fixed_cost = component_info.get(item)
            if fixed_cost is not None:
                total_cost += fixed_cost
            else:
                print(f"Предупреждение: Фиксированная стоимость для '{component_name}' и изделия '{item}' не найдена.")

    return total_cost

def calculate_fuel_energy_costs(total_material_costs_item, fuel_energy_percentage):
    """
    Расчет затрат на топливо и энергию для одного изделия как процент от СУММЫ материальных расходов.
    Формула: Впер = ((Вом + Впф + Вком) * βпер) / (100 - βпер)

    Args:
        total_material_costs_item (float): Общие затраты на все материалы/ПФ/Комплектующие для одного изделия, руб.
        fuel_energy_percentage (float): Процент топлива и энергии от общей суммы материальных расходов.

    Returns:
        float: Затраты на топливо и энергию для одного изделия, руб.
    """
    # Применяем формулу (1.4) из методички
    fuel_energy_cost = (total_material_costs_item * fuel_energy_percentage) / (100 - fuel_energy_percentage)
    return round(fuel_energy_cost, 2)

def calculate_basic_wage(labor_hours, hourly_rate):
    """
    Расчет основной заработной платы для одного изделия по формуле Сосн = t * Т.

    Args:
        labor_hours (float): Суммарная трудоемкость (t), нормо-часов.
        hourly_rate (float): Часовая тарифная ставка (Т), руб/час.

    Returns:
        float: Основная заработная плата для одного изделия, руб.
    """
    wage = labor_hours * hourly_rate
    return round(wage, 2)

def calculate_additional_wage(basic_wage, additional_wage_percentage):
    """
    Расчет дополнительной заработной платы как процент от основной.

    Args:
        basic_wage (float): Основная заработная плата, руб.
        additional_wage_percentage (float): Процент дополнительной зарплаты.

    Returns:
        float: Дополнительная заработная плата, руб.
    """
    additional_wage = basic_wage * (additional_wage_percentage / 100)
    return round(additional_wage, 2)

def calculate_social_contributions(basic_wage, additional_wage, social_percentage):
    """
    Расчет отчислений в фонды социальных мероприятий как процент от (основной + дополнительной) з/п.

    Args:
        basic_wage (float): Основная заработная плата, руб.
        additional_wage (float): Дополнительная заработная плата, руб.
        social_percentage (float): Процент отчислений.

    Returns:
        float: Отчисления в фонды социальных мероприятий, руб.
    """
    social_contributions = (basic_wage + additional_wage) * (social_percentage / 100)
    return round(social_contributions, 2)

def calculate_overhead_costs(base_wage, overhead_percentage):
    """
    Расчет РСЭО, ОПР или ОХР как процент от базы (обычно основной з/п).

    Args:
        base_wage (float): База для расчета (например, основная з/п), руб.
        overhead_percentage (float): Процент расходов (РСЭО, ОПР, ОХР).

    Returns:
        float: Сумма расходов (РСЭО, ОПР или ОХР), руб.
    """
    overhead_cost = base_wage * (overhead_percentage / 100)
    return round(overhead_cost, 2)

def calculate_production_cost(material_costs, fuel_energy, purchased_comp_cost, basic_wage, additional_wage, social_contributions, rsuo_costs, opr_costs, oxr_costs):
    """
    Расчет полной производственной себестоимости единицы изделия.

    Args:
        material_costs (float): Затраты на *все* материалы/ПФ/Комплектующие, руб.
        fuel_energy (float): Затраты на топливо и энергию, руб.
        basic_wage (float): Основная з/п, руб.
        additional_wage (float): Дополнительная з/п, руб.
        social_contributions (float): Отчисления, руб.
        rsuo_costs (float): РСЭО, руб.
        opr_costs (float): ОПР, руб.
        oxr_costs (float): ОХР, руб.

    Returns:
        float: Производственная себестоимость единицы изделия, руб.
    """
    production_cost = (material_costs + purchased_comp_cost + fuel_energy + basic_wage + additional_wage +
                       social_contributions + rsuo_costs + opr_costs + oxr_costs)
    return production_cost

def calculate_selling_cost(production_cost, selling_percentage):
    """
    Расчет внепроизводственных расходов как процент от производственной себестоимости.

    Args:
        production_cost (float): Производственная себестоимость, руб.
        selling_percentage (float): Процент внепроизводственных расходов.

    Returns:
        float: Внепроизводственные расходы, руб.
    """
    selling_cost = production_cost * (selling_percentage / 100)
    return selling_cost

def calculate_full_cost(production_cost, selling_cost):
    """
    Расчет полной (коммерческой) себестоимости единицы изделия.

    Args:
        production_cost (float): Производственная себестоимость, руб.
        selling_cost (float): Внепроизводственные расходы, руб.

    Returns:
        float: Полная себестоимость единицы изделия, руб.
    """
    full_cost = production_cost + selling_cost
    return full_cost

def calculate_opt_price(full_cost, profitability_percentage):
    """
    Расчет оптовой (отпускной) цены на основе полной себестоимости и рентабельности.

    Args:
        full_cost (float): Полная себестоимость, руб.
        profitability_percentage (float): Норматив рентабельности, %.

    Returns:
        float: Оптовая цена, руб.
    """
    opt_price = full_cost * (1 + profitability_percentage / 100)
    return opt_price

def calculate_structure_percentage(item_cost, total_cost):
    """
    Расчет удельного веса (в %) статьи в общей себестоимости.

    Args:
        item_cost (float): Значение статьи (например, на годовой выпуск), тыс. руб.
        total_cost (float): Общая себестоимость (на годовой выпуск), тыс. руб.

    Returns:
        float: Удельный вес статьи, %.
    """
    if total_cost == 0:
        return 0 # Избегаем деления на ноль
    percentage = (item_cost / total_cost) * 100
    return percentage


# --- 3. Создание шаблона вывода ---

def format_cost(value, unit="руб."):
    """Форматирует числовое значение стоимости для вывода."""
    return f"{value:.2f} {unit}"

def format_cost_annual(value):
    """Форматирует числовое значение годовой стоимости для вывода (в руб. и тыс.руб.)."""
    value_thousands = value / 1000
    return f"{value:.2f} руб. = {value_thousands:.2f} тыс.руб."

def format_percentage(value):
    """Форматирует числовое значение процента для вывода."""
    return f"{value:.2f}%"

def calculate_costs_split(data_dict, prices_dict, ktr, item):
    """Вспомогательная функция для разделения расчетов материалов."""
    total_cost = 0.0
    breakdown_parts = []
    for comp_name, comp_info in data_dict.items():
        comp_type = comp_info.get("type", "fixed")
        if comp_type == "material":
             norma_rasxoda = comp_info[item]['rasxod']
             norma_otxoda = comp_info[item]['otxod']
             price_mat = prices_dict.get(f"{comp_name}_материал")
             price_otxod = prices_dict.get(f"{comp_name}_отходы")
             if price_mat is not None and price_otxod is not None:
                 cost_part_val = (norma_rasxoda * price_mat * ktr - norma_otxoda * price_otxod)
                 total_cost += cost_part_val
                 breakdown_parts.append(f"({norma_rasxoda}*{price_mat}*{ktr}-{norma_otxoda}*{price_otxod})")
             else:
                 print(f"Предупреждение: Цены для '{comp_name}' не найдены в 'prices'.")
        else: # comp_type == "fixed"
             fixed_cost = comp_info.get(item)
             if fixed_cost is not None:
                 total_cost += fixed_cost
                 breakdown_parts.append(f"{fixed_cost}")
             else:
                 print(f"Предупреждение: Фиксированная стоимость для '{comp_name}' и изделия '{item}' не найдена.")
    breakdown_str = " + ".join(breakdown_parts)
    return total_cost, breakdown_str

def generate_output_for_item(item_name, Q_base, Ka, Ktr, data_materials, data_prices, data_fuel_energy, data_labor, data_rates):
    """
    Генерирует форматированный текстовый вывод для одного изделия (А или Б)
    по структуре из "Курсовая часть 1.docx".
    """
    output = f"Изделие {item_name}\n"
    Q_corrected = int(Q_base * Ka)

    # --- 1. Основные материалы ---
    output += "1. Основные материалы за вычетом обортных отходов\n"
    output += "Сом = ( Нмi * Цмi * Ктр - Н0i*Ц0i) (1.1)\n"
    output += "где Цмi - цена i -го вида материала, руб / т;\n"
    output += "Ктр - коэффициент, который учитывает транспортно-заготовительные расходы (принимается в интервале значений 1,1 - 1,15);\n"
    output += "Ноi - норма отходов, т;\n"
    output += "Цоi - цена отходов, руб /т;\n"
    output += "m - число наименований материалов.\n"

    # Определяем, что входит в "Основные материалы" (п.1)
    main_materials_names = ["стальной прокат", "трубы стальные", "прокат цветных металлов", "другие материалы"]
    materials_for_main = {k: v for k, v in data_materials.items() if k in main_materials_names}

    # Рассчитываем стоимость основных материалов для единицы
    total_main_mat_cost_unit, breakdown_main = calculate_costs_split(materials_for_main, data_prices, Ktr, item_name)
    total_main_mat_cost_annual = total_main_mat_cost_unit * Q_corrected

    output += f"На единицу:\n"
    output += f"Сом i = {breakdown_main} = {format_cost(total_main_mat_cost_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сом = Сом i * Q = {format_cost(total_main_mat_cost_unit)} * {Q_corrected} = {format_cost_annual(total_main_mat_cost_annual)}\n\n"

    # --- 2. Покупные полуфабрикаты и комплектующие ---
    output += "2. Расходы на покупные полуфабрикаты (СПФ) и комплектующие изделия ( Ском ).\n"
    output += "Расходы на покупные полуфабрикаты рассчитываются по вышеприведенной формуле . Стоимость комплектующих изделий определяется суммированием расходов на приобретение составных частей для производства продукции согласно данным дополнения 3.\n"
    output += "С пф = Σ ( Нмi * Цмi * Ктр - Н0iЦ0i) (1.3)\n"

    # Определяем, что входит в "Покупные ПФ+Комплектующие" (п.2)
    materials_for_purchased = {k: v for k, v in data_materials.items() if k not in main_materials_names}

    # Рассчитываем стоимость ПФ+Комплектующих для единицы
    total_purchased_comp_cost_unit, breakdown_purchased = calculate_costs_split(materials_for_purchased, data_prices, Ktr, item_name)
    total_purchased_comp_cost_annual = total_purchased_comp_cost_unit * Q_corrected

    output += f"На единицу:\n"
    output += f"СПФ+Ском = {breakdown_purchased} = {format_cost(total_purchased_comp_cost_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"( СПФ+Ском ) * Q = {format_cost(total_purchased_comp_cost_unit)} * {Q_corrected} = {format_cost_annual(total_purchased_comp_cost_annual)}\n\n"

    # --- 3. Топливо и энергия ---
    fuel_energy_percentage = data_fuel_energy[item_name]
    # !!! ИСПРАВЛЕНИЕ: Передаем СУММУ всех материальных расходов (основных + ПФ+Комплектующих)
    total_material_costs_unit = round(total_main_mat_cost_unit + total_purchased_comp_cost_unit, 2)
    fuel_energy_unit = calculate_fuel_energy_costs(total_material_costs_unit, fuel_energy_percentage)
    fuel_energy_annual = fuel_energy_unit * Q_corrected

    output += "3. Топливо и энергия на технологические потребности\n"
    output += f"На единицу:\n"
    # Выводим формулу с подстановкой значений
    output += f"Стэ = (Сом + Спф+Ском) * ({fuel_energy_percentage}/(100-{fuel_energy_percentage})) = ({format_cost(total_main_mat_cost_unit)} + {format_cost(total_purchased_comp_cost_unit)}) * {fuel_energy_percentage}/(100-{fuel_energy_percentage}) = {format_cost(fuel_energy_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Стэ = {format_cost(fuel_energy_unit)} * {Q_corrected} = {format_cost_annual(fuel_energy_annual)}\n\n"

    # --- 4. Основная заработная плата ---
    labor_hours = data_labor['labor_hours'][item_name]
    hourly_rate = data_labor['hourly_rate'][item_name]
    basic_wage_unit = calculate_basic_wage(labor_hours, hourly_rate)
    basic_wage_annual = basic_wage_unit * Q_corrected

    output += "4. Основная заработная плата производственных рабочих\n"
    output += f"На единицу:\n"
    output += f"Сосн = t * Т = {labor_hours} * {hourly_rate} = {format_cost(basic_wage_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сосн = {format_cost(basic_wage_unit)} * {Q_corrected} = {format_cost_annual(basic_wage_annual)}\n\n"

    # --- 5. Дополнительная заработная плата ---
    additional_wage_percentage = data_rates["доп_зарплата"]
    additional_wage_unit = calculate_additional_wage(basic_wage_unit, additional_wage_percentage)
    additional_wage_annual = additional_wage_unit * Q_corrected

    output += "5. Дополнительная заработная плата производственных рабочих\n"
    output += f"На единицу:\n"
    output += f"Сдоп = Сосн * ({additional_wage_percentage}/100) = {format_cost(basic_wage_unit)} * {additional_wage_percentage/100} = {format_cost(additional_wage_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сдоп = {format_cost(additional_wage_unit)} * {Q_corrected} = {format_cost_annual(additional_wage_annual)}\n\n"

    # --- 6. Отчисления в фонды социальных мероприятий ---
    social_percentage = data_rates["отчисления"]
    social_contributions_unit = calculate_social_contributions(basic_wage_unit, additional_wage_unit, social_percentage)
    social_contributions_annual = social_contributions_unit * Q_corrected

    output += "6. Отчисление в фонды социальных мероприятий\n"
    output += f"На единицу:\n"
    output += f"Ссоц = (Сосн + Сдоп) * ({social_percentage}/100) = ({format_cost(basic_wage_unit, '')} + {format_cost(additional_wage_unit, '')}) * {social_percentage/100} = {format_cost(social_contributions_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Ссоц = {format_cost(social_contributions_unit)} * {Q_corrected} = {format_cost_annual(social_contributions_annual)}\n\n"

    # --- 7. РСЭО ---
    rsuo_percentage = data_rates["РСЭО"]
    rsuo_unit = calculate_overhead_costs(basic_wage_unit, rsuo_percentage)
    rsuo_annual = rsuo_unit * Q_corrected

    output += "7. Расходы на содержание и эксплуатацию оборудования\n"
    output += f"На единицу:\n"
    output += f"Рсэо = Сосн * ({rsuo_percentage}/100) = {format_cost(basic_wage_unit)} * {rsuo_percentage/100} = {format_cost(rsuo_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Рсэо = {format_cost(rsuo_unit)} * {Q_corrected} = {format_cost_annual(rsuo_annual)}\n\n"

    # --- 8. ОПР ---
    opr_percentage = data_rates["ОПР"]
    opr_unit = calculate_overhead_costs(basic_wage_unit, opr_percentage)
    opr_annual = opr_unit * Q_corrected

    output += "8. Общепроизводственные расходы\n"
    output += f"На единицу:\n"
    output += f"Роп = Сосн * ({opr_percentage}/100) = {format_cost(basic_wage_unit)} * {opr_percentage/100} = {format_cost(opr_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Роп = {format_cost(opr_unit)} * {Q_corrected} = {format_cost_annual(opr_annual)}\n\n"

    # --- 9. ОХР ---
    oxr_percentage = data_rates["ОХР"]
    oxr_unit = calculate_overhead_costs(basic_wage_unit, oxr_percentage)
    oxr_annual = oxr_unit * Q_corrected

    output += "9. Общехозяйственные расходы\n"
    output += f"На единицу:\n"
    output += f"Рох = Сосн * ({oxr_percentage}/100) = {format_cost(basic_wage_unit)} * {oxr_percentage/100} = {format_cost(oxr_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Рох = {format_cost(oxr_unit)} * {Q_corrected} = {format_cost_annual(oxr_annual)}\n\n"

    # --- Производственная себестоимость ---
    production_cost_unit = calculate_production_cost(
        total_material_costs_unit,  total_purchased_comp_cost_unit, fuel_energy_unit, basic_wage_unit,
        additional_wage_unit, social_contributions_unit, rsuo_unit, opr_unit, oxr_unit
    )
    production_cost_annual = production_cost_unit * Q_corrected

    output += "ВСЕГО производственная себестоимость\n"
    output += f"На единицу:\n"
    output += f"Спр = Сом + (Спф+Ском) + Впер + Сосн + Сдоп + Ссоц + Рсэо + Роп + Рох = {format_cost(total_material_costs_unit)} + {fuel_energy_unit:.2f} + {basic_wage_unit:.2f} + {additional_wage_unit:.2f} + {social_contributions_unit:.2f} + {rsuo_unit:.2f} + {opr_unit:.2f} + {oxr_unit:.2f} = {format_cost(production_cost_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Спр = {format_cost(production_cost_unit)} * {Q_corrected} = {format_cost_annual(production_cost_annual)}\n\n"

    # --- 10. Внепроизводственные расходы ---
    selling_percentage = data_rates["ВПР"]
    selling_cost_unit = calculate_selling_cost(production_cost_unit, selling_percentage)
    selling_cost_annual = selling_cost_unit * Q_corrected

    output += "10. Внепроизводственные расходы\n"
    output += f"На единицу:\n"
    output += f"Свп = Спр * ({selling_percentage}/100) = {format_cost(production_cost_unit)} * {selling_percentage/100} = {format_cost(selling_cost_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Свп = {format_cost(selling_cost_unit)} * {Q_corrected} = {format_cost_annual(selling_cost_annual)}\n\n"

    # --- Полная себестоимость ---
    full_cost_unit = calculate_full_cost(production_cost_unit, selling_cost_unit)
    full_cost_annual = full_cost_unit * Q_corrected

    output += "ВСЕГО полная (коммерческая) себестоимость\n"
    output += f"На единицу:\n"
    output += f"Сп = Спр + Свп = {production_cost_unit:.2f} + {selling_cost_unit:.2f} = {format_cost(full_cost_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сп = {format_cost(full_cost_unit)} * {Q_corrected} = {format_cost_annual(full_cost_annual)}\n\n"

    # --- 11. Прибыль ---
    profitability_percentage = data_rates["рентабельность"]
    profit_unit = calculate_profit(full_cost_unit, profitability_percentage)
    profit_annual = profit_unit * Q_corrected

    output += f"11. Прибыль\n"
    output += f"На единицу:\n"
    output += f"П = Сп * ({profitability_percentage}/100) = {format_cost(full_cost_unit)} * {profitability_percentage / 100} = {format_cost(profit_unit)}\n"
    output += f"На годовой выпуск:\n"
    output += f"П = {format_cost(profit_unit)} * {Q_corrected} = {format_cost_annual(profit_annual)}\n\n"

    # --- 12. Оптовая цена ---
    opt_price = calculate_opt_price(full_cost_unit, profit_unit)

    output += f"12. Оптовая (отпускная) цена\n"
    output += f"Цопт = Сп + П = {format_cost(full_cost_unit)} + {format_cost(profit_unit)} = {format_cost(opt_price)}\n\n"


    # --- Структура себестоимости (для таблицы) ---
    structure_data = {
        "Наименование": item_name,
        "Единица_Сом": total_main_mat_cost_unit, "Годовой_Сом": total_main_mat_cost_annual,
        "Единица_Спф_Ском": total_purchased_comp_cost_unit, "Годовой_Спф_Ском": total_purchased_comp_cost_annual,
        "Единица_Стэ": fuel_energy_unit, "Годовой_Стэ": fuel_energy_annual,
        "Единица_Сосн": basic_wage_unit, "Годовой_Сосн": basic_wage_annual,
        "Единица_Сдоп": additional_wage_unit, "Годовой_Сдоп": additional_wage_annual,
        "Единица_Ссоц": social_contributions_unit, "Годовой_Ссоц": social_contributions_annual,
        "Единица_Рсэо": rsuo_unit, "Годовой_Рсэо": rsuo_annual,
        "Единица_Роп": opr_unit, "Годовой_Роп": opr_annual,
        "Единица_Рох": oxr_unit, "Годовой_Рох": oxr_annual,
        "Единица_Спр": production_cost_unit, "Годовой_Спр": production_cost_annual,
        "Единица_Свп": selling_cost_unit, "Годовой_Свп": selling_cost_annual,
        "Единица_Сп": full_cost_unit, "Годовой_Сп": full_cost_annual,
        "Единица_Прибыль": profit_unit, "Годовой_Прибыль": profit_annual,  # Добавляем прибыль
        "Оптовая_цена": opt_price,
        "Q": Q_corrected
    }

    details = {
        'breakdown_main': breakdown_main,
        'breakdown_purchased': breakdown_purchased,
        'fuel_energy_percentage': fuel_energy_percentage,
        'labor_hours': labor_hours,
        'hourly_rate': hourly_rate
    }

    return output, structure_data, details

def generate_structure_table_csv(structure_data_A, structure_data_B):
    """Генерирует итоговую таблицу структуры себестоимости в формате CSV."""
    output = io.StringIO() # Используем StringIO как "файл в памяти"
    writer = csv.writer(output, delimiter=';', quoting=csv.QUOTE_MINIMAL)

    # Определяем заголовки
    headers = [
        "Наименование статей расходов",
        "Изделие А на единицу, руб",
        "Изделие А на годовой выпуск, тыс.руб.",
        "Изделие Б на единицу, руб",
        "Изделие Б на годовой выпуск, тыс.руб.",
        "Себестоимость годового выпуска продукции, тыс.руб.",
        "Структура расходов,%"
    ]

    writer.writerow(headers)

    # Общая годовая себестоимость для расчета структуры
    total_A_annual = structure_data_A["Годовой_Сп"] / 1000 # в тыс.руб
    total_B_annual = structure_data_B["Годовой_Сп"] / 1000 # в тыс.руб
    total_combined_annual = total_A_annual + total_B_annual

    # Данные для строк таблицы
    rows = [
        ("1. Основные материалы за вычетом возвратных отходов", "Единица_Сом", "Годовой_Сом"),
        ("2. Покупные полуфабрикаты и комплектующие изделия", "Единица_Спф_Ском", "Годовой_Спф_Ском"),
        ("3. Топливо и энергия на технологические потребности", "Единица_Стэ", "Годовой_Стэ"),
        ("4. Основная заработная плата производственных рабочих", "Единица_Сосн", "Годовой_Сосн"),
        ("5. Дополнительная заработная плата производственных рабочих", "Единица_Сдоп", "Годовой_Сдоп"),
        ("6. Отчисление в фонды социальных мероприятий", "Единица_Ссоц", "Годовой_Ссоц"),
        ("7. Расходы по содержанию и эксплуатации оборудования", "Единица_Рсэо", "Годовой_Рсэо"),
        ("8. Общепроизводственные расходы", "Единица_Роп", "Годовой_Роп"),
        ("9. Общехозяйственные расходы", "Единица_Рох", "Годовой_Рох"),
        ("ВСЕГО производственная себестоимость", "Единица_Спр", "Годовой_Спр"),
        ("10. Внепроизводственные расходы", "Единица_Свп", "Годовой_Свп"),
        ("ВСЕГО полная (коммерческая) себестоимость", "Единица_Сп", "Годовой_Сп"),
        ("11. Прибыль", "Единица_Прибыль", "Годовой_Прибыль"), # Добавляем строку "Прибыль"
        ("12. Оптовая (отпускная) цена", "Оптовая_цена", None) # Для оптовой цены нет годового выпуска
    ]

    for row_name, unit_key, annual_key in rows:
        # Значения для изделия А
        a_unit_val = structure_data_A[unit_key]
        if annual_key is not None:
            a_annual_val = structure_data_A[annual_key] / 1000 # в тыс.руб
        else:
            a_annual_val = None

        # Значения для изделия Б
        b_unit_val = structure_data_B[unit_key]
        if annual_key is not None:
            b_annual_val = structure_data_B[annual_key] / 1000 # в тыс.руб
        else:
            b_annual_val = None

        # Сумма годового выпуска для этой строки (А + Б)
        combined_annual_val = None
        if annual_key is not None:
            combined_annual_val = (structure_data_A[annual_key] + structure_data_B[annual_key]) / 1000 # в тыс.руб

        # Удельный вес (структура расходов) - рассчитывается от общей себестоимости ВСЕЙ НОМЕНКЛАТУРЫ
        perc_combined = 0
        if annual_key is not None and total_combined_annual > 0: # Только для статей с годовым значением и если общая себестоимость > 0
            perc_combined = calculate_structure_percentage(combined_annual_val, total_combined_annual) # combined_annual_val уже в тыс.руб
        elif annual_key is None: # Для строки "Оптовая цена" структура не рассчитывается
             perc_combined = "" # или оставить пустым

        # Формируем строку данных
        row_data = [
            row_name,
            f"{a_unit_val:.2f}",
            f"{a_annual_val:.2f}" if a_annual_val is not None else "",
            f"{b_unit_val:.2f}",
            f"{b_annual_val:.2f}" if b_annual_val is not None else "",
            f"{combined_annual_val:.2f}" if combined_annual_val is not None else "",
            f"{perc_combined:.2f}%" if isinstance(perc_combined, (int, float)) else perc_combined # Форматируем процент, если это число
        ]

        writer.writerow(row_data)

    csv_content = output.getvalue()
    output.close()
    return csv_content

def prepare_data_with_coefficients(data_materials, data_labor, data_volume_base, Ka, Kj):
    """
    Подготавливает данные, применяя коэффициенты Kj и Ka.
    Kj применяется к нормам расхода/отходов и трудоемкости.
    Ka применяется к базовому объему.
    """
    import copy
    prepared_materials = copy.deepcopy(data_materials)
    prepared_labor = copy.deepcopy(data_labor)
    prepared_volume = {k: v * Ka for k, v in data_volume_base.items()} # Только Ka к объему

    # Применяем Kj к нормам расхода и отходов
    # for comp_name, comp_info in prepared_materials.items():
    #     if isinstance(comp_info, dict) and 'rasxod' in comp_info:
    #         for item in ['A', 'B']:
    #             if item in comp_info:
    #                 comp_info[item]['rasxod'] *= Kj
    #                 comp_info[item]['otxod'] *= Kj

    # Применяем Kj к трудоемкости
    for item in ['A', 'B']:
        if item in prepared_labor['labor_hours']:
            prepared_labor['labor_hours'][item] *= Kj

    return prepared_materials, prepared_labor, prepared_volume

def generate_full_output(Q_base_data, Ka, Kj, Ktr, materials_main, materials_purchased, prices, fuel_energy, labor, rates):
    """
    Основная функция для генерации полного вывода расчета для изделий А и Б.
    """
    # Подготовка данных с учетом Kj (и Ka для объема)
    prepared_materials_main, prepared_labor, prepared_volume = prepare_data_with_coefficients(
        materials_main, labor, Q_base_data, Ka, Kj
    )
    prepared_materials_purchased, _, _ = prepare_data_with_coefficients(
        materials_purchased, {"labor_hours": {"A": 1, "B": 1}}, {"A": 1, "B": 1}, 1, Kj
    )
    # Объединяем подготовленные материалы
    combined_materials = {**prepared_materials_main, **prepared_materials_purchased}

    output = "1.1 Расчет себестоимости и цены изделий\n\n"
    structure_data_A = None
    structure_data_B = None
    details_A = None
    details_B = None

    for item in ['A', 'B']:
        Q_item = prepared_volume[item] # Используем подготовленный объем
        item_output, item_structure, item_details = generate_output_for_item(  # Изменено: принимаем три значения
            item, Q_item, 1, Ktr, # Ka=1, потому что объем Q_item уже скорректирован
            combined_materials, prices, fuel_energy, prepared_labor, rates
        )
        output += item_output
        if item == 'A':
            structure_data_A = item_structure
            details_A = item_details
        else:
            structure_data_B = item_structure
            details_B = item_details

    # Генерация таблицы структуры
    # if structure_data_A and structure_data_B:
    #     output += generate_structure_table_csv(structure_data_A, structure_data_B)

    return output, structure_data_A, structure_data_B, details_A, details_B  # Изменено: возвращаем пять значений



def calculate_profit(full_cost, profitability_percentage):
    """
    Расчет прибыли как процент от полной себестоимости.

    Args:
        full_cost (float): Полная себестоимость единицы изделия, руб.
        profitability_percentage (float): Норматив рентабельности, %.

    Returns:
        float: Прибыль на единицу изделия, руб.
    """
    profit = full_cost * (profitability_percentage / 100)
    return profit


def calculate_opt_price(full_cost, profit):
    """
    Расчет оптовой (отпускной) цены как сумма полной себестоимости и прибыли.

    Args:
        full_cost (float): Полная себестоимость единицы изделия, руб.
        profit (float): Прибыль на единицу изделия, руб.

    Returns:
        float: Оптовая цена, руб.
    """
    opt_price = full_cost + profit
    return opt_price


def calculate_product_volumes(structure_data_A, structure_data_B):
    """
    Рассчитывает объем товарной и реализованной продукции.
    Использует данные из structure_data_A и structure_data_B.
    """
    # Годовые объемы выпуска
    Q_A = structure_data_A["Q"]
    Q_B = structure_data_B["Q"]

    # Оптовые цены
    price_A = structure_data_A["Оптовая_цена"]
    price_B = structure_data_B["Оптовая_цена"]

    # Объем товарной продукции (Qт)
    Q_t = (Q_A * price_A + Q_B * price_B) / 1000 # в тыс.руб

    # Объем реализованной продукции (Qр)
    # Qн = 2% от Qт
    # Qк = 1.5% от Qт
    Q_n = Q_t * 0.02
    Q_k = Q_t * 0.015
    Q_p = Q_n + Q_t - Q_k

    return Q_t, Q_p, Q_A, Q_B, price_A, price_B


def generate_input_table_csv(materials_main, materials_purchased, prices, fuel_energy, labor, rates, volume_base, Ka, Kj, Ktr):
    """
    Генерирует CSV строку для Таблицы 1 (Исходные данные)
    """
    output = io.StringIO()
    writer = csv.writer(output, delimiter=';', quoting=csv.QUOTE_MINIMAL)

    # Заголовок таблицы
    writer.writerow(["№", "Показатели", "Номер дополнения", "Ед. измерения", "Изделие А", "Изделие Б"])

    # --- Структура данных для сопоставления ---
    # Сопоставляем названия из ваших словарей с описанием из таблицы методички
    # Формат: ("Описание из таблицы", "Ед. изм.", "Номер дополнения", "Ключ для A", "Ключ для B")
    # Для материалов с типом "material", ключ - это кортеж (значение_расхода, значение_отходов)
    # Для материалов с типом "fixed", ключ - это просто значение
    # Цены, топливо/энергия, трудоемкость, ставки, проценты, объемы - отдельно

    # 1. Основные материалы
    writer.writerow(["1", "Основные материалы", "2", "", "", ""])
    writer.writerow(["1.1", "Стальной прокат:", "", "", "", ""])
    steel_data = materials_main.get("стальной прокат", {})
    writer.writerow(["", "- расходы", "", "т", steel_data.get("A", {}).get("rasxod", ""), steel_data.get("B", {}).get("rasxod", "")])
    writer.writerow(["", "- отходы", "", "т", steel_data.get("A", {}).get("otxod", ""), steel_data.get("B", {}).get("otxod", "")])

    writer.writerow(["1.2", "Трубы стальные:", "", "", "", ""])
    pipes_data = materials_main.get("трубы стальные", {})
    writer.writerow(["", "- расходы", "", "т", pipes_data.get("A", {}).get("rasxod", ""), pipes_data.get("B", {}).get("rasxod", "")])
    writer.writerow(["", "- отходы", "", "т", pipes_data.get("A", {}).get("otxod", ""), pipes_data.get("B", {}).get("otxod", "")])

    writer.writerow(["1.3", "Прокат цветных металлов", "", "руб", materials_main.get("прокат цветных металлов", {}).get("A"), materials_main.get("прокат цветных металлов", {}).get("B")])
    writer.writerow(["1.4", "Другие материалы", "", "руб", materials_main.get("другие материалы", {}).get("A"), materials_main.get("другие материалы", {}).get("B")])

    # 2. Покупные полуфабрикаты (отливки)
    writer.writerow(["2", "Покупные полуфабрикаты (отливки):", "2", "", "", ""])
    writer.writerow(["2.1", "черных металлов", "", "", "", ""])
    cast_iron_data = materials_purchased.get("отливки черных металлов", {})
    writer.writerow(["", "- расходы", "", "т", cast_iron_data.get("A", {}).get("rasxod", ""), cast_iron_data.get("B", {}).get("rasxod", "")])
    writer.writerow(["", "- отходы", "", "т", cast_iron_data.get("A", {}).get("otxod", ""), cast_iron_data.get("B", {}).get("otxod", "")])

    writer.writerow(["2.2", "цветных металлов", "", "", "", ""])
    cast_alloy_data = materials_purchased.get("отливки цветных металлов", {})
    writer.writerow(["", "- расходы", "", "т", cast_alloy_data.get("A", {}).get("rasxod", ""), cast_alloy_data.get("B", {}).get("rasxod", "")])
    writer.writerow(["", "- отходы", "", "т", cast_alloy_data.get("A", {}).get("otxod", ""), cast_alloy_data.get("B", {}).get("otxod", "")])

    # 3. Покупные комплектующие изделия
    writer.writerow(["3", "покупные комплектующие изделия", "3", "руб", materials_purchased.get("покупные комплектующие изделия", {}).get("A"), materials_purchased.get("покупные комплектующие изделия", {}).get("B")])

    # 4. Цены
    writer.writerow(["4", "Цена стального проката", "4", "руб /т", prices.get("стальной прокат_материал"), prices.get("стальной прокат_материал")])
    writer.writerow(["5", "Цена стальных труб", "4", "руб /т", prices.get("трубы стальные_материал"), prices.get("трубы стальные_материал")])
    writer.writerow(["6", "Цена отливок:", "4", "", "", ""])
    writer.writerow(["", "-черных металлов", "", "руб /т", prices.get("отливки черных металлов_материал"), prices.get("отливки черных металлов_материал")])
    writer.writerow(["", "-цветных металлов", "", "руб /т", prices.get("отливки цветных металлов_материал"), prices.get("отливки цветных металлов_материал")])

    # 7. Цены отходов
    writer.writerow(["7", "Цена отходов:", "4", "", "", ""])
    writer.writerow(["", "-стального проката", "", "руб /т", prices.get("стальной прокат_отходы"), prices.get("стальной прокат_отходы")])
    writer.writerow(["", "-труб стальных", "", "руб /т", prices.get("трубы стальные_отходы"), prices.get("трубы стальные_отходы")])
    writer.writerow(["", "-отливок черных металлов", "", "руб /т", prices.get("отливки черных металлов_отходы"), prices.get("отливки черных металлов_отходы")])
    writer.writerow(["", "-отливок цветных металлов", "", "руб /т", prices.get("отливки цветных металлов_отходы"), prices.get("отливки цветных металлов_отходы")])

    # 8. Топливо и энергия
    writer.writerow(["8", "Топливо и энергия на технологические потребности", "5", "%", fuel_energy.get("A"), fuel_energy.get("B")])

    # 9. Суммарная трудоемкость
    writer.writerow(["9", "Суммарная трудоемкость изделия", "6", "н-час", round(labor.get("labor_hours", {}).get("A") * Kj, 3), round(labor.get("labor_hours", {}).get("B") * Kj, 3)])

    # 10. Часовая тарифная ставка
    writer.writerow(["10", "Часовая тарифная ставка", "6", "руб", labor.get("hourly_rate", {}).get("A"), labor.get("hourly_rate", {}).get("B")])

    # 11. Дополнительная зарплата
    writer.writerow(["11", "Дополнительная зарплата", "7", "%", rates.get("доп_зарплата"), rates.get("доп_зарплата")])

    # 12. Отчисление на социальное страхование
    writer.writerow(["12", "Отчисление на социальное страхование", "7", "%", rates.get("отчисления"), rates.get("отчисления")])

    # 13. РСЭО
    writer.writerow(["13", "Расходы на содержание и эксплуатацию оборудования", "7", "%", rates.get("РСЭО"), rates.get("РСЭО")])

    # 14. ОПР
    writer.writerow(["14", "Общепроизводственные расходы", "7", "%", rates.get("ОПР"), rates.get("ОПР")])

    # 15. ОХР
    writer.writerow(["15", "Общехозяйственные расходы", "7", "%", rates.get("ОХР"), rates.get("ОХР")])

    # 16. ВПР
    writer.writerow(["16", "Внепроизводственные расходы", "7", "%", rates.get("ВПР"), rates.get("ВПР")])

    # 17. Норматив рентабельности
    writer.writerow(["17", "Норматив рентабельности к себестоимости", "7", "%", rates.get("рентабельность"), rates.get("рентабельность")])

    # 18. Годовой объем производства (базовый)
    writer.writerow(["18", "Годовой объем производства", "1", "шт", int(volume_base.get("A") * Ka), int(volume_base.get("B") * Ka)])

    csv_content = output.getvalue()
    output.close()
    return csv_content


def save_structure_table_to_json(structure_data_A, structure_data_B, filename="sebestoimost_structure.json"):
    """
    Сохраняет итоговую таблицу структуры себестоимости в формате JSON.

    Args:
        structure_data_A (dict): Словарь с данными для изделия А (из generate_output_for_item).
        structure_data_B (dict): Словарь с данными для изделия Б (из generate_output_for_item).
        filename (str): Имя файла для сохранения JSON (по умолчанию "sebestoimost_structure.json").
    """
    # Общая годовая себестоимость для расчета структуры
    total_A_annual = structure_data_A["Годовой_Сп"] / 1000 # в тыс.руб
    total_B_annual = structure_data_B["Годовой_Сп"] / 1000 # в тыс.руб
    total_combined_annual = total_A_annual + total_B_annual

    # Данные для строк таблицы
    rows = [
        ("1. Основные материалы за вычетом возвратных отходов", "Единица_Сом", "Годовой_Сом"),
        ("2. Покупные полуфабрикаты и комплектующие изделия", "Единица_Спф_Ском", "Годовой_Спф_Ском"),
        ("3. Топливо и энергия на технологические потребности", "Единица_Стэ", "Годовой_Стэ"),
        ("4. Основная заработная плата производственных рабочих", "Единица_Сосн", "Годовой_Сосн"),
        ("5. Дополнительная заработная плата производственных рабочих", "Единица_Сдоп", "Годовой_Сдоп"),
        ("6. Отчисление в фонды социальных мероприятий", "Единица_Ссоц", "Годовой_Ссоц"),
        ("7. Расходы по содержанию и эксплуатации оборудования", "Единица_Рсэо", "Годовой_Рсэо"),
        ("8. Общепроизводственные расходы", "Единица_Роп", "Годовой_Роп"),
        ("9. Общехозяйственные расходы", "Единица_Рох", "Годовой_Рох"),
        ("ВСЕГО производственная себестоимость", "Единица_Спр", "Годовой_Спр"),
        ("10. Внепроизводственные расходы", "Единица_Свп", "Годовой_Свп"),
        ("ВСЕГО полная (коммерческая) себестоимость", "Единица_Сп", "Годовой_Сп"),
        ("11. Прибыль", "Единица_Прибыль", "Годовой_Прибыль"),
        ("12. Оптовая (отпускная) цена", "Оптовая_цена", None) # Для оптовой цены нет годового выпуска
    ]

    # Список для хранения данных JSON
    json_data = []

    for row_name, unit_key, annual_key in rows:
        # Значения для изделия А
        a_unit_val = structure_data_A[unit_key]
        if annual_key is not None:
            a_annual_val = structure_data_A[annual_key] / 1000 # в тыс.руб
        else:
            a_annual_val = None

        # Значения для изделия Б
        b_unit_val = structure_data_B[unit_key]
        if annual_key is not None:
            b_annual_val = structure_data_B[annual_key] / 1000 # в тыс.руб
        else:
            b_annual_val = None

        # Сумма годового выпуска для этой строки (А + Б)
        combined_annual_val = None
        if annual_key is not None:
            combined_annual_val = (structure_data_A[annual_key] + structure_data_B[annual_key]) / 1000 # в тыс.руб

        # Удельный вес (структура расходов) - рассчитывается от общей себестоимости ВСЕЙ НОМЕНКЛАТУРЫ
        perc_combined = 0
        if annual_key is not None and total_combined_annual > 0: # Только для статей с годовым значением и если общая себестоимость > 0
            # Используем вашу функцию calculate_structure_percentage
            perc_combined = calculate_structure_percentage(combined_annual_val, total_combined_annual) # combined_annual_val уже в тыс.руб
        elif annual_key is None: # Для строки "Оптовая цена" структура не рассчитывается
             perc_combined = None # или оставить пустым

        # Формируем словарь данных JSON
        row_data_json = {
            "Наименование статей расходов": row_name,
            "Изделие А на единицу, руб": round(a_unit_val, 2),
            "Изделие А на годовой выпуск, тыс.руб.": round(a_annual_val, 2) if a_annual_val is not None else None,
            "Изделие Б на единицу, руб": round(b_unit_val, 2),
            "Изделие Б на годовой выпуск, тыс.руб.": round(b_annual_val, 2) if b_annual_val is not None else None,
            "Себестоимость годового выпуска продукции, тыс.руб.": round(combined_annual_val, 2) if combined_annual_val is not None else None,
            "Структура расходов,%": round(perc_combined, 2) if isinstance(perc_combined, (int, float)) else None
        }
        json_data.append(row_data_json)

    # Сохранение JSON
    with open(filename, 'w', encoding='utf-8') as jsonfile:
        json.dump(json_data, jsonfile, indent=4, ensure_ascii=False) # indent для красивого форматирования, ensure_ascii=False для кириллицы

    print(f"\nJSON таблица структуры себестоимости сохранена в файл: {filename}")


def csv_to_json_structure(csv_path: str) -> List[Dict[str, Any]]:
    """
    Преобразует CSV-файл с иерархической таблицей в список словарей.
    Каждая строка с данными → словарь с иерархическими ключами.
    """
    result = []
    context = {}  # main, sub

    with open(csv_path, encoding='utf-8') as f:
        reader = csv.reader(f, delimiter=';')

        for row in reader:
            # Пропускаем полностью пустые строки
            if not any(cell.strip() for cell in row):
                continue

            # Заполняем недостающие поля
            row += [''] * (6 - len(row))
            num, indicator, addition_num, unit, item_a, item_b = [cell.strip() for cell in row]

            # Пропускаем пустые значения
            if not indicator and not item_a and not item_b:
                continue

            # --- Определяем тип строки ---
            if indicator.startswith('- '):
                # Подпункт: расходы / отходы
                if 'main' not in context or 'sub' not in context:
                    continue  # защита от ошибок
                sub_type = indicator[2:].strip()
                entry = {
                    "№": num,
                    "Показатель": context['main'],
                    "Подкатегория": context['sub'],
                    "Тип": sub_type,
                    "Дополнение": addition_num,
                    "Ед. измерения": unit or None,
                    "Изделие А": item_a or None,
                    "Изделие Б": item_b or None
                }
                if item_a or item_b:
                    result.append(entry)

            elif '.' in num and num.strip().endswith('.'):
                # Подраздел: 1.1, 1.2 и т.д.
                context['sub'] = indicator
            elif num.isdigit() or (num and not indicator.startswith('-')) and not num.endswith('.'):
                # Основной раздел: 1, 2, 3...
                if indicator:
                    context['main'] = indicator
                    context.pop('sub', None)
                # Для строк верхнего уровня (например, покупные изделия)
                if item_a or item_b:
                    entry = {
                        "№": num,
                        "Показатель": indicator,
                        "Дополнение": addition_num,
                        "Ед. измерения": unit or None,
                        "Изделие А": item_a or None,
                        "Изделие Б": item_b or None
                    }
                    result.append(entry)
            # Иначе — заголовок или пусто, пропускаем

    return result

# --- Пример вызова функции в конце вашего основного скрипта ---
# (Предполагается, что structure_data_A и structure_data_B уже получены)
# structure_data_A = ...
# structure_data_B = ...
# save_structure_table_to_json(structure_data_A, structure_data_B)

def generate_output_by_punkt(structure_data_A, structure_data_B, data_A_details, data_B_details, rates):
    """
    Генерирует форматированный текстовый вывод, сгруппированный по пунктам
    с расчетами для обоих изделий А и Б в каждом пункте
    """
    output = ""

    # --- 1. Основные материалы ---
    output += "1. Основные материалы за вычетом оборотных отходов\n"
    output += "Сом = ( Нмi * Цмi * Ктр - Н0i*Ц0i) (1.1)\n"
    output += "где Цмi - цена i -го вида материала, руб / т;\n"
    output += "Ктр - коэффициент, который учитывает транспортно-заготовительные расходы (принимается в интервале значений 1,1 - 1,15);\n"
    output += "Ноi - норма отходов, т;\n"
    output += "Цоi - цена отходов, руб /т;\n"
    output += "m - число наименований материалов.\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Сом i = {data_A_details['breakdown_main']} = {format_cost(structure_data_A['Единица_Сом'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сом = Сом i * Q = {format_cost(structure_data_A['Единица_Сом'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Сом'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Сом i = {data_B_details['breakdown_main']} = {format_cost(structure_data_B['Единица_Сом'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сом = Сом i * Q = {format_cost(structure_data_B['Единица_Сом'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Сом'])}\n\n"

    # --- 2. Покупные полуфабрикаты и комплектующие ---
    output += "2. Расходы на покупные полуфабрикаты (СПФ) и комплектующие изделия ( Ском ).\n"
    output += "Расходы на покупные полуфабрикаты рассчитываются по вышеприведенной формуле . Стоимость комплектующих изделий определяется суммированием расходов на приобретение составных частей для производства продукции согласно данным дополнения 3.\n"
    output += "С пф = Σ ( Нмi * Цмi * Ктр - Н0iЦ0i) (1.3)\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"СПФ+Ском = {data_A_details['breakdown_purchased']} = {format_cost(structure_data_A['Единица_Спф_Ском'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"( СПФ+Ском ) * Q = {format_cost(structure_data_A['Единица_Спф_Ском'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Спф_Ском'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"СПФ+Ском = {data_B_details['breakdown_purchased']} = {format_cost(structure_data_B['Единица_Спф_Ском'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"( СПФ+Ском ) * Q = {format_cost(structure_data_B['Единица_Спф_Ском'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Спф_Ском'])}\n\n"

    # --- 3. Топливо и энергия ---
    output += "3. Топливо и энергия на технологические потребности\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Стэ = (Сом + Спф+Ском) * ({data_A_details['fuel_energy_percentage']}/(100-{data_A_details['fuel_energy_percentage']})) = ({format_cost(structure_data_A['Единица_Сом'])} + {format_cost(structure_data_A['Единица_Спф_Ском'])}) * {data_A_details['fuel_energy_percentage']}/(100-{data_A_details['fuel_energy_percentage']}) = {format_cost(structure_data_A['Единица_Стэ'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Стэ = {format_cost(structure_data_A['Единица_Стэ'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Стэ'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Стэ = (Сом + Спф+Ском) * ({data_B_details['fuel_energy_percentage']}/(100-{data_B_details['fuel_energy_percentage']})) = ({format_cost(structure_data_B['Единица_Сом'])} + {format_cost(structure_data_B['Единица_Спф_Ском'])}) * {data_B_details['fuel_energy_percentage']}/(100-{data_B_details['fuel_energy_percentage']}) = {format_cost(structure_data_B['Единица_Стэ'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Стэ = {format_cost(structure_data_B['Единица_Стэ'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Стэ'])}\n\n"

    # --- 4. Основная заработная плата ---
    output += "4. Основная заработная плата производственных рабочих (Сосн.)\n"
    output += "Сосн = t * Т (1.5)\n"
    output += "где t - часовая тарифная ставка среднего разряда работ по изделию, руб;\n"
    output += "Т - суммарная трудоемкость единицы продукции, нормо-часов.\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Сосн = {data_A_details['labor_hours']} * {data_A_details['hourly_rate']} = {format_cost(structure_data_A['Единица_Сосн'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сосн = {format_cost(structure_data_A['Единица_Сосн'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Сосн'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Сосн = {data_B_details['labor_hours']} * {data_B_details['hourly_rate']} = {format_cost(structure_data_B['Единица_Сосн'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сосн = {format_cost(structure_data_B['Единица_Сосн'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Сосн'])}\n\n"

    # --- 5. Дополнительная заработная плата ---
    output += "5. Дополнительная заработная плата производственных рабочих\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Сдоп = Сосн * ({rates['доп_зарплата']}/100) = {format_cost(structure_data_A['Единица_Сосн'])} * {rates['доп_зарплата'] / 100} = {format_cost(structure_data_A['Единица_Сдоп'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сдоп = {format_cost(structure_data_A['Единица_Сдоп'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Сдоп'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Сдоп = Сосн * ({rates['доп_зарплата']}/100) = {format_cost(structure_data_B['Единица_Сосн'])} * {rates['доп_зарплата'] / 100} = {format_cost(structure_data_B['Единица_Сдоп'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сдоп = {format_cost(structure_data_B['Единица_Сдоп'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Сдоп'])}\n\n"

    # --- 6. Отчисления в фонды социальных мероприятий ---
    output += "6. Отчисление в фонды социальных мероприятий\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Ссоц = (Сосн + Сдоп) * ({rates['отчисления']}/100) = ({format_cost(structure_data_A['Единица_Сосн'], '')} + {format_cost(structure_data_A['Единица_Сдоп'], '')}) * {rates['отчисления'] / 100} = {format_cost(structure_data_A['Единица_Ссоц'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Ссоц = {format_cost(structure_data_A['Единица_Ссоц'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Ссоц'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Ссоц = (Сосн + Сдоп) * ({rates['отчисления']}/100) = ({format_cost(structure_data_B['Единица_Сосн'], '')} + {format_cost(structure_data_B['Единица_Сдоп'], '')}) * {rates['отчисления'] / 100} = {format_cost(structure_data_B['Единица_Ссоц'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Ссоц = {format_cost(structure_data_B['Единица_Ссоц'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Ссоц'])}\n\n"

    # --- 7. РСЭО ---
    output += "7. Расходы на содержание и эксплуатацию оборудования\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Рсэо = Сосн * ({rates['РСЭО']}/100) = {format_cost(structure_data_A['Единица_Сосн'])} * {rates['РСЭО'] / 100} = {format_cost(structure_data_A['Единица_Рсэо'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Рсэо = {format_cost(structure_data_A['Единица_Рсэо'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Рсэо'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Рсэо = Сосн * ({rates['РСЭО']}/100) = {format_cost(structure_data_B['Единица_Сосн'])} * {rates['РСЭО'] / 100} = {format_cost(structure_data_B['Единица_Рсэо'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Рсэо = {format_cost(structure_data_B['Единица_Рсэо'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Рсэо'])}\n\n"

    # --- 8. ОПР ---
    output += "8. Общепроизводственные расходы\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Роп = Сосн * ({rates['ОПР']}/100) = {format_cost(structure_data_A['Единица_Сосн'])} * {rates['ОПР'] / 100} = {format_cost(structure_data_A['Единица_Роп'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Роп = {format_cost(structure_data_A['Единица_Роп'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Роп'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Роп = Сосн * ({rates['ОПР']}/100) = {format_cost(structure_data_B['Единица_Сосн'])} * {rates['ОПР'] / 100} = {format_cost(structure_data_B['Единица_Роп'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Роп = {format_cost(structure_data_B['Единица_Роп'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Роп'])}\n\n"

    # --- 9. ОХР ---
    output += "9. Общехозяйственные расходы\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Рох = Сосн * ({rates['ОХР']}/100) = {format_cost(structure_data_A['Единица_Сосн'])} * {rates['ОХР'] / 100} = {format_cost(structure_data_A['Единица_Рох'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Рох = {format_cost(structure_data_A['Единица_Рох'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Рох'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Рох = Сосн * ({rates['ОХР']}/100) = {format_cost(structure_data_B['Единица_Сосн'])} * {rates['ОХР'] / 100} = {format_cost(structure_data_B['Единица_Рох'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Рох = {format_cost(structure_data_B['Единица_Рох'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Рох'])}\n\n"

    # --- Производственная себестоимость ---
    output += "ВСЕГО производственная себестоимость\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Спр = Сом + (Спф+Ском) + Стэ + Сосн + Сдоп + Ссоц + Рсэо + Роп + Рох = {format_cost(structure_data_A['Единица_Сом'])} + {format_cost(structure_data_A['Единица_Спф_Ском'])} + {format_cost(structure_data_A['Единица_Стэ'])} + {format_cost(structure_data_A['Единица_Сосн'])} + {format_cost(structure_data_A['Единица_Сдоп'])} + {format_cost(structure_data_A['Единица_Ссоц'])} + {format_cost(structure_data_A['Единица_Рсэо'])} + {format_cost(structure_data_A['Единица_Роп'])} + {format_cost(structure_data_A['Единица_Рох'])} = {format_cost(structure_data_A['Единица_Спр'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Спр = {format_cost(structure_data_A['Единица_Спр'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Спр'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Спр = Сом + (Спф+Ском) + Стэ + Сосн + Сдоп + Ссоц + Рсэо + Роп + Рох = {format_cost(structure_data_B['Единица_Сом'])} + {format_cost(structure_data_B['Единица_Спф_Ском'])} + {format_cost(structure_data_B['Единица_Стэ'])} + {format_cost(structure_data_B['Единица_Сосн'])} + {format_cost(structure_data_B['Единица_Сдоп'])} + {format_cost(structure_data_B['Единица_Ссоц'])} + {format_cost(structure_data_B['Единица_Рсэо'])} + {format_cost(structure_data_B['Единица_Роп'])} + {format_cost(structure_data_B['Единица_Рох'])} = {format_cost(structure_data_B['Единица_Спр'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Спр = {format_cost(structure_data_B['Единица_Спр'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Спр'])}\n\n"

    # --- 10. Внепроизводственные расходы ---
    output += "10. Внепроизводственные расходы\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Свп = Спр * ({rates['ВПР']}/100) = {format_cost(structure_data_A['Единица_Спр'])} * {rates['ВПР'] / 100} = {format_cost(structure_data_A['Единица_Свп'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Свп = {format_cost(structure_data_A['Единица_Свп'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Свп'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Свп = Спр * ({rates['ВПР']}/100) = {format_cost(structure_data_B['Единица_Спр'])} * {rates['ВПР'] / 100} = {format_cost(structure_data_B['Единица_Свп'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Свп = {format_cost(structure_data_B['Единица_Свп'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Свп'])}\n\n"

    # --- Полная себестоимость ---
    output += "ВСЕГО полная (коммерческая) себестоимость\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"Сп = Спр + Свп = {format_cost(structure_data_A['Единица_Спр'])} + {format_cost(structure_data_A['Единица_Свп'])} = {format_cost(structure_data_A['Единица_Сп'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сп = {format_cost(structure_data_A['Единица_Сп'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Сп'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"Сп = Спр + Свп = {format_cost(structure_data_B['Единица_Спр'])} + {format_cost(structure_data_B['Единица_Свп'])} = {format_cost(structure_data_B['Единица_Сп'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"Сп = {format_cost(structure_data_B['Единица_Сп'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Сп'])}\n\n"

    # --- 11. Прибыль ---
    output += "11. Прибыль\n"

    output += "Изделие А\n"
    output += f"На единицу:\n"
    output += f"П = Сп * ({rates['рентабельность']}/100) = {format_cost(structure_data_A['Единица_Сп'])} * {rates['рентабельность'] / 100} = {format_cost(structure_data_A['Единица_Прибыль'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"П = {format_cost(structure_data_A['Единица_Прибыль'])} * {structure_data_A['Q']} = {format_cost_annual(structure_data_A['Годовой_Прибыль'])}\n"

    output += "Изделие Б\n"
    output += f"На единицу:\n"
    output += f"П = Сп * ({rates['рентабельность']}/100) = {format_cost(structure_data_B['Единица_Сп'])} * {rates['рентабельность'] / 100} = {format_cost(structure_data_B['Единица_Прибыль'])}\n"
    output += f"На годовой выпуск:\n"
    output += f"П = {format_cost(structure_data_B['Единица_Прибыль'])} * {structure_data_B['Q']} = {format_cost_annual(structure_data_B['Годовой_Прибыль'])}\n\n"

    # --- 12. Оптовая цена ---
    output += "12. Оптовая (отпускная) цена\n"

    output += "Изделие А\n"
    output += f"Цопт = Сп + П = {format_cost(structure_data_A['Единица_Сп'])} + {format_cost(structure_data_A['Единица_Прибыль'])} = {format_cost(structure_data_A['Оптовая_цена'])}\n"

    output += "Изделие Б\n"
    output += f"Цопт = Сп + П = {format_cost(structure_data_B['Единица_Сп'])} + {format_cost(structure_data_B['Единица_Прибыль'])} = {format_cost(structure_data_B['Оптовая_цена'])}\n\n"

    return output

====================
FILE: .\task1\individual_product_volumes.json
====================
[
    {
        "Изделие": "А",
        "Годовой_объем_выпуска": 219,
        "Оптовая_цена_за_единицу": 730407.37,
        "Объем_товарной_продукции_по_изделию тыс руб": 159959.21
    },
    {
        "Изделие": "Б",
        "Годовой_объем_выпуска": 67,
        "Оптовая_цена_за_единицу": 302721.44,
        "Объем_товарной_продукции_по_изделию тыс руб": 20282.34
    },
    {
        "Qt": 180241.5507228,
        "Qr": 181142.758476414
    }
]

====================
FILE: .\task1\input_data_table.json
====================
[
    {
        "№": "№",
        "Показатель": "Показатели",
        "Дополнение": "Номер дополнения",
        "Ед. измерения": "Ед. измерения",
        "Изделие А": "Изделие А",
        "Изделие Б": "Изделие Б"
    },
    {
        "№": "1.3",
        "Показатель": "Прокат цветных металлов",
        "Дополнение": "",
        "Ед. измерения": "руб",
        "Изделие А": "2900",
        "Изделие Б": "3000"
    },
    {
        "№": "1.4",
        "Показатель": "Другие материалы",
        "Дополнение": "",
        "Ед. измерения": "руб",
        "Изделие А": "1800",
        "Изделие Б": "1700"
    },
    {
        "№": "3",
        "Показатель": "покупные комплектующие изделия",
        "Дополнение": "3",
        "Ед. измерения": "руб",
        "Изделие А": "142800",
        "Изделие Б": "75800"
    },
    {
        "№": "4",
        "Показатель": "Цена стального проката",
        "Дополнение": "4",
        "Ед. измерения": "руб /т",
        "Изделие А": "12800",
        "Изделие Б": "12800"
    },
    {
        "№": "5",
        "Показатель": "Цена стальных труб",
        "Дополнение": "4",
        "Ед. измерения": "руб /т",
        "Изделие А": "18500",
        "Изделие Б": "18500"
    },
    {
        "№": "8",
        "Показатель": "Топливо и энергия на технологические потребности",
        "Дополнение": "5",
        "Ед. измерения": "%",
        "Изделие А": "1",
        "Изделие Б": "0.9"
    },
    {
        "№": "9",
        "Показатель": "Суммарная трудоемкость изделия",
        "Дополнение": "6",
        "Ед. измерения": "н-час",
        "Изделие А": "920.0",
        "Изделие Б": "157.32"
    },
    {
        "№": "10",
        "Показатель": "Часовая тарифная ставка",
        "Дополнение": "6",
        "Ед. измерения": "руб",
        "Изделие А": "41.5",
        "Изделие Б": "35.6"
    },
    {
        "№": "11",
        "Показатель": "Дополнительная зарплата",
        "Дополнение": "7",
        "Ед. измерения": "%",
        "Изделие А": "40",
        "Изделие Б": "40"
    },
    {
        "№": "12",
        "Показатель": "Отчисление на социальное страхование",
        "Дополнение": "7",
        "Ед. измерения": "%",
        "Изделие А": "22",
        "Изделие Б": "22"
    },
    {
        "№": "13",
        "Показатель": "Расходы на содержание и эксплуатацию оборудования",
        "Дополнение": "7",
        "Ед. измерения": "%",
        "Изделие А": "87",
        "Изделие Б": "87"
    },
    {
        "№": "14",
        "Показатель": "Общепроизводственные расходы",
        "Дополнение": "7",
        "Ед. измерения": "%",
        "Изделие А": "85",
        "Изделие Б": "85"
    },
    {
        "№": "15",
        "Показатель": "Общехозяйственные расходы",
        "Дополнение": "7",
        "Ед. измерения": "%",
        "Изделие А": "98",
        "Изделие Б": "98"
    },
    {
        "№": "16",
        "Показатель": "Внепроизводственные расходы",
        "Дополнение": "7",
        "Ед. измерения": "%",
        "Изделие А": "5",
        "Изделие Б": "5"
    },
    {
        "№": "17",
        "Показатель": "Норматив рентабельности к себестоимости",
        "Дополнение": "7",
        "Ед. измерения": "%",
        "Изделие А": "20",
        "Изделие Б": "20"
    },
    {
        "№": "18",
        "Показатель": "Годовой объем производства",
        "Дополнение": "1",
        "Ед. измерения": "шт",
        "Изделие А": "206",
        "Изделие Б": "63"
    }
]

====================
FILE: .\task1\sebestoimost_structure.json
====================
[
    {
        "Наименование статей расходов": "1. Основные материалы за вычетом возвратных отходов",
        "Изделие А на единицу, руб": 11651.11,
        "Изделие А на годовой выпуск, тыс.руб.": 2551.59,
        "Изделие Б на единицу, руб": 5502.98,
        "Изделие Б на годовой выпуск, тыс.руб.": 368.7,
        "Себестоимость годового выпуска продукции, тыс.руб.": 2920.29,
        "Структура расходов,%": 1.94
    },
    {
        "Наименование статей расходов": "2. Покупные полуфабрикаты и комплектующие изделия",
        "Изделие А на единицу, руб": 198807.0,
        "Изделие А на годовой выпуск, тыс.руб.": 43538.73,
        "Изделие Б на единицу, руб": 104532.7,
        "Изделие Б на годовой выпуск, тыс.руб.": 7003.69,
        "Себестоимость годового выпуска продукции, тыс.руб.": 50542.42,
        "Структура расходов,%": 33.65
    },
    {
        "Наименование статей расходов": "3. Топливо и энергия на технологические потребности",
        "Изделие А на единицу, руб": 2125.84,
        "Изделие А на годовой выпуск, тыс.руб.": 465.56,
        "Изделие Б на единицу, руб": 999.32,
        "Изделие Б на годовой выпуск, тыс.руб.": 66.95,
        "Себестоимость годового выпуска продукции, тыс.руб.": 532.51,
        "Структура расходов,%": 0.35
    },
    {
        "Наименование статей расходов": "4. Основная заработная плата производственных рабочих",
        "Изделие А на единицу, руб": 38180.0,
        "Изделие А на годовой выпуск, тыс.руб.": 8361.42,
        "Изделие Б на единицу, руб": 5600.59,
        "Изделие Б на годовой выпуск, тыс.руб.": 375.24,
        "Себестоимость годового выпуска продукции, тыс.руб.": 8736.66,
        "Структура расходов,%": 5.82
    },
    {
        "Наименование статей расходов": "5. Дополнительная заработная плата производственных рабочих",
        "Изделие А на единицу, руб": 15272.0,
        "Изделие А на годовой выпуск, тыс.руб.": 3344.57,
        "Изделие Б на единицу, руб": 2240.24,
        "Изделие Б на годовой выпуск, тыс.руб.": 150.1,
        "Себестоимость годового выпуска продукции, тыс.руб.": 3494.66,
        "Структура расходов,%": 2.33
    },
    {
        "Наименование статей расходов": "6. Отчисление в фонды социальных мероприятий",
        "Изделие А на единицу, руб": 11759.44,
        "Изделие А на годовой выпуск, тыс.руб.": 2575.32,
        "Изделие Б на единицу, руб": 1724.98,
        "Изделие Б на годовой выпуск, тыс.руб.": 115.57,
        "Себестоимость годового выпуска продукции, тыс.руб.": 2690.89,
        "Структура расходов,%": 1.79
    },
    {
        "Наименование статей расходов": "7. Расходы по содержанию и эксплуатации оборудования",
        "Изделие А на единицу, руб": 33216.6,
        "Изделие А на годовой выпуск, тыс.руб.": 7274.44,
        "Изделие Б на единицу, руб": 4872.51,
        "Изделие Б на годовой выпуск, тыс.руб.": 326.46,
        "Себестоимость годового выпуска продукции, тыс.руб.": 7600.89,
        "Структура расходов,%": 5.06
    },
    {
        "Наименование статей расходов": "8. Общепроизводственные расходы",
        "Изделие А на единицу, руб": 32453.0,
        "Изделие А на годовой выпуск, тыс.руб.": 7107.21,
        "Изделие Б на единицу, руб": 4760.5,
        "Изделие Б на годовой выпуск, тыс.руб.": 318.95,
        "Себестоимость годового выпуска продукции, тыс.руб.": 7426.16,
        "Структура расходов,%": 4.94
    },
    {
        "Наименование статей расходов": "9. Общехозяйственные расходы",
        "Изделие А на единицу, руб": 37416.4,
        "Изделие А на годовой выпуск, тыс.руб.": 8194.19,
        "Изделие Б на единицу, руб": 5488.58,
        "Изделие Б на годовой выпуск, тыс.руб.": 367.73,
        "Себестоимость годового выпуска продукции, тыс.руб.": 8561.93,
        "Структура расходов,%": 5.7
    },
    {
        "Наименование статей расходов": "ВСЕГО производственная себестоимость",
        "Изделие А на единицу, руб": 579688.39,
        "Изделие А на годовой выпуск, тыс.руб.": 126951.76,
        "Изделие Б на единицу, руб": 240255.11,
        "Изделие Б на годовой выпуск, тыс.руб.": 16097.09,
        "Себестоимость годового выпуска продукции, тыс.руб.": 143048.85,
        "Структура расходов,%": 95.24
    },
    {
        "Наименование статей расходов": "10. Внепроизводственные расходы",
        "Изделие А на единицу, руб": 28984.42,
        "Изделие А на годовой выпуск, тыс.руб.": 6347.59,
        "Изделие Б на единицу, руб": 12012.76,
        "Изделие Б на годовой выпуск, тыс.руб.": 804.85,
        "Себестоимость годового выпуска продукции, тыс.руб.": 7152.44,
        "Структура расходов,%": 4.76
    },
    {
        "Наименование статей расходов": "ВСЕГО полная (коммерческая) себестоимость",
        "Изделие А на единицу, руб": 608672.81,
        "Изделие А на годовой выпуск, тыс.руб.": 133299.35,
        "Изделие Б на единицу, руб": 252267.87,
        "Изделие Б на годовой выпуск, тыс.руб.": 16901.95,
        "Себестоимость годового выпуска продукции, тыс.руб.": 150201.29,
        "Структура расходов,%": 100.0
    },
    {
        "Наименование статей расходов": "11. Прибыль",
        "Изделие А на единицу, руб": 121734.56,
        "Изделие А на годовой выпуск, тыс.руб.": 26659.87,
        "Изделие Б на единицу, руб": 50453.57,
        "Изделие Б на годовой выпуск, тыс.руб.": 3380.39,
        "Себестоимость годового выпуска продукции, тыс.руб.": 30040.26,
        "Структура расходов,%": 20.0
    },
    {
        "Наименование статей расходов": "12. Оптовая (отпускная) цена",
        "Изделие А на единицу, руб": 730407.37,
        "Изделие А на годовой выпуск, тыс.руб.": null,
        "Изделие Б на единицу, руб": 302721.44,
        "Изделие Б на годовой выпуск, тыс.руб.": null,
        "Себестоимость годового выпуска продукции, тыс.руб.": null,
        "Структура расходов,%": null
    }
]

====================
FILE: .\task1\test.py
====================
from funcs import *
import pandas as pd
import numpy as np

# Пример исходных данных для Варианта 3
materials_main_example = { 'стальной прокат': { 'type': 'material',
                       'A': { 'rasxod': np.float64(0.45),
                              'otxod': np.float64(0.0675)},
                       'B': { 'rasxod': np.float64(0.05),
                              'otxod': np.float64(0.005)}},
  'трубы стальные': { 'type': 'material',
                      'A': { 'rasxod': np.float64(0.04),
                             'otxod': np.float64(0.0028)},
                      'B': { 'rasxod': np.float64(0.005),
                             'otxod': np.float64(0.0003)}},
  'прокат цветных металлов': { 'type': 'fixed',
                               'A': np.int64(2900),
                               'B': np.int64(3000)},
  'другие материалы': { 'type': 'fixed',
                        'A': np.int64(1800),
                        'B': np.int64(1700)}}


materials_purchased_example = {
    "отливки черных металлов": {"type": "material", "A": {"rasxod": 4.5, "otxod": 0.675}, "B": {"rasxod": 2.2, "otxod": 0.484}},
    "отливки цветных металлов": {"type": "material", "A": {"rasxod": 0.3, "otxod": 0.075}, "B": {"rasxod": 0.25, "otxod": 0.05}},
    "покупные комплектующие изделия": {"type": "fixed", "A": 142800, "B": 75800}
}


# !!!!!!!!!!  ^^^   "покупные комплектующие изделия": {"type": "fixed", "A": 142800, "B": 75800}    !!!!!!!!!!!!  ^^^


prices_example = {
    "стальной прокат_материал": 12800,
    "стальной прокат_отходы": 7500,
    "трубы стальные_материал": 18500,
    "трубы стальные_отходы": 6300,
    "отливки черных металлов_материал": 10500,
    "отливки черных металлов_отходы": 7200,
    "отливки цветных металлов_материал": 22600,
    "отливки цветных металлов_отходы": 16900,
}

fuel_energy_example = {"A": 1, "B": 0.9}
labor_example = {
    "labor_hours": {"A": 1000, "B": 171},
    "hourly_rate": {"A": 41.50, "B": 35.60}
}
rates_example = {
    "доп_зарплата": 40,
    "отчисления": 22,
    "РСЭО": 87,
    "ОПР": 85,
    "ОХР": 98,
    "ВПР": 5,
    "рентабельность": 20
}
volume_base_example = {"A": 195, "B": 60}

# --- Входные коэффициенты ---
Ka_input = 1.06 # Коэффициент для корректировки объема
Kj_input = 0.92 # Пример
Ktr_input = 1.15

# --- Сохранение CSV ---
csv_table_input = generate_input_table_csv(
    materials_main_example, materials_purchased_example,
    prices_example, fuel_energy_example, labor_example, rates_example,
    volume_base_example, Ka_input, Kj_input, Ktr_input
)
csv_input_filename = "input_data_table.csv"
with open(csv_input_filename, 'w', encoding='utf-8', newline='') as csvfile:
    csvfile.write(csv_table_input)

to_js = csv_to_json_structure(csv_input_filename)
with open("input_data_table.json", "w", encoding="utf-8") as f:
    json.dump(to_js, f, ensure_ascii=False, indent=4)


# --- Выполнение основной логики ---
# print("Исходные данные:")
# print(f"Ka = {Ka_input}, Kj = {Kj_input}, Ktr = {Ktr_input}")
# print(f"Базовый объем (из Дополнения 1, Вар. 3): {volume_base_example}")
# Q_A_calc = int(volume_base_example["A"] * Ka_input)
# Q_B_calc = int(volume_base_example["B"] * Ka_input)
# print(f"Рассчитанные объемы (Q_base * Ka, округленные до меньшего целого): A = {Q_A_calc}, B = {Q_B_calc}")
# print(f"Основные материалы: {materials_main_example}")
# print(f"Покупные ПФ+Комплектующие: {materials_purchased_example}")
# print(f"Цены: {prices_example}")
# print(f"Топливо и энергия: {fuel_energy_example}")
# print(f"Трудоемкость и ставка: {labor_example}")
# print(f"Процентные ставки: {rates_example}")
print("\n" + "="*50 + "\n")

# Генерация вывода для изделий А и Б
output_result, structure_data_A, structure_data_B, details_A, details_B = generate_full_output(  # Изменено: принимаем пять значений
    volume_base_example, Ka_input, Kj_input, Ktr_input,
    materials_main_example, materials_purchased_example,
    prices_example, fuel_energy_example, labor_example, rates_example
)

print("Расчет по статьям:")
print(output_result)

# Теперь используем generate_output_by_punkt для нового формата вывода
new_format_output = generate_output_by_punkt(structure_data_A, structure_data_B, details_A, details_B, rates_example)

print("\n" + "="*80 + "\n")
print("РАСЧЕТ В НОВОМ ФОРМАТЕ (по пунктам):")
print(new_format_output)

# --- Новый код для получения данных структуры ---
prepared_materials_main, prepared_labor, prepared_volume = prepare_data_with_coefficients(
    materials_main_example, labor_example, volume_base_example, Ka_input, Kj_input
)
prepared_materials_purchased, _, _ = prepare_data_with_coefficients(
    materials_purchased_example, {"labor_hours": {"A": 1, "B": 1}}, {"A": 1, "B": 1}, 1, Kj_input
)
combined_materials = {**prepared_materials_main, **prepared_materials_purchased}

structure_data_A = {}
structure_data_B = {}
for item in ['A', 'B']:
    Q_item = prepared_volume[item]
    # _, item_structure = generate_output_for_item(
    #     item, Q_item, 1, Ktr_input,
    #     combined_materials, prices_example, fuel_energy_example, prepared_labor, rates_example
    # )
    # if item == 'A':
    #     structure_data_A = item_structure
    # else:
    #     structure_data_B = item_structure

    _, item_structure, item_details = generate_output_for_item(
        item, Q_item, Ka_input, Ktr_input,
        combined_materials, prices_example, fuel_energy_example, prepared_labor, rates_example
    )

    if item == 'A':
        structure_data_A = item_structure
        details_A = item_details
    else:
        structure_data_B = item_structure
        details_B = item_details

output_result = generate_output_by_punkt(structure_data_A, structure_data_B, details_A, details_B, rates_example)

# --- Конец нового кода ---

# Генерация CSV и сохранение в файл
csv_table_content = generate_structure_table_csv(structure_data_A, structure_data_B)

# Сохранение CSV в файл
csv_filename = "sebestoimost_structure.csv"
with open(csv_filename, 'w', encoding='utf-8', newline='') as csvfile:
    csvfile.write(csv_table_content)

print(f"\nCSV таблица сохранена в файл: {csv_filename}")


Q_t, Q_p, Q_A, Q_B, price_A, price_B = calculate_product_volumes(structure_data_A, structure_data_B)

# Формируем и выводим расчет для объемов продукции
volumes_output = "\n--- Расчет объемов продукции ---\n"

volumes_output += "Объем товарной продукции (Qт):\n"
volumes_output += f"QT = QA * ЦА + QБ * ЦБ (1.6)\n"
volumes_output += "где:\n"
volumes_output += "QA и QБ – годовой объем производства изделий А и Б, шт.;\n"
volumes_output += "ЦА и ЦБ – оптовая цена предприятия изделий А и Б.\n"
volumes_output += f"QT = ({price_A:.2f} * {Q_A} + {price_B:.2f} * {Q_B}) / 1000 = {Q_t:.2f} тыс.руб.\n\n"

volumes_output += f"Годовой объем товарной продукции  A: {(price_A * Q_A) / 1000:.2f} тыс. руб. \n"
volumes_output += f"Годовой объем товарной продукции  Б: {(price_B * Q_B) / 1000:.2f} тыс. руб. \n \n"

volumes_output += "Объем реализованной продукции (Qр):\n"
volumes_output += f"Qр = Qн + Qт – Qк (1.7)\n"
volumes_output += "где:\n"
volumes_output += "Qн – остатки готовой продукции на складе на начало года, тыс.руб. (2% от объема товарной продукции);\n"
volumes_output += "Qк – остатки готовой продукции на конец года, тыс.руб. (принимается 1,5% от объема товарной продукции).\n"
volumes_output += f"Qр = {Q_t:.2f} * 0,02 + {Q_t:.2f} - {Q_t:.2f} * 0,015 = {Q_p:.2f} тыс. руб.\n"

print(volumes_output)
save_structure_table_to_json(structure_data_A, structure_data_B)


individual_volumes_data = {
    "Изделие": "А",
    "Годовой_объем_выпуска": Q_A,
    "Оптовая_цена_за_единицу": round(price_A, 2),
    "Объем_товарной_продукции_по_изделию тыс руб": round(Q_A * price_A / 1000, 2) # в тыс.руб
}
individual_volumes_data_B = {
    "Изделие": "Б",
    "Годовой_объем_выпуска": Q_B,
    "Оптовая_цена_за_единицу": round(price_B, 2),
    "Объем_товарной_продукции_по_изделию тыс руб": round(Q_B * price_B / 1000, 2) # в тыс.руб
}
other = {
    'Qt': Q_t,
    'Qr': Q_p
}

# Сохраняем в JSON файл (например, список из двух словарей)
individual_volumes_json_filename = "individual_product_volumes.json"
with open(individual_volumes_json_filename, 'w', encoding='utf-8') as jsonfile:
    # Записываем оба изделия в один файл как список
    json.dump([individual_volumes_data, individual_volumes_data_B, other], jsonfile, indent=4, ensure_ascii=False)

print(f"\nJSON с отдельными объемами товарной продукции сохранен в файл: {individual_volumes_json_filename}")


====================
FILE: .\task2\ren.py
====================
import re

text = """Группа основных фондов;Стоимость на начало года, тыс.руб;Введено в строй, тыс.руб;Выведено из строя, тыс.руб;Стоимость на конец года, тыс.руб
1.Здания;17465.446;349.309;0.000;17814.754698795183
2.Сооружения;3041.735;0.000;45.626;2996.1089156626504
3. Передаточные устройства;1717.108;0.000;0.000;1717.1084337349396
4. Машины и оборудование;24824.482;0.000;0.000;24824.481927710844
4.1. Силовые машины;1128.386;0.000;0.000;1128.3855421686746
4.2. Рабочие машины и оборудование;20360.000;0.000;0.000;20360.0
4.3. Измерительные приборы и устройства;1569.928;0.000;0.000;1569.9277108433737
4.4. Вычислительная техника;1471.807;0.000;0.000;1471.8072289156626
4.5. Другие машины и оборудование;294.361;0.000;0.000;294.3614457831325
5.Транспортные средства;1030.265;0.000;0.000;1030.265060240964
6. Другие основные фонды;981.205;0.000;0.000;981.2048192771085
ИТОГО;49060.241;349.309;45.626;"3    49363.923855
Name: Стоимость на конец года, тыс.руб, dtype: float64"
"""

# Убираем все цифры после точки, начиная с третьей
result = re.sub(r'\.(\d{2})\d+', r'.\1', text)

print(result)


====================
FILE: .\task2\task2_course.py
====================
import json
import pandas as pd
from dopolneniya_tables.exstractor_L import get_variant_data

def main():
    # --- ПРИМЕР ИСПОЛЬЗОВАНИЯ ---

    # 1. Укажите путь к файлу и номер варианта
    file_path = '../dopolneniya_tables/dop_L.csv'
    current_variant = 2

    # 2. Получаем данные
    data = get_variant_data(file_path, current_variant)

    # 3. Присваиваем переменным (распаковка)
    stoimost_rmo_nachalo = data['stoimost_rmo_nachalo']
    gruppa_vvod = data['gruppa_vvod'].capitalize()
    gruppa_vyvod = data['gruppa_vyvod'].capitalize()
    procent_vvoda = data['procent_vvoda']
    procent_vyvoda = data['procent_vyvoda']
    mes_vvoda = data['mes_vvoda']
    mes_vyvoda = data['mes_vyvoda']

    print(f"- Стоимость РМО на начало года: {stoimost_rmo_nachalo} тыс. руб.")
    print(f"- Группа вводимых фондов: {gruppa_vvod}")
    print(f"- Группа выводимых фондов: {gruppa_vyvod}")
    print(f"- Процент ввода: {procent_vvoda}%")
    print(f"- Процент вывода: {procent_vyvoda}%")
    print(f"- Месяц ввода: {mes_vvoda}")
    print(f"- Месяц вывода: {mes_vyvoda}")

    # Структура из Дополнения М (%)
    udelnye_vesy = {
        "Здания": 35.6,
        "Сооружения": 6.2,
        "Передаточные устройства": 3.5,
        "Силовые машины": 2.3,
        "Рабочие машины и оборудование": 41.5, # Базовая группа
        "Измерительные приборы и устройства": 3.2,
        "Вычислительная техника": 3.0,
        "Другие машины и оборудование": 0.6,
        "Транспортные средства": 2.1,
        "Другие основные фонды": 2.0,
    }

    # --- 2. Создание таблицы "Исходные данные" ---
    data = {
        'Показатель': [
            'Стоимость рабочих машин и оборудования на начало года, тыс.руб',
            'Группа основных фондов, которые вводятся',
            'Группа основных фондов, которые выбывают',
            'Стоимость основных фондов, которые вводятся, в % к первоначальной стоимости соответствующей группы',
            'Стоимость основных фондов, которые выбывают, в % к первоначальной стоимости соответствующей группы',
            'Месяц введения основных фондов',
            'Месяц выведения основных фондов'
        ],
        'Значение': [
            stoimost_rmo_nachalo,
            gruppa_vvod,
            gruppa_vyvod,
            procent_vvoda,
            procent_vyvoda,
            mes_vvoda,
            mes_vyvoda
        ]
    }
    df_initial_data = pd.DataFrame(data)
    df_initial_data.to_csv('Исходные_данные_основные_фонды.csv', index=False, encoding='utf-8-sig', sep=';')
    print("\nТаблица 'Исходные_данные_основные_фонды.csv' создана.")

    # --- 3. Промежуточные расчёты ---
    print("\n--- ПРОМЕЖУТОЧНЫЕ РАСЧЁТЫ ---")
    print(f"Фi = Фрм * (αi / αрм), где:")
    print(f"- Фрм (стоимость РМО) = {stoimost_rmo_nachalo} тыс. руб.")
    print(f"- αрм (удельный вес РМО) = {udelnye_vesy['Рабочие машины и оборудование']}%")

    stoimost_na_nachalo = {}
    for gruppa, ves in udelnye_vesy.items():
        # Формула (1.8): Фi = Фрм * (αi / αрм)
        stoimost_na_nachalo[gruppa] = stoimost_rmo_nachalo * (ves / udelnye_vesy["Рабочие машины и оборудование"])
        # Используем первые буквы названий групп для обозначения в выводе (как в примере)
        # Обработка названий для обозначения
        parts = gruppa.split()
        if parts[0].lower() in ['здания', 'сооружения', 'транспортные', 'другие']:
            prefix = parts[0][0].lower()
        elif parts[0].lower() == 'передаточные':
            prefix = 'пу'
        elif parts[0].lower() == 'силовые':
            prefix = 'см'
        elif parts[0].lower() == 'рабочие':
            prefix = 'раб'
        elif parts[0].lower() == 'измерительные':
            prefix = 'из'
        elif parts[0].lower() == 'вычислительная':
            prefix = 'вт'
        elif parts[0].lower() == 'другие' and parts[1].lower() == 'машины':
             prefix = 'др'
        else:
            # На случай, если название не попадает под простое правило
            prefix = ''.join([word[0].lower() for word in parts if word not in ['и', 'на', 'в', 'по']])[:2]
        print(f"Ф{prefix} = {stoimost_rmo_nachalo} * {ves}/{udelnye_vesy['Рабочие машины и оборудование']} = {stoimost_na_nachalo[gruppa]:.3f} тыс. руб.")

    # --- Определение стоимости вводимой/выводимой группы ---
    # Проверяем, есть ли указанные группы в словаре udelnye_vesy
    if gruppa_vvod not in udelnye_vesy:
        print(f"Ошибка: Группа для ввода '{gruppa_vvod}' не найдена в структуре фондов (Дополнение М).")
        return
    if gruppa_vyvod not in udelnye_vesy:
        print(f"Ошибка: Группа для вывода '{gruppa_vyvod}' не найдена в структуре фондов (Дополнение М).")
        return

    # Стоимость "вводимой" группы фондов на начало года
    stoimost_vvodimoy_gruppy_nachalo = stoimost_na_nachalo[gruppa_vvod]
    # Стоимость "выводимой" группы фондов на начало года
    stoimost_vyvodimoy_gruppy_nachalo = stoimost_na_nachalo[gruppa_vyvod]

    # Стоимость вводимых фондов (по указанной группе)
    stoimost_vvodimyh = stoimost_vvodimoy_gruppy_nachalo * (procent_vvoda / 100)
    print(f"\nСтоимость {gruppa_vvod.lower()}, введённой в строй:")
    print(f"Фвв = Ф{gruppa_vvod.split()[0][0].lower() if gruppa_vvod.split()[0][0].lower() != 'д' else gruppa_vvod.split()[1][0].lower()} * {procent_vvoda}%")
    print(f"Фвв = {stoimost_vvodimoy_gruppy_nachalo:.3f} * {procent_vvoda}% = {stoimost_vvodimyh:.3f} тыс. руб.")

    # Стоимость выводимых фондов (по указанной группе)
    stoimost_vyvodimyh = stoimost_vyvodimoy_gruppy_nachalo * (procent_vyvoda / 100)
    print(f"\nСтоимость {gruppa_vyvod.lower()}, выведенных из строя:")
    print(f"Фвыв = Ф{gruppa_vyvod.split()[0][0].lower() if gruppa_vyvod.split()[0][0].lower() != 'д' else gruppa_vyvod.split()[1][0].lower()} * {procent_vyvoda}%")
    print(f"Фвыв = {stoimost_vyvodimoy_gruppy_nachalo:.3f} * {procent_vyvoda}% = {stoimost_vyvodimyh:.3f} тыс. руб.")

    # --- 4. Формирование итоговой таблицы ---
    print("\n--- ФОРМИРОВАНИЕ ИТОГОВОЙ ТАБЛИЦЫ ---")
    # Подготовка данных для DataFrame
    rows_data = {}

    # Заполняем основные группы (1, 2, 3, 5, 6)
    rows_data["1.Здания"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Здания"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    rows_data["2.Сооружения"] = {
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Сооружения"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    rows_data["3. Передаточные устройства"] = {  # <-- Добавить
        "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Передаточные устройства"],
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    # Строка "4. Машины и оборудование" добавляется с нулями
    rows_data["4. Машины и оборудование"] = {  # <-- Добавить
        "Стоимость на начало года, тыс.руб": 0.0,  # Временное значение, будет пересчитано позже
        "Введено в строй, тыс.руб": 0.0,
        "Выведено из строя, тыс.руб": 0.0
    }
    # 3. Группа вводимых фондов - ввод
    # Нужно сопоставить группу ввода с её номером в итоговой таблице
    # 'Передаточные устройства' -> '3. Передаточные устройства'
    # 'Здания' -> '1.Здания', 'Сооружения' -> '2.Сооружения', 'Силовые машины' -> '4.1. ...', 'Рабочие машины и оборудование' -> '4.2. ...', 'Транспортные средства' -> '5.Транспортные средства', 'Другие основные фонды' -> '6. Другие основные фонды'
    # Машины и оборудование (4) -> подпункты 4.1 - 4.5
    # Найдем правильный ключ в rows_data для группы ввода
    key_vvod = None
    if gruppa_vvod == "Здания":
        key_vvod = "1.Здания"
    elif gruppa_vvod == "Сооружения":
        key_vvod = "2.Сооружения"
    elif gruppa_vvod == "Передаточные устройства":
        key_vvod = "3. Передаточные устройства"
    elif gruppa_vvod == "Транспортные средства":
        key_vvod = "5.Транспортные средства"
    elif gruppa_vvod == "Другие основные фонды":
        key_vvod = "6. Другие основные фонды"
    elif gruppa_vvod in ["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"]:
        # Для подпунктов машин и оборудования
        if gruppa_vvod == "Силовые машины":
            key_vvod = "4.1. Силовые машины"
        elif gruppa_vvod == "Рабочие машины и оборудование":
            key_vvod = "4.2. Рабочие машины и оборудование"
        elif gruppa_vvod == "Измерительные приборы и устройства":
            key_vvod = "4.3. Измерительные приборы и устройства"
        elif gruppa_vvod == "Вычислительная техника":
            key_vvod = "4.4. Вычислительная техника"
        elif gruppa_vvod == "Другие машины и оборудование":
            key_vvod = "4.5. Другие машины и оборудование"
    else:
        print(f"Ошибка: Не найден ключ для группы ввода '{gruppa_vvod}' в итоговой таблице.")
        return # Прерываем выполнение, если ключ не найден

    if key_vvod:
        rows_data[key_vvod] = {
            "Стоимость на начало года, тыс.руб": stoimost_na_nachalo[gruppa_vvod],
            "Введено в строй, тыс.руб": stoimost_vvodimyh,
            "Выведено из строя, тыс.руб": 0.0
        }
    else:
        print(f"Предупреждение: Ключ для группы ввода '{gruppa_vvod}' не найден.")


    # Подгруппы машин и оборудования (4.1 - 4.5)
    # Заполняем все подгруппы, учитывая возможный ввод/вывод
    # Сначала определим, была ли группа ввода или вывода среди подгрупп 4.x
    is_vvod_in_machines = key_vvod and key_vvod.startswith("4.")
    key_vyvod = None
    if gruppa_vyvod == "Силовые машины":
        key_vyvod = "4.1. Силовые машины"
    elif gruppa_vyvod == "Рабочие машины и оборудование":
        key_vyvod = "4.2. Рабочие машины и оборудование"
    elif gruppa_vyvod == "Измерительные приборы и устройства":
        key_vyvod = "4.3. Измерительные приборы и устройства"
    elif gruppa_vyvod == "Вычислительная техника":
        key_vyvod = "4.4. Вычислительная техника"
    elif gruppa_vyvod == "Другие машины и оборудование":
        key_vyvod = "4.5. Другие машины и оборудование"
    else:
        # Вывод не в подгруппах машин
        pass

    # Заполняем подгруппы машин, учитывая ввод/вывод
    for i, name in enumerate(["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1):
        key = f"4.{i}. {name}"
        # Проверяем, является ли текущая подгруппа вводимой
        if key == key_vvod:
            # Уже заполнено выше
            continue
        # Проверяем, является ли текущая подгруппа выводимой
        if key == key_vyvod:
            # Заполняем с выводом
            rows_data[key] = {
                "Стоимость на начало года, тыс.руб": stoimost_na_nachalo[name],
                "Введено в строй, тыс.руб": 0.0,
                "Выведено из строя, тыс.руб": stoimost_vvodimyh
            }
        else:
            # Обычная подгруппа без изменений
            rows_data[key] = {
                "Стоимость на начало года, тыс.руб": stoimost_na_nachalo[name],
                "Введено в строй, тыс.руб": 0.0,
                "Выведено из строя, тыс.руб": 0.0
            }

    # Если группа вывода не в подгруппах машин, обрабатываем её отдельно
    if not key_vyvod:
        # Проверяем, может быть это одна из основных групп 1, 2, 3, 5, 6
        if gruppa_vyvod == "Здания":
            key_vyvod = "1.Здания"
        elif gruppa_vyvod == "Сооружения":
            key_vyvod = "2.Сооружения"
        elif gruppa_vyvod == "Передаточные устройства":
            key_vyvod = "3. Передаточные устройства"
        elif gruppa_vyvod == "Транспортные средства":
            key_vyvod = "5.Транспортные средства"
        elif gruppa_vyvod == "Другие основные фонды":
            key_vyvod = "6. Другие основные фонды"
        else:
            print(f"Ошибка: Не найден ключ для группы вывода '{gruppa_vyvod}' в итоговой таблице.")
            return # Прерываем выполнение, если ключ не найден

        if key_vyvod:
            # Обновляем существующую запись для группы вывода
            rows_data[key_vyvod]["Выведено из строя, тыс.руб"] = stoimost_vyvodimyh
        else:
            print(f"Предупреждение: Ключ для группы вывода '{gruppa_vyvod}' не найден.")

    # Рассчитываем строку "4. Машины и оборудование" как сумму подгрупп (4.1 - 4.5)
    # machines_nachalo = sum(
    #     rows_data[f"4.{i}. {name}"]["Стоимость на начало года, тыс.руб"] for i, name in enumerate(["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1)
    # )
    # machines_vvod = sum(
    #     rows_data[f"4.{i}. {name}"]["Введено в строй, тыс.руб"] for i, name in enumerate(["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1)
    # )
    # machines_vyvod = sum(
    #     rows_data[f"4.{i}. {name}"]["Выведено из строя, тыс.руб"] for i, name in enumerate(["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства", "Вычислительная техника", "Другие машины и оборудование"], 1)
    # )
    machines_nachalo = sum(
        rows_data[f"4.{i}. {name}"]["Стоимость на начало года, тыс.руб"] for i, name in enumerate(
            ["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства",
             "Вычислительная техника", "Другие машины и оборудование"], 1)
    )
    machines_vvod = sum(
        rows_data[f"4.{i}. {name}"]["Введено в строй, тыс.руб"] for i, name in enumerate(
            ["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства",
             "Вычислительная техника", "Другие машины и оборудование"], 1)
    )
    machines_vyvod = sum(
        rows_data[f"4.{i}. {name}"]["Выведено из строя, тыс.руб"] for i, name in enumerate(
            ["Силовые машины", "Рабочие машины и оборудование", "Измерительные приборы и устройства",
             "Вычислительная техника", "Другие машины и оборудование"], 1)
    )
    # Обновляем значения в существующем ключе
    rows_data["4. Машины и оборудование"]["Стоимость на начало года, тыс.руб"] = machines_nachalo
    rows_data["4. Машины и оборудование"]["Введено в строй, тыс.руб"] = machines_vvod
    rows_data["4. Машины и оборудование"]["Выведено из строя, тыс.руб"] = machines_vyvod

    # 5. Транспортные средства
    if "5.Транспортные средства" not in rows_data:  # Проверяем, не была ли она вводимой/выводимой
        rows_data["5.Транспортные средства"] = {
            "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Транспортные средства"],
            "Введено в строй, тыс.руб": 0.0,
            "Выведено из строя, тыс.руб": 0.0
        }
    # 6. Другие основные фонды
    if "6. Другие основные фонды" not in rows_data:  # Проверяем, не была ли она вводимой/выводимой
        rows_data["6. Другие основные фонды"] = {
            "Стоимость на начало года, тыс.руб": stoimost_na_nachalo["Другие основные фонды"],
            "Введено в строй, тыс.руб": 0.0,
            "Выведено из строя, тыс.руб": 0.0
        }

    # Создаем DataFrame
    df_final = pd.DataFrame.from_dict(rows_data, orient='index')
    df_final = df_final.reset_index()
    df_final.rename(columns={'index': 'Группа основных фондов'}, inplace=True)

    # Рассчитываем столбец "Стоимость на конец года"
    df_final["Стоимость на конец года, тыс.руб"] = df_final["Стоимость на начало года, тыс.руб"] + df_final["Введено в строй, тыс.руб"] - df_final["Выведено из строя, тыс.руб"]

    # Переставляем столбцы в нужном порядке
    df_final = df_final[['Группа основных фондов', 'Стоимость на начало года, тыс.руб', 'Введено в строй, тыс.руб', 'Выведено из строя, тыс.руб', 'Стоимость на конец года, тыс.руб']]

    machines_end = df_final.loc[
    df_final['Группа основных фондов'] == '4. Машины и оборудование',
    'Стоимость на конец года, тыс.руб'
].values[0]


    # Рассчитываем итоговые суммы
    total_nachalo = df_final['Стоимость на начало года, тыс.руб'].sum() - machines_nachalo
    total_vvod = df_final['Введено в строй, тыс.руб'].sum()
    total_vyvod = df_final['Выведено из строя, тыс.руб'].sum()
    total_konec = df_final['Стоимость на конец года, тыс.руб'].sum() - machines_end

    # Добавляем строку ИТОГО
    df_itog = pd.DataFrame([{
        "Группа основных фондов": "ИТОГО",
        "Стоимость на начало года, тыс.руб": total_nachalo,
        "Введено в строй, тыс.руб": total_vvod,
        "Выведено из строя, тыс.руб": total_vyvod,
        "Стоимость на конец года, тыс.руб": total_konec
    }])

    df_final = pd.concat([df_final, df_itog], ignore_index=True)


    # Сохраняем в CSV
    df_final.to_csv(
        'Основные_производственные_фонды_предприятия.csv',
                    index=False,
                    encoding='utf-8-sig',
                    sep=';',
                    float_format='%.3f'
            )
    print("Таблица 'Основные_производственные_фонды_предприятия.csv' создана.")
    print(df_final.round(3))

    # --- 5. Расчёт среднегодовой стоимости ---
    print("\n--- РАСЧЁТ СРЕДНЕГОДОВОЙ СТОИМОСТИ ---")
    F_n = total_nachalo
    F_vv = stoimost_vvodimyh
    F_vyv = stoimost_vyvodimyh
    t_vvoda = 12 - mes_vvoda + 1 # 7
    t_vyvoda = 12 - mes_vyvoda + 1 # 3

    print(f"Формула (1.9): Фср.г = Фн + (Фвв * tвв) / 12 - (Фвыв * tвыв) / 12")
    print(f"Где:")
    print(f"- Фн (стоимость на начало года) = {F_n:.3f} тыс. руб.")
    print(f"- Фвв (стоимость вводимых фондов) = {F_vv:.3f} тыс. руб.")
    print(f"- Фвыв (стоимость выводимых фондов) = {F_vyv:.3f} тыс. руб.")
    print(f"- tвв (месяцы функционирования вводимых фондов) = 12 - {mes_vvoda} + 1 = {t_vvoda}")
    print(f"- tвыв (месяцы после вывода) = 12 - {mes_vyvoda} + 1 = {t_vyvoda}")

    F_sr_g = F_n + (F_vv * t_vvoda) / 12 - (F_vyv * t_vyvoda) / 12
    print(f"Расчёт: {F_n:.3f} + ({F_vv:.3f} * {t_vvoda}) / 12 - ({F_vyv:.3f} * {t_vyvoda}) / 12 = {F_sr_g:.3f} тыс. руб.")
    print(f"\nСреднегодовая стоимость основных фондов: {F_sr_g:.3f} тыс. руб.")

    print("\n--- КОНЕЦ РАСЧЁТОВ ---")

    fssof = {'Среднегодовая стоимость основных фондов': F_sr_g}
    with open('фссоф.json', 'w', encoding='utf-8') as f:
        json.dump(fssof, f, indent=4, ensure_ascii=False)


if __name__ == "__main__":
    main()


====================
FILE: .\task2\фссоф.json
====================
{
    "Среднегодовая стоимость основных фондов": 47477.69638554216
}

====================
FILE: .\task3\task3.py
====================
import pandas as pd
import json


def load_production_data(file_path, variant_task):
    """
    Загружает данные из CSV только для "действующего производства"
    для выбранного Варианта задания (1 или 2).
    """
    try:
        # Читаем CSV с разделителем точка с запятой
        df = pd.read_csv(file_path, sep=';')

        variant_task = 1 if variant_task % 2 != 0 else 2

        # Фильтруем таблицу: оставляем только нужный Вариант задания
        df_variant = df[df['Вариант задания'] == variant_task]

        if df_variant.empty:
            return f"Ошибка: Вариант задания {variant_task} не найден."

        # --- ИЗВЛЕКАЕМ ДАННЫЕ ДЛЯ ИЗДЕЛИЯ А ---
        # Ищем строку, где Изделие == 'А'
        row_a = df_variant[df_variant['Изделие'] == 'А'].iloc[0]

        C_vm_A = int(row_a['C_vm'])  # Годовые расходы вспомогательных материалов
        N_om_A = int(row_a['N_om'])  # Норма запаса основных материалов
        N_pok_A = int(row_a['N_pok'])  # Норма запаса покупных полуфабрикатов
        N_vm_A = int(row_a['N_vm'])  # Норма запаса вспомогательных материалов
        OS_prz_A = int(row_a['OS_prz'])  # Норматив оборотных средств прочих запасов
        T_c_A = int(row_a['T_c'])  # Длительность производственного цикла
        N_gp_A = int(row_a['N_gp'])  # Норма запаса готовой продукции
        OS_rbp_A = int(row_a['OS_rbp'])  # Норматив расходов будущих периодов


        # --- ИЗВЛЕКАЕМ ДАННЫЕ ДЛЯ ИЗДЕЛИЯ Б ---
        # Ищем строку, где Изделие == 'Б'
        row_b = df_variant[df_variant['Изделие'] == 'Б'].iloc[0]

        C_vm_B = int(row_b['C_vm'])
        N_om_B = int(row_b['N_om'])
        N_pok_B = int(row_b['N_pok'])
        N_vm_B = int(row_b['N_vm'])
        OS_prz_B = int(row_b['OS_prz'])
        T_c_B = int(row_b['T_c'])
        N_gp_B = int(row_b['N_gp'])
        OS_rbp_B = int(row_b['OS_rbp'])

        # Возвращаем словарь со всеми переменными
        return {
            'C_vm_A': C_vm_A, 'N_om_A': N_om_A, 'N_pok_A': N_pok_A,
            'N_vm_A': N_vm_A, 'OS_prz_A': OS_prz_A, 'T_c_A': T_c_A, 'N_gp_A': N_gp_A, 'OS_rbp_A': OS_rbp_A,

            'C_vm_B': C_vm_B, 'N_om_B': N_om_B, 'N_pok_B': N_pok_B,
            'N_vm_B': N_vm_B, 'OS_prz_B': OS_prz_B, 'T_c_B': T_c_B, 'N_gp_B': N_gp_B, 'OS_rbp_B': OS_rbp_B
        }

    except Exception as e:
        return f"Ошибка обработки данных: {e}"



def print_full_variables(file_path, variant_task):
    """
    Считывает CSV и печатает готовый код с переменными для копирования.
    """
    try:
        # Читаем CSV
        df = pd.read_csv(file_path, sep=';')

        variant_task = 1 if variant_task % 2 != 0 else 2

        # Фильтруем по варианту задания
        df_var = df[df['Вариант задания'] == variant_task]

        if df_var.empty:
            print(f"Вариант {variant_task} не найден.")
            return

        # Получаем строки для А и Б
        row_a = df_var[df_var['Изделие'] == 'А'].iloc[0]
        row_b = df_var[df_var['Изделие'] == 'Б'].iloc[0]

        # --- ВЫВОД ДЛЯ ИЗДЕЛИЯ А ---
        print(f"# --- Изделие А (Вариант {variant_task}) ---")
        print(f"C_vm_A = {row_a['C_vm']}  # тыс. руб (Годовые расходы вспомогательных материалов)")
        print(f"N_om_A = {row_a['N_om']}  # дн (Норма запаса основных материалов)")
        print(f"N_pok_A = {row_a['N_pok']}  # дн (Норма запаса покупных полуфабрикатов и комплектующих)")
        print(f"N_vm_A = {row_a['N_vm']}  # дн (Норма запаса вспомогательных материалов)")
        print(
            f"OS_prz_A = {row_a['OS_prz']}  # тыс.руб (Норматив оборотных средств по прочим производственным запасам)")
        print(f"T_c_A = {row_a['T_c']}  # Дн (Длительность производственного цикла)")
        print(f"N_gp_A = {row_a['N_gp']}  # Дн (Норма запаса готовой продукции)")
        print(f"OS_rbp_A = {row_a['OS_rbp']}  # тыс.руб (Норматив оборотных средств на расходы будущих периодов)")
        print("")

        # --- ВЫВОД ДЛЯ ИЗДЕЛИЯ Б ---
        print(f"# --- Изделие Б (Вариант {variant_task}) ---")
        print(f"C_vm_B = {row_b['C_vm']}  # тыс. руб (Годовые расходы вспомогательных материалов)")
        print(f"N_om_B = {row_b['N_om']}  # дн (Норма запаса основных материалов)")
        print(f"N_pok_B = {row_b['N_pok']}  # дн (Норма запаса покупных полуфабрикатов и комплектующих)")
        print(f"N_vm_B = {row_b['N_vm']}  # дн (Норма запаса вспомогательных материалов)")
        print(
            f"OS_prz_B = {row_b['OS_prz']}  # тыс.руб (Норматив оборотных средств по прочим производственным запасам)")
        print(f"T_c_B = {row_b['T_c']}  # Дн (Длительность производственного цикла)")
        print(f"N_gp_B = {row_b['N_gp']}  # Дн (Норма запаса готовой продукции)")
        print(f"OS_rbp_B = {row_b['OS_rbp']}  # тыс.руб (Норматив оборотных средств на расходы будущих периодов)")

    except Exception as e:
        print(f"Ошибка: {e}")


# Укажите путь к файлу и номер варианта (1 или 2)
file_name = '../dopolneniya_tables/dop_N.csv'
my_variant = 2

data = load_production_data(file_name, my_variant)

if isinstance(data, dict):
    # Присваиваем переменным значения из словаря (глобально)
    globals().update(data)

current_variant = 2
print_full_variables(file_name, current_variant)


# --- Создание DataFrame из JSON ---
with open('../task1/sebestoimost_structure.json', 'r', encoding='utf-8') as f:
    data1 = json.load(f)
df_seb = pd.DataFrame(data1)

# --- Извлечение данных ---
# 1. Расходы основных материалов на годовой выпуск (тыс.руб.)
C_om_A = df_seb.loc[df_seb['Наименование статей расходов'] == '1. Основные материалы за вычетом возвратных отходов', 'Изделие А на годовой выпуск, тыс.руб.'].iloc[0] # 1296.78
C_om_B = df_seb.loc[df_seb['Наименование статей расходов'] == '1. Основные материалы за вычетом возвратных отходов', 'Изделие Б на годовой выпуск, тыс.руб.'].iloc[0] # 413.15

# 2. Расходы покупных полуфабрикатов и комплектующих на годовой выпуск (тыс.руб.)
C_pok_A = df_seb.loc[df_seb['Наименование статей расходов'] == '2. Покупные полуфабрикаты и комплектующие изделия', 'Изделие А на годовой выпуск, тыс.руб.'].iloc[0] # 17361.73
C_pok_B = df_seb.loc[df_seb['Наименование статей расходов'] == '2. Покупные полуфабрикаты и комплектующие изделия', 'Изделие Б на годовой выпуск, тыс.руб.'].iloc[0] # 10478.94

# 3. Производственная себестоимость одного изделия (руб.)
C_A = df_seb.loc[df_seb['Наименование статей расходов'] == 'ВСЕГО производственная себестоимость', 'Изделие А на единицу, руб'].iloc[0] # 346452.67
C_B = df_seb.loc[df_seb['Наименование статей расходов'] == 'ВСЕГО производственная себестоимость', 'Изделие Б на единицу, руб'].iloc[0] # 191627.72

# 4. Ср - производственная себестоимость годового выпуска продукции относительно этого изделия, тыс. руб.
Cp_A = df_seb.loc[df_seb['Наименование статей расходов'] == 'ВСЕГО производственная себестоимость', 'Изделие А на годовой выпуск, тыс.руб.'].iloc[0]
Cp_B = df_seb.loc[df_seb['Наименование статей расходов'] == 'ВСЕГО производственная себестоимость', 'Изделие Б на годовой выпуск, тыс.руб.'].iloc[0]

# 5. Начальные материальные расходы (сумма расходов по первым двум статьям калькуляции) для ЕДИНИЦЫ ИЗДЕЛИЯ (руб.)
C_m_A = df_seb.loc[df_seb['Наименование статей расходов'] == '1. Основные материалы за вычетом возвратных отходов', 'Изделие А на единицу, руб'].iloc[0] + \
        df_seb.loc[df_seb['Наименование статей расходов'] == '2. Покупные полуфабрикаты и комплектующие изделия', 'Изделие А на единицу, руб'].iloc[0] # 12839.44 + 171898.36 = 184737.8

C_m_B = df_seb.loc[df_seb['Наименование статей расходов'] == '1. Основные материалы за вычетом возвратных отходов', 'Изделие Б на единицу, руб'].iloc[0] + \
        df_seb.loc[df_seb['Наименование статей расходов'] == '2. Покупные полуфабрикаты и комплектующие изделия', 'Изделие Б на единицу, руб'].iloc[0] # 6166.45 + 156402.14 = 162568.59


individual_volumes_json_filename = "../task1/individual_product_volumes.json"
with open(individual_volumes_json_filename, 'r', encoding='utf-8') as f:
    data2 = json.load(f)

df2 = pd.DataFrame(data2)

# Изделие А
Q_A = df2.loc[df2['Изделие'] == 'А', 'Объем_товарной_продукции_по_изделию тыс руб'].iloc[0]

# Изделие Б
Q_B =  df2.loc[df2['Изделие'] == 'Б', 'Объем_товарной_продукции_по_изделию тыс руб'].iloc[0]

# --- Вывод расчётов в консоль ---
print("\n\nИзделие А")
OS_om_A_calc = (C_om_A * N_om_A) / 360
print(f"ОСом = ({C_om_A} * {N_om_A}) / 360 = {OS_om_A_calc:.3f} тыс.руб.")
OS_pok_A_calc = (C_pok_A * N_pok_A) / 360
print(f"ОСпок = ({C_pok_A} * {N_pok_A}) / 360 = {OS_pok_A_calc:.3f} тыс.руб.")
OS_vm_A_calc = (C_vm_A * N_vm_A) / 360
print(f"ОСвм = ({C_vm_A} * {N_vm_A}) / 360 = {OS_vm_A_calc:.3f} тыс.руб.")

print("\nИзделие Б")
OS_om_B_calc = (C_om_B * N_om_B) / 360
print(f"ОСом = ({C_om_B} * {N_om_B}) / 360 = {OS_om_B_calc:.3f} тыс.руб.")
OS_pok_B_calc = (C_pok_B * N_pok_B) / 360
print(f"ОСпок = ({C_pok_B} * {N_pok_B}) / 360 = {OS_pok_B_calc:.3f} тыс.руб.")
OS_vm_B_calc = (C_vm_B * N_vm_B) / 360
print(f"ОСвм = ({C_vm_B} * {N_vm_B}) / 360 = {OS_vm_B_calc:.3f} тыс.руб.")

# --- Основные расчёты ---
# Изделие А
OS_pz_A = OS_om_A_calc + OS_pok_A_calc + OS_vm_A_calc + OS_prz_A
K_nz_A = (C_m_A + 0.5 * (C_A - C_m_A)) / C_A
OS_np_A = (Cp_A * T_c_A * K_nz_A) / 360
OS_gp_A = (Q_A * N_gp_A) / 360

# Изделие Б
OS_pz_B = OS_om_B_calc + OS_pok_B_calc + OS_vm_B_calc + OS_prz_B
K_nz_B = (C_m_B + 0.5 * (C_B - C_m_B)) / C_B
OS_np_B = (Cp_B * T_c_B * K_nz_B) / 360
OS_gp_B = (Q_B * N_gp_B) / 360

# Итоги
OS_pz_total = OS_pz_A + OS_pz_B
OS_np_total = OS_np_A + OS_np_B
OS_rbp_total = OS_rbp_A + OS_rbp_B
OS_gp_total = OS_gp_A + OS_gp_B
OS_total = OS_pz_total + OS_np_total + OS_rbp_total + OS_gp_total

print(f"\nОбщий норматив оборотных средств в производственных запасах:")
print(f"ОСпз = ОСом + ОСпок + ОСвм + ОСпрз. (1.14)")
print(f"Изделие А: ОСпз = {OS_om_A_calc:.3f} + {OS_pok_A_calc:.3f} + {OS_vm_A_calc:.3f} + {OS_prz_A} = {OS_pz_A:.3f} тыс.руб.")
print(f"Изделие Б: ОСпз = {OS_om_B_calc:.3f} + {OS_pok_B_calc:.3f} + {OS_vm_B_calc:.3f} + {OS_prz_B} = {OS_pz_B:.3f} тыс.руб.")

print(f"\nСуммарный норматив оборотных средств производственных запасов для изделий А и Б:")
print(f"ОСосп.А.Б = ОСпзА + ОСпзБ = {OS_pz_A:.3f} + {OS_pz_B:.3f} = {OS_pz_total:.3f} тыс.руб.")


print(f"\nНорматив оборотных средств в незавершенном производстве:")
# Изделие А
print(f"Коэффициент нарастания затрат для изделия А:")
print(f"Кнз = ({C_m_A} + 0.5*({C_A} - {C_m_A})) / {C_A} = {K_nz_A:.3f}")
#OS_np_A = (Q_A / 360) * T_c_A * K_nz_A
print(f"ОСнп = ({Q_A} / 360) * {T_c_A} * {K_nz_A:.3f} = {OS_np_A:.2f} тыс.руб.")
# Изделие Б
print(f"\nКоэффициент нарастания затрат для изделия Б:")
print(f"Кнз = ({C_m_B} + 0.5*({C_B} - {C_m_B})) / {C_B} = {K_nz_B:.3f}")
#OS_np_B = (Q_B / 360) * T_c_B * K_nz_B
print(f"ОСнп = ({Q_B} / 360) * {T_c_B} * {K_nz_B:.3f} = {OS_np_B:.2f} тыс.руб.")

print(f"\nСуммарный норматив оборотных средств по незавершенному производству:")
print(f"ОСнз = ОСнза + ОСнзб = {OS_np_A:.2f} + {OS_np_B:.2f} = {OS_np_total:.2f} тыс.руб.")


print(f"\nСуммарный норматив оборотных средств на расходы будущих периодов:")
print(f"ОСрпб = ОСрпбА + ОСрпбБ = {OS_rbp_A:.2f} + {OS_rbp_B:.2f} = {OS_rbp_total:.2f} тыс.руб.")


print(f"\nНорматив оборотных средств в готовой продукции:")
print(f"Изделие А: ОСгп = ({Q_A} * {N_gp_A}) / 360 = {OS_gp_A:.2f} тыс.руб.")
print(f"Изделие Б: ОСгп = ({Q_B} * {N_gp_B}) / 360 = {OS_gp_B:.2f} тыс.руб.")

print(f"\nСуммарный норматив оборотных средств в запасах готовой продукции для изделий А и Б:")
print(f"ОСгп = ОСгпА + ОСгпБ = {OS_gp_A:.2f} + {OS_gp_B:.2f} = {OS_gp_total:.2f} тыс.руб.")


print(f"\nСуммарный норматив оборотных средств (ОС) определяется по формуле:")
print(f"ОС = ОСпз + ОСнп + ОСгп + ОСрбп. (2.9)")
print(f"ОС = {OS_pz_total:.3f} + {OS_np_total:.2f} + {OS_gp_total:.2f} + {OS_rbp_total} = {OS_total:.2f} тыс.руб.")

# --- Создание таблиц в формате CSV ---

# Таблица 1: Исходные данные для определения норматива оборотных средств
data_input = {
    '№': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13],
    'Показатели': [
        'Годовой объем товарной продукции',
        'Расходы основных материалов на годовой выпуск',
        'Расходы покупных полуфабрикатов и комплектующих на годовой выпуск',
        'Годовые расходы вспомогательных материалов',
        'Норма запаса основных материалов',
        'Норма запаса покупных полуфабрикатов и комплектующих',
        'Норма запаса вспомогательных материалов',
        'Норматив оборотных средств по прочим производственным запасам',
        'Производственная себестоимость одного изделия',
        'Начальные материальные расходы (сумма расходов по первым двум статьям калькуляции)',
        'Длительность производственного цикла',
        'Норма запаса готовой продукции',
        'Норматив оборотных средств на расходы будущих периодов'
    ],
    'Един. измерения': ['тыс.руб.', 'тыс.руб.', 'тыс.руб.', 'тыс.руб.', 'Дн', 'Дн', 'Дн', 'тыс.руб.', 'Руб', 'Руб', 'Дн', 'Дн', 'тыс.руб.'],
    'Условные обозначения': ['Qт', 'Сом', 'Спок', 'Свм', 'Ном', 'Нпок', 'Нвм', 'ОСпрз', 'С', 'См', 'Тц', 'Нгп', 'ОСрбп'],
    'А': [Q_A, C_om_A, C_pok_A, C_vm_A, N_om_A, N_pok_A, N_vm_A, OS_prz_A, C_A, C_m_A, T_c_A, N_gp_A, OS_rbp_A],
    'Б': [Q_B, C_om_B, C_pok_B, C_vm_B, N_om_B, N_pok_B, N_vm_B, OS_prz_B, C_B, C_m_B, T_c_B, N_gp_B, OS_rbp_B]
}

df_input = pd.DataFrame(data_input)
df_input.to_csv('Таблица_1_Исходные_данные_норматив_оборотных_средств.csv',
                index=False,
                encoding='utf-8-sig',
                sep=';'
        )

# Таблица 2: Сводный расчет норматива оборотных средств
for_a = [OS_pz_A, OS_np_A, OS_rbp_A, OS_gp_A]
for_b = [OS_pz_B, OS_np_B, OS_rbp_B, OS_gp_B]
data_summary = {
    '№': [1, 2, 3, 4, 5],
    'Наименование элементов оборотных средств': [
        'Производственные запасы',
        'Незавершенное производство',
        'Расходы будущих периодов',
        'Готовая продукция',
        'Всего'
    ],
    'Условные обозначения': ['ОСпз', 'ОСнп', 'ОСрбп', 'ОСгп', ''],
    'Изделие А, тыс. руб': for_a + [sum(for_a)],
    'Изделие Б, тыс. руб': for_b + [sum(for_b)],
    'Сумма, тыс. руб': [OS_pz_total, OS_np_total, OS_rbp_total, OS_gp_total, OS_total],
    'В % всего': [
        (OS_pz_total / OS_total) * 100,
        (OS_np_total / OS_total) * 100,
        (OS_rbp_total / OS_total) * 100,
        (OS_gp_total / OS_total) * 100,
        100
    ]
}
df_summary = pd.DataFrame(data_summary).round(2)
df_summary.to_csv('Таблица_2_Сводный_расчет_норматива_оборотных_средств.csv', index=False, encoding='utf-8-sig', sep=';')



====================
FILE: .\task4\task4.py
====================
# что откуда берется
# та и тб из таблицы исх данных 1.1
# qa qb из джсон, уже есть
# qp qt нужно добавить в джсон
# фч и квн даны
# стп - себестоимость годового выпуска продукции, из табл калькуляции
# Среднегодовая стоимость основных производственных фондов - из 1.2 Фссов
# Суммарный норматив оборотных средств - из 1.3 ОС

import pandas as pd
import json
from math import ceil

df = pd.read_json('../task1/sebestoimost_structure.json')
C_god = df.loc[df['Наименование статей расходов'] == "ВСЕГО полная (коммерческая) себестоимость",
                "Себестоимость годового выпуска продукции, тыс.руб."].iloc[0]

df2 = pd.read_json('../task1/input_data_table.json')
ta = float(df2.loc[df2['Показатель'] == "Суммарная трудоемкость изделия",
                "Изделие А"].iloc[0])
tb = float(df2.loc[df2['Показатель'] == "Суммарная трудоемкость изделия",
                "Изделие Б"].iloc[0])


df3 = pd.read_csv('../task3/Таблица_2_Сводный_расчет_норматива_оборотных_средств.csv', delimiter=';')
oc = df3.loc[4, 'Сумма, тыс. руб']


with open('../task2/фссоф.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
fssof = round(data['Среднегодовая стоимость основных фондов'], 3)

with open('../task1/individual_product_volumes.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
qt = round(data[-1]['Qt'], 3)
qr = round(data[-1]['Qr'], 3)

df4 = pd.read_json('../task1/individual_product_volumes.json')
qa = int(df4.loc[df4['Изделие'] == "А",
                "Годовой_объем_выпуска"].iloc[0])
qb = int(df4.loc[df4['Изделие'] == "Б",
                "Годовой_объем_выпуска"].iloc[0])

qa_calc = df4.loc[df4['Изделие'] == "А",
                "Объем_товарной_продукции_по_изделию тыс руб"].iloc[0]
qb_calc = df4.loc[df4['Изделие'] == "Б",
                "Объем_товарной_продукции_по_изделию тыс руб"].iloc[0]


fch = 1860
kvn = 1.1

Pr = qr - C_god #прибыль
R_osn = (ta * qa + tb * qb) / (fch * kvn)
R_vsp = ceil(R_osn) * 0.25
R_sl = (ceil(R_osn) + ceil(R_vsp)) * 0.04
R_ppp = ceil(R_osn) + ceil(R_vsp) + ceil(R_sl)


print(f"Росн  = ({ta} * {qa} + {tb} * {qb}) / ({fch} * {kvn}) = {R_osn:.3f} = {ceil(R_osn)} чел.")
print(f"Рвсп  = {ceil(R_osn)} * 0.25 = {R_vsp} = {ceil(R_vsp)} чел.")
print(f"Рсл  = ({ceil(R_vsp)} + {ceil(R_osn)}) * 0.04 = {R_sl} = {ceil(R_sl)} чел.")
print(f"Численность промышленно-производственного персонала ( Рппп ) определяется суммированием численности всех категорий персонала:")
print(f"Рппп  = {ceil(R_osn)} + {ceil(R_vsp)} + {ceil(R_sl)} = {R_ppp} чел.")
print(f"Пр  =  Q р –  Стп  = {qr} - {C_god} = {Pr}  тыс.руб .")

# 6. Формирование итоговой таблицы
results_data = {
    '№': [str(i) for i in range(1, 8)] + ['7.1', '7.1.1'],
    "Показатель": [
        "Объем товарной продукции",
        "Объем реализованной продукции",
        "Себестоимость товарной продукции",
        "Прибыль от реализации",
        "Среднегодовая стоимость основных производственных фондов",
        "Норматив оборотных средств",
        "Численность промышленно-производственного персонала",
        "в том числе рабочих (основные + вспомогательные)",
        "из них основных рабочих"
    ],
    "Ед.изм.": [
        "тыс.руб.",
        "тыс.руб.",
        "тыс.руб.",
        "тыс.руб.",
        "тыс.руб.",
        "тыс.руб",
        "чел.",
        "чел.",
        "чел."
    ],
    "Значение": [
        qt,
        qr,
        C_god,
        Pr,
        fssof,
        oc,
        R_ppp,
        ceil(R_osn) + ceil(R_vsp),
        ceil(R_osn)
    ]
}

df_results = pd.DataFrame(results_data)

# Сохранение таблицы в CSV
output_filename = 'Таблица_2_7_Показатели_деятельности_предприятия.csv'
df_results.to_csv(output_filename, index=False, sep=';', decimal='.', encoding='utf-8-sig')
print(f"\nИтоговая таблица сохранена в файл: {output_filename}")


====================
FILE: .\task5\funcs.py
====================
import csv
import math


class EnterpriseEconomicsCalculator:
    def __init__(self):
        self.results = {}

    def set_input_data(self):
        """Установка исходных данных из примера"""
        self.data = {
            # Данные для таблицы 9
            'Q_t': 61284.34,  # Объем товарной продукции, тыс. руб
            'F_sr': 43283.83,  # Среднегодовая стоимость ОФ, тыс. руб
            'P': 11357.66,  # Прибыль, тыс. руб

            # Данные для таблицы 10
            'Q_r': 61590.72,  # Объем реализованной продукции, тыс. руб
            'OS_n': 5763.25,  # Норматив оборотных средств, тыс. руб
            'MZ': 1296.78 + 413.32 + 17361.73 + 10478.94,  # Материальные затраты, тыс. руб

            # Данные для таблицы 11
            'PP_count': 66,  # Численность ППП, чел
            'workers_count': 63,  # Численность рабочих, чел
            'main_workers_count': 50,  # Численность основных рабочих, чел

            # Данные для таблицы 12
            'C_tp': 50233.06,  # Себестоимость товарной продукции, тыс. руб
        }

    def calculate_all(self):
        """Выполняет все расчёты"""
        self._calculate_fixed_assets()  # Таблица 9
        self._calculate_working_capital()  # Таблица 10
        self._calculate_labor_productivity()  # Таблица 11
        self._calculate_summary_indicators()  # Таблица 12

    def _calculate_fixed_assets(self):
        """Расчёт показателей использования основных фондов (Таблица 9)"""
        Q_t = self.data['Q_t']
        F_sr = self.data['F_sr']
        P = self.data['P']

        # Фондоотдача
        F_o = round(Q_t / F_sr, 3)
        # Фондоемкость
        F_e = round(1 / F_o, 3)
        # Прибыль на 1 рубль ОФ
        P_per_F = round(P / F_sr, 3)

        self.results['table9'] = {
            'headers': ['№', 'Показатели', 'Ед. измер.', 'Значение'],
            'data': [
                [1, 'Объем товарной продукции', 'тыс. руб', Q_t],
                [2, 'Среднегодовая стоимость основных производственных фондов', 'тыс. руб', F_sr],
                [3, 'прибыль', 'тыс. руб', P],
                [4, 'фондоотдача', 'руб/руб', F_o],
                [5, 'фондоемкость', 'руб/руб', F_e],
                [6, 'Прибыль на 1 руб. стоимости основных фондов', 'руб/руб', P_per_F]
            ]
        }

        # Вывод в консоль
        print("=== РАСЧЕТ ТАБЛИЦЫ 9 ===")
        print(f"Фондоотдача (Фо) = Qт / Фср = {Q_t} / {F_sr} = {F_o} руб/руб")
        print(f"Фондоемкость (ФЕ) = 1 / Фо = 1 / {F_o} = {F_e} руб/руб")
        print(f"Прибыль на 1 руб ОФ = Пр / Фср = {P} / {F_sr} = {P_per_F} руб/руб")
        print()

    def _calculate_working_capital(self):
        Q_r = self.data['Q_r']
        OS_n = self.data['OS_n']
        MZ = self.data['MZ']
        Q_t = self.data['Q_t']

        # Коэффициент оборачиваемости
        K_ob = round(Q_r / OS_n, 3)
        # Коэффициент закрепления
        K_z = round(1 / K_ob, 3)
        # Длительность одного оборота
        T_ob = round(360 / K_ob, 3)
        # Материалоемкость
        M_e = round(sum(MZ) / Q_t, 3)

        self.results['table10'] = {
            'headers': ['№', 'Показатели', 'Ед. измер.', 'Значение'],
            'data': [
                [1, 'Объем реализованной продукции', 'тыс. руб', Q_r],
                [2, 'Норматив оборотных средств', 'тыс. руб', OS_n],
                [3, 'Коэффициент оборачиваемости', 'руб/руб', K_ob],
                [4, 'Время оборота', 'Дн.', math.ceil(T_ob)],
                [5, 'Коэффициент закрепления (загрузки)', 'руб/руб', K_z],
                [6, 'Материалоемкость', 'руб/руб', M_e]
            ]
        }

        # Вывод в консоль с разложением МЗ
        print("=== РАСЧЕТ ТАБЛИЦЫ 10 ===")
        print(f"Коэффициент оборачиваемости (Коб) = Qр / ОСн = {Q_r} / {OS_n} = {K_ob} об")
        print(f"Коэффициент закрепления (Кз) = 1 / Коб = 1 / {K_ob} = {K_z} руб/руб")
        print(f"Длительность оборота (Тоб) = 360 / Коб = 360 / {K_ob} = {T_ob} = {math.ceil(T_ob)} дн")

        mz_formula = " + ".join(str(float(comp)) for comp in MZ)
        print(f"Материалоемкость (МЕ) = МЗ / Qт = {mz_formula} / {Q_t} = {M_e} руб/руб")
        print()

    def _calculate_labor_productivity(self):
        """Расчёт показателей производительности труда (Таблица 11)"""
        Q_t = self.data['Q_t']
        PP_count = self.data['PP_count']
        workers_count = self.data['workers_count']
        main_workers_count = self.data['main_workers_count']

        # Выработка на одного ППП
        V_ppp = round(Q_t / PP_count, 3)
        # Выработка на одного рабочего
        V_worker = round(Q_t / workers_count, 3)
        # Выработка на одного основного рабочего
        V_main_worker = round(Q_t / main_workers_count, 3)

        self.results['table11'] = {
            'headers': ['№', 'Показатели', 'Ед. измер.', 'Значение'],
            'data': [
                [1, 'Товарная продукция', 'тыс.руб', Q_t],
                [2, 'Численность промышленно-производственного персонала', 'Чел.', PP_count],
                [3, 'Численность рабочих', 'Чел.', workers_count],
                [4, 'Численность основных рабочих', 'Чел.', main_workers_count],
                [5, 'Выработка продукции:', '', ''],
                [5.1, 'нa одного работающего', 'тыс. руб/чел.', V_ppp],
                [5.2, 'нa одного рабочего', 'тыс. руб/чел.', V_worker],
                [5.3, 'на одного основного рабочего', 'тыс. руб/чел.', V_main_worker]
            ]
        }

        # Вывод в консоль
        print("=== РАСЧЕТ ТАБЛИЦЫ 11 ===")
        print(f"Выработка на 1 ППП = Qт / Рппп = {Q_t} / {PP_count} = {V_ppp} тыс.руб/чел (1.29) ")
        print(f"Выработка на 1 рабочего = Qт / Рраб = {Q_t} / {workers_count} = {V_worker} тыс.руб/чел (1.30)")
        print(
            f"Выработка на 1 основного рабочего = Qт / Росн = {Q_t} / {main_workers_count} = {V_main_worker} тыс.руб/чел (1.31)")
        print()

    def _calculate_summary_indicators(self):
        """Расчёт обобщающих показателей эффективности (Таблица 12)"""
        C_tp = self.data['C_tp']
        Q_t = self.data['Q_t']
        P = self.data['P']
        F_sr = self.data['F_sr']
        OS_n = self.data['OS_n']
        Q_r = self.data['Q_r']

        # Затраты на 1 рубль товарной продукции
        Z_1rub = round(C_tp / Q_t, 3)
        # Уровень общей рентабельности
        R_total = round((P / (F_sr + OS_n)) * 100, 3)
        # Рентабельность продаж
        R_sales = round((P / Q_r) * 100, 3)
        # Рентабельность себестоимости
        R_cost = round((P / C_tp) * 100, 3)

        self.results['table12'] = {
            'headers': ['№', 'Показатели', 'Ед. измер.', 'Значение'],
            'data': [
                [1, 'Расходы на 1 руб товарной продукции', 'руб/руб', Z_1rub],
                [2, 'Уровень общей рентабельности', '%', R_total],
                [3, 'Уровень рентабельности', '', ''],
                ['', '- реализованной продукции (рентабельность продаж)', '%', R_sales],
                ['', '- себестоимости продукции (рентабельность затрат)', '%', R_cost]
            ]
        }

        # Вывод в консоль
        print("=== РАСЧЕТ ТАБЛИЦЫ 12 ===")
        print(f"Затраты на 1 руб ТП = Стп / Qт = {C_tp} / {Q_t} = {Z_1rub} руб (1.32)")
        print(
            f"Уровень общей рентабельности = (Пр / (Фср.г. + ОС)) * 100% = ({P} / ({F_sr} + {OS_n})) * 100% = {R_total}% (1.33)")
        print(f"Рентабельность продаж = (Пр / Qр) * 100% = ({P} / {Q_r}) * 100% = {R_sales}% (1.34)")
        print(f"Рентабельность себестоимости = (Пр / Стп) * 100% = ({P} / {C_tp}) * 100% = {R_cost}% (1.35)")
        print()

    def save_to_csv(self):
        """Сохранение всех таблиц в CSV файлы"""
        for table_name, table_data in self.results.items():
            filename = f"{table_name}.csv"
            with open(filename, 'w', newline='', encoding='utf-8') as csvfile:
                writer = csv.writer(csvfile, delimiter=';')
                # Записываем заголовки
                writer.writerow(table_data['headers'])
                # Записываем данные
                for row in table_data['data']:
                    writer.writerow(row)
            print(f"Таблица сохранена в файл: {filename}")

# Использование класса
def main():
    calculator = EnterpriseEconomicsCalculator()

    # Установка исходных данных
    calculator.set_input_data()

    # Выполнение всех расчётов
    calculator.calculate_all()

    # Сохранение результатов в CSV
    calculator.save_to_csv()


if __name__ == "__main__":
    main()

====================
FILE: .\task5\task5.py
====================
import pandas as pd
from funcs import EnterpriseEconomicsCalculator
import json


df1 = pd.read_csv('../task2/Исходные_данные_основные_фонды.csv', delimiter=';')
machines_begin_oty = float(df1.iloc[0, -1])

df2 = pd.read_csv('../task2/Основные_производственные_фонды_предприятия.csv', delimiter=';')
cost_of_begin_oty = df2.iloc[:-1, -1] #Стоимость на конец года, тыс.руб каждое
#all_of_cost_end = df2.loc[10, 'Стоимость на конец года, тыс.руб'] # Стоимость на конец года, тыс.руб ИТОГО
all_of_cost_end = list(df2.iloc[:, -1] )[-1]

df3 = pd.read_csv('../task3/Таблица_2_Сводный_расчет_норматива_оборотных_средств.csv', delimiter=';')
os = df3.loc[4, 'Сумма, тыс. руб']

with open('../task2/фссоф.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
fsr = round(data['Среднегодовая стоимость основных фондов'], 3)

with open('../task1/individual_product_volumes.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
qt = round(data[-1]['Qt'], 3)
qr = round(data[-1]['Qr'], 3)

df4 = pd.read_csv('../task4/Таблица_2_7_Показатели_деятельности_предприятия.csv', delimiter=';')
p = df4.loc[3, 'Значение']
ppp = df4.loc[6, 'Значение']
worker_main_and_add = df4.loc[7, 'Значение']
worker_main_only = df4.loc[8, 'Значение']

df5 = pd.read_csv('../task1/sebestoimost_structure.csv', delimiter=';')
som_a = df5.loc[0, 'Изделие А на годовой выпуск, тыс.руб.']
som_b = df5.loc[0, 'Изделие Б на годовой выпуск, тыс.руб.']
spf_and_skom_a = df5.loc[1, 'Изделие А на годовой выпуск, тыс.руб.']
spf_and_skom_b = df5.loc[1, 'Изделие Б на годовой выпуск, тыс.руб.']
s_tp = df5.iloc[-3, -2]



Frm = round((machines_begin_oty / all_of_cost_end) * 100, 3)
print(f'Frm = ({machines_begin_oty} / {all_of_cost_end}) * 100% = {Frm}')

items = [
    "1. Здания:",
    "2. Сооружения:",
    "3. Передаточные устройства:",
    "4. Машины и оборудование:",
    "4.1. Силовые машины и оборудование:",
    "4.2. Рабочие машины и оборудование:",
    "4.3. Измерительные приборы и устройства:",
    "4.4. Вычислительная техника:",
    "4.5. Другие машины и оборудование:",
    "5. Транспортные средства:",
    "6. Другие основные фонды:"
]
numbers = [
    "1.",
    "2.",
    "3.",
    "4.",
    "4.1.",
    "4.2.",
    "4.3.",
    "4.4.",
    "4.5.",
    "5.",
    "6.",
    '7',
    '7.1',
    '7.2'
]

keys = [
    "Здания",
    "Сооружения",
    "Передаточные устройства",
    "Машины и оборудование",
    "Силовые машины и оборудование",
    "Рабочие машины и оборудование",
    "Измерительные приборы и устройства",
    "Вычислительная техника",
    "Другие машины и оборудование",
    "Транспортные средства",
    "Другие основные фонды",
    'Всего',
    "Доля активной части",
    "Доля пассивной части"
]



doli_konets_goda = []
for n, i in enumerate(cost_of_begin_oty):
    temp = round((i / machines_begin_oty) * Frm, 3)
    doli_konets_goda.append(temp)
    print(f'{items[n]} ({i} / {machines_begin_oty}) * {Frm}% = {temp}%')


doli_konets_goda.append(100)
active_part_k = doli_konets_goda[3] + doli_konets_goda[-3]
passive_part_k = 100 - active_part_k
doli_konets_goda += [active_part_k, passive_part_k]


doli_nachalo_goda = [
    35.6,
    6.2,
    3.5,
    50.6,
    2.3,
    41.5,  # Базовая группа
    3.2,
    3.0,
    0.6,
    2.1,
    2,
    100
]
active_part_n = doli_nachalo_goda[3] + doli_nachalo_goda[-3]
passive_part_n = 100 - active_part_n
doli_nachalo_goda += [active_part_n, passive_part_n]

total_df = pd.DataFrame({
    '№': numbers,
    'Группы основных производственных фондов': keys,
    'На начало года': doli_nachalo_goda,
    'На конец года': doli_konets_goda
})
total_df.to_csv(
    'Структура_основных_производственных_фондов_%.csv',
                sep=';',
                encoding='utf-8-sig',
                index=False,
                decimal='.'
        )


calc = EnterpriseEconomicsCalculator()
calc.data = {
            # Данные для таблицы 9
            'Q_t': qt,  # Объем товарной продукции, тыс. руб
            'F_sr':fsr ,  # Среднегодовая стоимость ОФ, тыс. руб
            'P': p,  # Прибыль, тыс. руб

            # Данные для таблицы 10
            'Q_r': qr,  # Объем реализованной продукции, тыс. руб
            'OS_n': os,  # Норматив оборотных средств, тыс. руб
            'MZ': [som_a, som_b,  spf_and_skom_b, spf_and_skom_a],  # Материальные затраты, тыс. руб

            # Данные для таблицы 11
            'PP_count': ppp,  # Численность ППП, чел
            'workers_count': worker_main_and_add,  # Численность рабочих, чел
            'main_workers_count': worker_main_only,  # Численность основных рабочих, чел

            # Данные для таблицы 12
            'C_tp': s_tp,  # Себестоимость товарной продукции, тыс. руб
}
calc.calculate_all()
calc.save_to_csv()

